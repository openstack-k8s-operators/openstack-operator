<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="generator" content="Asciidoctor 2.0.26"/>
<title>OpenStack Data Plane Operator</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"/>
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock pre>code{display:block}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/monokai.min.css"/>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>OpenStack Data Plane Operator</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_data_plane_design">Data Plane Design</a>
<ul class="sectlevel2">
<li><a href="#_crd_design_and_resources">CRD Design and Resources</a></li>
</ul>
</li>
<li><a href="#assembly_creating-the-data-plane">Creating the data plane</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites">Prerequisites</a></li>
<li><a href="#proc_creating-the-SSH-key-secrets_dataplane">Creating the SSH key secrets</a></li>
<li><a href="#proc_creating-a-set-of-data-plane-nodes_dataplane">Creating a set of data plane nodes</a></li>
<li><a href="#_composable_services">Composable services</a>
<ul class="sectlevel3">
<li><a href="#_openstack_operator_provided_services">openstack-operator provided services</a></li>
<li><a href="#_overriding_services_for_the_deployment">Overriding services for the deployment</a></li>
<li><a href="#proc_creating-a-custom-service_dataplane">Creating a custom service</a></li>
<li><a href="#proc_configuring-a-node-set-for-a-Compute-feature-or-workload_dataplane">Configuring a node set for a Compute feature or workload</a></li>
<li><a href="#proc_building-a-custom-ansible-runner-image_dataplane">Building a custom <code>ansible-runner</code> image</a></li>
</ul>
</li>
<li><a href="#ref_example-OpenStackDataPlaneNodeSet-CR-for-preprovisioned-nodes_dataplane">Example <code>OpenStackDataPlaneNodeSet</code> CR for pre-provisioned nodes</a></li>
<li><a href="#ref_example-OpenStackDataPlaneNodeSet-CR-for-bare-metal-nodes_dataplane">Example <code>OpenStackDataPlaneNodeSet</code> CR for bare metal nodes</a></li>
<li><a href="#ref_data-plane-conditions-and-states_dataplane">Data plane conditions and states</a></li>
<li><a href="#con_provisioning-bare-metal-data-plane-nodes_dataplane">Provisioning bare metal data plane nodes</a>
<ul class="sectlevel3">
<li><a href="#_installer_provisioned_infrastructure">Installer-Provisioned Infrastructure</a></li>
<li><a href="#_assisted_installer_provisioned_infrastructure">Assisted Installer Provisioned Infrastructure</a></li>
<li><a href="#_user_provisioned_infrastructure">User Provisioned Infrastructure</a></li>
<li><a href="#_provisioning_nodes_with_openstackdataplanenodeset">Provisioning Nodes with OpenStackDataPlaneNodeSet</a></li>
<li><a href="#_configuring_network_interface_bonding_for_control_plane">Configuring Network Interface Bonding for Control Plane</a></li>
<li><a href="#_using_custom_os_images_with_provision_server">Using custom OS Images with Provision Server</a></li>
</ul>
</li>
<li><a href="#proc_deploying-the-data-plane_dataplane">Deploying the data plane</a></li>
<li><a href="#_persistent_logs">Persistent logs</a>
<ul class="sectlevel3">
<li><a href="#_accessing_the_logs">Accessing the logs</a></li>
</ul>
</li>
<li><a href="#proc_troubleshooting-data-plane-creation-and-deployment_dataplane">Troubleshooting data plane creation and deployment</a></li>
<li><a href="#_deploying_an_openstackdataplanenodeset_with_internal_tls_enabled">Deploying an OpenStackDataPlaneNodeSet with Internal TLS Enabled</a>
<ul class="sectlevel3">
<li><a href="#_prerequisites_2">Prerequisites</a></li>
<li><a href="#_basic_deloyment_steps">Basic deloyment steps</a></li>
<li><a href="#_enabling_tls_on_an_openstackdataplanenodeset">Enabling TLS on an OpenStackDataPlaneNodeSet</a></li>
<li><a href="#_openstackdataplaneservice_attributes">OpenStackDataplaneService attributes</a></li>
<li><a href="#_the_gritty_details">The gritty details</a></li>
</ul>
</li>
<li><a href="#_scaling_the_dataplane">Scaling the DataPlane</a>
<ul class="sectlevel3">
<li><a href="#_scaling_out">Scaling Out</a></li>
<li><a href="#_scaling_out_with_different_configuration">Scaling Out with different configuration</a></li>
<li><a href="#_scaling_in">Scaling In</a></li>
<li><a href="#_scaling_in_by_removing_a_nodeset">Scaling In by removing a NodeSet</a></li>
</ul>
</li>
<li><a href="#_ansibleee_runner_variables">AnsibleEE runner variables</a></li>
<li><a href="#_ansible_variables">Ansible variables</a>
<ul class="sectlevel3">
<li><a href="#_importing_ansible_variables">Importing ansible variables</a></li>
</ul>
</li>
<li><a href="#_common_configurations">Common Configurations</a>
<ul class="sectlevel3">
<li><a href="#_initial_bootstrap_command">Initial bootstrap command</a></li>
<li><a href="#_network_isolation">Network Isolation</a></li>
</ul>
</li>
<li><a href="#_interacting_with_ansible">Interacting with Ansible</a>
<ul class="sectlevel3">
<li><a href="#_retrieving_and_inspecting_ansible_execution_jobs">Retrieving and inspecting Ansible Execution Jobs</a></li>
<li><a href="#_controlling_the_ansible_execution">Controlling the Ansible execution</a></li>
</ul>
</li>
<li><a href="#_hashes">Hashes</a>
<ul class="sectlevel3">
<li><a href="#_nodeset_config_changes">NodeSet Config Changes</a></li>
<li><a href="#_openstackdataplanenodeset_deployment_hashes">OpenStackDataPlaneNodeSet deployment hashes</a></li>
</ul>
</li>
<li><a href="#_using_ipam_and_internal_dns_service">Using IPAM and Internal DNS Service</a>
<ul class="sectlevel3">
<li><a href="#_relevant_status_conditions">Relevant Status Conditions</a></li>
</ul>
</li>
<li><a href="#assembly_hotfixing-the-data-plane">Hotfixing the data plane</a>
<ul class="sectlevel3">
<li><a href="#proc_hotfixing-the-data-plane-rpm-content-dataplane">Hotfixing the data plane RPM content</a></li>
<li><a href="#proc_hotfixing-the-data-plane-container-content-rpms-dataplane">Hotfixing the data plane container content with RPM&#8217;s</a></li>
<li><a href="#proc_hotfixing-the-data-plane-container-content-images-dataplane">Hotfixing the data plane container content with images</a></li>
</ul>
</li>
<li><a href="#assembly_updating-the-data-plane">Updating the data plane</a>
<ul class="sectlevel3">
<li><a href="#proc_updating-the-data-plane-ovn-dataplane">Updating OVN on the data plane</a></li>
<li><a href="#proc_updating-the-data-plane-dataplane">Updating other services on the data plane</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_dataplane_performance_tuning_for_large_scale_deployments">DataPlane Performance Tuning for large scale deployments</a>
<ul class="sectlevel2">
<li><a href="#_overview">Overview</a>
<ul class="sectlevel3">
<li><a href="#_key_performance_factors">Key Performance Factors</a></li>
</ul>
</li>
<li><a href="#_nodeset_grouping_strategies">NodeSet Grouping Strategies</a>
<ul class="sectlevel3">
<li><a href="#_strategy_1_single_large_nodeset">Strategy 1: Single Large NodeSet</a></li>
<li><a href="#_strategy_2_multiple_smaller_nodesets">Strategy 2: Multiple Smaller NodeSets</a></li>
<li><a href="#_strategy_3_role_based_nodesets">Strategy 3: Role-Based NodeSets</a></li>
</ul>
</li>
<li><a href="#_parallel_execution_patterns">Parallel Execution Patterns</a>
<ul class="sectlevel3">
<li><a href="#_nodeset_level_parallelism">NodeSet-Level Parallelism</a></li>
<li><a href="#_service_level_execution">Service-Level Execution</a></li>
<li><a href="#_node_level_parallelism_within_ansible">Node-Level Parallelism Within Ansible</a></li>
</ul>
</li>
<li><a href="#_ansible_performance_tuning">Ansible Performance Tuning</a>
<ul class="sectlevel3">
<li><a href="#_environment_variables">Environment Variables</a></li>
<li><a href="#_common_ansible_tuning_techniques">Common Ansible Tuning Techniques</a></li>
</ul>
</li>
<li><a href="#_using_ansiblelimit_for_targeted_deployments">Using ansibleLimit for Targeted Deployments</a>
<ul class="sectlevel3">
<li><a href="#_basic_usage">Basic Usage</a></li>
<li><a href="#_pattern_matching">Pattern Matching</a></li>
<li><a href="#_wildcard_patterns">Wildcard Patterns</a></li>
<li><a href="#_use_cases_for_ansible_limit">Use Cases for ansible limit</a></li>
</ul>
</li>
<li><a href="#_scaling_strategy_comparison">Scaling Strategy Comparison</a>
<ul class="sectlevel3">
<li><a href="#_scenario_100_compute_nodes_deployment">Scenario: 100 Compute Nodes Deployment</a></li>
<li><a href="#_comparison_table">Comparison Table</a></li>
<li><a href="#_recommendations">Recommendations</a></li>
</ul>
</li>
<li><a href="#_best_practices">Best Practices</a>
<ul class="sectlevel3">
<li><a href="#_start_conservative_then_optimize">Start Conservative, Then Optimize</a></li>
<li><a href="#_use_ansible_limit_for_validation">Use ansible limit for Validation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_scaling_the_dataplane_2">Scaling the DataPlane</a>
<ul class="sectlevel2">
<li><a href="#_scaling_out_2">Scaling Out</a></li>
<li><a href="#_scaling_out_with_different_configuration_2">Scaling Out with different configuration</a></li>
<li><a href="#_scaling_in_2">Scaling In</a>
<ul class="sectlevel3">
<li><a href="#_disable_nova_compute_service_2">Disable nova-compute service</a></li>
<li><a href="#_stop_ovn_and_nova_compute_containers_2">Stop ovn and nova-compute containers</a></li>
<li><a href="#_delete_network_agents_2">Delete network agents</a></li>
<li><a href="#_delete_nova_compute_service_2">Delete nova-compute service</a></li>
<li><a href="#_patch_openstackdataplanenodeset_to_remove_node_2">Patch OpenStackDataPlaneNodeSet to remove node</a></li>
</ul>
</li>
<li><a href="#_scaling_in_by_removing_a_nodeset_2">Scaling In by removing a NodeSet</a></li>
</ul>
</li>
<li><a href="#proc_deploying-in-disconnected-environments">Deploying OpenStack in a disconnected environment</a>
<ul class="sectlevel2">
<li><a href="#_process">Process</a></li>
<li><a href="#_technical_implementation">Technical Implementation</a></li>
</ul>
</li>
<li><a href="#custom-resources">Custom Resources</a>
<ul class="sectlevel1">
<li><a href="#sub-resources">Sub Resources</a>
<ul class="sectlevel2">
<li><a href="#openstackdataplanedeployment">OpenStackDataPlaneDeployment</a></li>
<li><a href="#openstackdataplanedeploymentlist">OpenStackDataPlaneDeploymentList</a></li>
<li><a href="#openstackdataplanedeploymentspec">OpenStackDataPlaneDeploymentSpec</a></li>
<li><a href="#openstackdataplanedeploymentstatus">OpenStackDataPlaneDeploymentStatus</a></li>
<li><a href="#openstackdataplanenodeset">OpenStackDataPlaneNodeSet</a></li>
<li><a href="#openstackdataplanenodesetlist">OpenStackDataPlaneNodeSetList</a></li>
<li><a href="#openstackdataplanenodesetspec">OpenStackDataPlaneNodeSetSpec</a></li>
<li><a href="#openstackdataplanenodesetstatus">OpenStackDataPlaneNodeSetStatus</a></li>
<li><a href="#openstackdataplaneservice">OpenStackDataPlaneService</a></li>
<li><a href="#openstackdataplaneservicelist">OpenStackDataPlaneServiceList</a></li>
<li><a href="#openstackdataplaneservicespec">OpenStackDataPlaneServiceSpec</a></li>
<li><a href="#openstackdataplaneservicestatus">OpenStackDataPlaneServiceStatus</a></li>
<li><a href="#openstackdataplaneservicecert">OpenstackDataPlaneServiceCert</a></li>
<li><a href="#ansibleeespec">AnsibleEESpec</a></li>
<li><a href="#ansibleopts">AnsibleOpts</a></li>
<li><a href="#configmapenvsource">ConfigMapEnvSource</a></li>
<li><a href="#datasource">DataSource</a></li>
<li><a href="#localobjectreference">LocalObjectReference</a></li>
<li><a href="#nodesection">NodeSection</a></li>
<li><a href="#nodetemplate">NodeTemplate</a></li>
<li><a href="#secretenvsource">SecretEnvSource</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The openstack-operator automates the deployment of an OpenStack dataplane. A
dataplane is a collection of nodes that will be used for hosting OpenStack
workloads. The openstack-operator prepares the nodes with enough operating
system configuration so that they are ready for hosting other required
OpenStack services and workloads.</p>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/openstack-k8s-operators/dev-docs">contributing</a> for notes for developers and
contributors, running the operator, building the documentation, etc.</p>
</div>
<div class="paragraph">
<p>See <a href="#_data_plane_design">design</a> for details about the dataplane design.</p>
</div>
<div class="paragraph">
<p><a href="#assembly_creating-the-data-plane">Creating a DataPlane</a> documents how to create a dataplane.</p>
</div>
<div class="paragraph">
<p>The documentation source is kept within the openstack-operator repo in the
<a href="https://github.com/openstack-k8s-operators/openstack-operator/tree/main/docs">docs</a> directory. The full
generated documentation from that source is available at
<a href="https://openstack-k8s-operators.github.io/openstack-operator/" class="bare">https://openstack-k8s-operators.github.io/openstack-operator/</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_plane_design">Data Plane Design</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The openstack-operator provisions and configures nodes that make up the
OpenStack data plane. The data plane consists of nodes that host end-user
workloads and applications. Depending on the OpenStack deployment, these data
plane nodes are often compute nodes, but may also be storage nodes, networker
nodes, or other types of nodes.</p>
</div>
<div class="paragraph">
<p>The openstack-operator provides a Kubernetes like abstraction and API for
deploying the data plane. It uses the
<a href="https://github.com/openstack-k8s-operators/openstack-baremetal-operator">openstack-baremetal-operator</a>
to optionally provision baremetal. It then creates Kubernetes jobs
that execute Ansible to deploy, configure, and orchestrate software on the nodes.
The software is typically RPM or container based using the <code>podman</code> container
runtime.</p>
</div>
<div class="paragraph">
<p>External Data Plane Management (EDPM) is the concept of using Ansible in this
manner to configure software on data plane nodes. Ansible is used instead of
using native Kubernetes Workload API&#8217;s (Deployment, Job, Pod, etc) and kubelet.
While the Ansible executions themselves run on the Kubernetes cluster as native
Kubernetes workloads, they communicate using SSH with data plane nodes and use
various Ansible modules to deploy software on data plane nodes.</p>
</div>
<div class="sect2">
<h3 id="_crd_design_and_resources">CRD Design and Resources</h3>
<div class="paragraph">
<p>The openstack-operator exposes the concepts of <code>OpenStackDataPlaneNodeSets</code>,
<code>OpenStackDataPlaneServices</code>, and <code>OpenStackDataPlaneDeployments</code> as CRD&#8217;s:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#openstackdataplanenodeset">OpenStackDataPlaneNodeSet</a></p>
</li>
<li>
<p><a href="#openstackdataplaneservice">OpenStackDataPlaneService</a></p>
</li>
<li>
<p><a href="#openstackdataplanedeployment">OpenStackDataPlaneDeployment</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>OpenStackDataPlaneNodeSet</code> CRD is used to describe a logical grouping of
nodes of a similar type. A node can only be defined in one NodeSet. This is
analogous to the concept of "roles" in TripleO. An OpenStack data plane is
likely to consist of multiple <code>OpenStackDataPlaneNodeSet</code> resources to describe
groups of nodes that are configured differently.</p>
</div>
<div class="paragraph">
<p>Similarities within a <code>OpenStackDataPlaneNodeSet</code> are defined by the user, and
could be of a small scope (ansible port), or a large scope (same network
config, nova config, provisioning config, etc). The properties that all nodes
in a <code>OpenStackDataPlaneNodeSet</code> share are set in the <code>nodeTemplate</code> field of
the <code>OpenStackDataPlaneNodeSet</code> spec. Node specific parameters are then defined
under the <code>nodeTemplate.nodes</code> section specific to that node. Options defined
here will override the inherited values from the <code>NodeSet</code>.</p>
</div>
<div class="paragraph">
<p>Dividing and assigning nodes to different <code>OpenStackDataPlaneNodeSets</code> is a
design decision by the user. Nodes that are configured mostly the same, are of
the same hardware, and serving the same purpose are likely candidates for being
in the same <code>OpenStackDataPlaneNodeSet</code>. While hardware differences or
differences in purposes (compute vs. netwoker) would lend themselves to nodes
being in different <code>OpenStackDataPlaneNodeSets</code>.</p>
</div>
<div class="paragraph">
<p><code>OpenStackDataPlaneNodeSet</code> implements a baremetal provisioning interface to
provision the nodes if requested. The <code>baremetalSetTemplate</code> field is used to
describe the baremetal configuration of the nodes and is used to provision the
initial OS on the set of nodes.</p>
</div>
<div class="paragraph">
<p>The <code>OpenStackDataPlaneService</code> CRD for is an abstraction which combines
Ansible content and configuration from Kubernetes ConfigMaps and Secrets. The
Ansible content is typically a playbook from
<a href="https://github.com/openstack-k8s-operators/edpm-ansible">edpm-ansible</a>, but can
be any Ansible play content. The ConfigMaps and Secrets are typically generated
from OpenStack control plane operators, but could be any configuration data
that needs to be consumed by the Ansible content.</p>
</div>
<div class="paragraph">
<p>An <code>OpenStackDataPlaneNodeSet</code> has a list of services that contain the
<code>OpenStackDataPlaneService</code> resources for the nodes in that
<code>OpenStackDataPlaneNodeSet</code>. Using the services list, users can customize the
software that is deployed on the <code>OpenStackDataPlaneNodeSet</code> nodes.</p>
</div>
<div class="paragraph">
<p>The <code>OpenStackDataPlaneDeployment</code> CRD is used to start an Ansible execution
for the list of <code>OpenStackDataPlaneNodeSets</code> on the
<code>OpenStackDataPlaneDeployment</code>. Each <code>OpenStackDataPlaneDeployment</code> models a
single Ansible execution, and once the execution is successful, the
<code>OpenStackDataPlaneDeployment</code> does not automatically execute Ansible again,
even if the <code>OpenStackDataPlaneDeployment</code> or related
<code>OpenStackDataPlaneNodeSet</code> resources are changed. In order to start another
Ansible execution, another <code>OpenStackDataPlaneDeployment</code> resource needs to be
created. In this manner, the user maintains explicit control over when Ansible
actually executes through the creation of <code>OpenStackDataPlaneDeployment</code>
resources.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly_creating-the-data-plane">Creating the data plane</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>The OpenStack DataPlane consists of CentOS nodes. Use the <code>OpenStackDataPlaneNodeSet</code> custom resource definition (CRD) to create the custom resources (CRs) that define the nodes and the layout of the data plane. You can use pre-provisioned nodes, or provision bare metal nodes as part of the data plane creation and deployment process.</p>
</div>
<div class="paragraph">
<p>To create and deploy a data plane, you must perform the following tasks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a <code>Secret</code> CR for Ansible to use to execute commands on the data plane nodes.</p>
</li>
<li>
<p>Create the <code>OpenStackDataPlaneNodeSet</code> CRs that define the nodes and layout of the data plane.</p>
</li>
<li>
<p>Create the <code>OpenStackDataPlaneDeployment</code> CRs that trigger the Ansible execution to deploy and configure software.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_prerequisites">Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>A functional control plane, created with the OpenStack Operator.</p>
</li>
<li>
<p>Pre-provisioned nodes must be configured with an SSH public key in the <code>$HOME/.ssh/authorized_keys</code> file for a user with passwordless <code>sudo</code> privileges.</p>
</li>
<li>
<p>For bare metal nodes that are not pre-provisioned and must be provisioned when creating the <code>OpenStackDataPlaneNodeSet</code> resource:</p>
<div class="ulist">
<ul>
<li>
<p>CBO is installed and configured for provisioning.</p>
</li>
<li>
<p><code>BareMetalHosts</code> registered, inspected, and have the label <code>app:openstack</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>You are logged on to a workstation that has access to the RHOCP cluster as a user with <code>cluster-admin</code> privileges.</p>
</li>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.14/cli_reference/openshift_cli/getting-started-cli.html#installing-openshift-cli">OpenShift CLI</a> (oc) 4.14 or higher</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="proc_creating-the-SSH-key-secrets_dataplane">Creating the SSH key secrets</h3>
<div class="paragraph _abstract">
<p>You must generate SSH keys and create an SSH key <code>Secret</code> custom resource (CR) for each key to enable the following functionality:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You must generate an SSH key to enable Ansible to manage the CentOS nodes on the data plane. Ansible executes commands with this user and key.</p>
</li>
<li>
<p>You must generate an SSH key to enable migration of instances between Compute nodes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>Secret</code> CRs are used by the data plane nodes to enable secure access between nodes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the SSH key pair for Ansible:</p>
<div class="listingblock">
<div class="content">
<pre>$ KEY_FILE_NAME=&lt;key_file_name&gt;
$ ssh-keygen -f $KEY_FILE_NAME -N "" -t rsa -b 4096</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;key_file_name&gt;</code> with the name to use for the key pair.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create the <code>Secret</code> CR for Ansible and apply it to the cluster:</p>
<div class="listingblock">
<div class="content">
<pre>$ SECRET_NAME=&lt;secret_name&gt;
$ oc create secret generic $SECRET_NAME \
--save-config \
--dry-run=client \
[--from-file=authorized_keys=$KEY_FILE_NAME.pub \]
--from-file=ssh-privatekey=$KEY_FILE_NAME \
--from-file=ssh-publickey=$KEY_FILE_NAME.pub \
-n openstack \
-o yaml | oc apply -f-</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;secret_name&gt;</code> with the name you want to use for the <code>Secret</code> resource.</p>
</li>
<li>
<p>Include the <code>--from-file=authorized_keys</code> option for bare metal nodes that must be provisioned when creating the data plane.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create the SSH key pair for instance migration:</p>
<div class="listingblock">
<div class="content">
<pre>$ ssh-keygen -f ./id -t ecdsa-sha2-nistp521 -N ''</pre>
</div>
</div>
</li>
<li>
<p>Create the <code>Secret</code> CR for migration and apply it to the cluster:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc create secret generic nova-migration-ssh-key \
--from-file=ssh-privatekey=id \
--from-file=ssh-publickey=id.pub \
-n openstack \
-o yaml | oc apply -f-</pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>Secret</code> CRs are created:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc describe secret $SECRET_NAME`</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc_creating-a-set-of-data-plane-nodes_dataplane">Creating a set of data plane nodes</h3>
<div class="paragraph _abstract">
<p>You use the <code>OpenStackDataPlaneNodeSet</code> CRD to define the data plane and the data plane nodes. An <code>OpenStackDataPlaneNodeSet</code> custom resource (CR) represents a set of nodes of the same type that have similar configuration, comparable to the concept of a "role" in a director-deployed Red Hat OpenStack Platform (RHOSP) environment.</p>
</div>
<div class="paragraph">
<p>Create an <code>OpenStackDataPlaneNodeSet</code> CR for each logical grouping of nodes in your data plane, for example, nodes grouped by hardware, location, or networking. You can define as many node sets as necessary for your deployment. Each node can be included in only one <code>OpenStackDataPlaneNodeSet</code> CR. Each node set can be connected to only one Compute cell. By default, node sets are connected to <code>cell1</code>. If your control plane includes additional Compute cells, you must specify the cell to which the node set is connected.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <code>OpenStackDataPlaneNodeSet</code> CR and save it to a file named <code>openstack-edpm.yaml</code> on your workstation:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
spec:
  ...</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#ref_example-OpenStackDataPlaneNodeSet-CR-for-preprovisioned-nodes_dataplane">Example <code>OpenStackDataPlaneNodeSet</code> CR for pre-provisioned nodes</a></p>
</li>
<li>
<p><a href="#ref_example-OpenStackDataPlaneNodeSet-CR-for-bare-metal-nodes_dataplane">Example <code>OpenStackDataPlaneNodeSet</code> CR for bare metal nodes</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>The sample <code>OpenStackDataPlaneNodeSet</code> CR is connected to <code>cell1</code> by default. If you added additional Compute cells to the control plane and you want to connect the node set to one of the other cells, then you must create a custom service for the node set that includes the <code>Secret</code> CR for the cell:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a custom <code>nova</code> service that includes the <code>Secret</code> CR for the cell to connect to:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: <strong>nova-cell-custom</strong>
  spec:
    label: dataplane-deployment-custom-service
       playbook: osp.edpm.nova
    ...
    secrets:
      - nova-cell2-compute-config <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>Secret</code> CR generated by the control plane for the cell.
<div class="paragraph">
<p>For information about how to create a custom service, see <a href="#proc_creating-a-custom-service_dataplane">Creating a custom service</a>.</p>
</div></td>
</tr>
</table>
</div>
</li>
<li>
<p>Replace the <code>nova</code> service in your <code>OpenStackDataPlaneNodeSet</code> CR with your custom <code>nova</code> service:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
spec:
  services:
    - configure-network
    - validate-network
    - install-os
    - configure-os
    - run-os
    - ovn
    - libvirt
    - <strong>nova-cell-custom</strong>
    - telemetry</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Do not change the order of the default services.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Update the <code>Secret</code> to the SSH key secret that you created to enable Ansible to connect to the data plane nodes:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
spec:
  nodeTemplate:
    ansibleSSHPrivateKeySecret: &lt;secret-key&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;secret-key&gt;</code> with the name of the SSH key <code>Secret</code> CR you created in <a href="#proc_creating-the-SSH-key-secrets_dataplane">Creating the SSH key secrets</a>, for example, <code>dataplane-ansible-ssh-private-key-secret</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: Configure the node set for a Compute feature or workload. For more information, see <a href="#proc_configuring-a-node-set-for-a-Compute-feature-or-workload_dataplane">Configuring a node set for a Compute feature or workload</a>.</p>
</li>
<li>
<p>Optional: The sample <code>OpenStackDataPlaneNodeSet</code> CR that you copied includes the minimum common configuration required for a set of nodes in this group under the <code>nodeTemplate</code> section. Each node in this <code>OpenStackDataPlaneNodeSet</code> inherits this configuration. You can edit the configured values as required, and you can add additional configuration.</p>
<div class="paragraph">
<p>For information about the properties you can use to configure common node attributes, see <a href="#ref_OpenStackDataPlaneNodeSet-CR-properties_dataplane"><code>OpenStackDataPlaneNodeSet</code> CR properties</a>.</p>
</div>
<div class="paragraph">
<p>For example <code>OpenStackDataPlaneNodeSet</code> CR <code>nodeTemplate</code> definitions, see <a href="#ref_example-OpenStackDataPlaneNodeSet-CR-for-preprovisioned-nodes_dataplane">Example <code>OpenStackDataPlaneNodeSet</code> CR for pre-provisioned nodes</a> or <a href="#ref_example-OpenStackDataPlaneNodeSet-CR-for-bare-metal-nodes_dataplane">Example <code>OpenStackDataPlaneNodeSet</code> CR for bare metal nodes</a>.</p>
</div>
</li>
<li>
<p>Optional: The sample <code>OpenStackDataPlaneNodeSet</code> CR you copied applies the single NIC VLANs network configuration by default to the data plane nodes. You can edit the template that is applied. For example, to configure the data plane for multiple NICS, copy the contents of the <code>roles/edpm_network_config/templates/multiple_nics/multiple_nics.j2</code> file and add it to your <code>openstack-edpm.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
spec:
  ...
  nodeTemplate:
    ...
    ansible:
      ansibleVars:
        edpm_network_config_template: |
              ---
              network_config:
              - type: interface
                name: nic1
                mtu: {{ ctlplane_mtu }}
                dns_servers: {{ ctlplane_dns_nameservers }}
                domain: {{ dns_search_domains }}
                routes: {{ ctlplane_host_routes }}
                use_dhcp: false
                addresses:
                - ip_netmask: {{ ctlplane_ip }}/{{ ctlplane_subnet_cidr }}
                {% for network in nodeset_networks %}
                {% if network not in ["external", "tenant"] %}
                - type: interface
                  name: nic{{ loop.index +1 }}
                  mtu: {{ lookup('vars', networks_lower[network] ~ '_mtu') }}
                  use_dhcp: false
                  addresses:
                  - ip_netmask:
                    {{ lookup('vars', networks_lower[network] ~ '_ip') }}/{{ lookup('vars', networks_lower[network] ~ '_cidr') }}
                  routes: {{ lookup('vars', networks_lower[network] ~ '_host_routes') }}
                {% elif 'external_bridge' in nodeset_tags|default([]) %}
                - type: ovs_bridge
                {% if network == 'external' %}
                  name: {{ neutron_physical_bridge_name }}
                {% else %}
                  name: {{ 'br-' ~ networks_lower[network] }}
                {% endif %}
                  mtu: {{ lookup('vars', networks_lower[network] ~ '_mtu') }}
                  dns_servers: {{ ctlplane_dns_nameservers }}
                  use_dhcp: false
                  addresses:
                  - ip_netmask:
                    {{ lookup('vars', networks_lower[network] ~ '_ip') }}/{{ lookup('vars', networks_lower[network] ~ '_cidr') }}
                  routes: {{ lookup('vars', networks_lower[network] ~ '_host_routes') }}
                  members:
                  - type: interface
                    name: nic{{loop.index + 1}}
                    mtu: {{ lookup('vars', networks_lower[network] ~ '_mtu') }}
                    use_dhcp: false
                    primary: true
                {% endif %}
                {% endfor %}</pre>
</div>
</div>
<div class="paragraph">
<p>You can copy a sample template from <a href="https://github.com/openstack-k8s-operators/openstack-operator/tree/main/config/samples/nic-config-samples" class="bare">https://github.com/openstack-k8s-operators/openstack-operator/tree/main/config/samples/nic-config-samples</a>. For information about customizing the template, see <a href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/17.1/html/installing_and_managing_red_hat_openstack_platform_with_director/assembly_configuring-overcloud-networking_installing-director-on-the-undercloud#ref_network-interface-configuration-options_custom-network-interface-templates">Network interface configuration options</a>.</p>
</div>
</li>
<li>
<p>If your nodes are bare metal, you must configure the bare metal template, see <a href="#con_provisioning-bare-metal-data-plane-nodes_dataplane">Provisioning bare metal data plane nodes</a>.</p>
</li>
<li>
<p>Optional: The sample <code>OpenStackDataPlaneNodeSet</code> CR you copied includes default node configurations under the <code>nodes</code> section. You can add additional nodes, and edit the configured values as required. For example, to add node-specific Ansible variables that customize the node, add the following configuration to your <code>openstack-edpm.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
spec:
  ...
  nodeTemplate:
    ...
    ansible:
      ...
      ansibleVars:
        rhc_release: 9.2
        rhc_repositories:
            - {name: "*", state: disabled}
            - {name: "rhel-9-for-x86_64-baseos-eus-rpms", state: enabled}
            - {name: "rhel-9-for-x86_64-appstream-eus-rpms", state: enabled}
            - {name: "rhel-9-for-x86_64-highavailability-eus-rpms", state: enabled}
            - {name: "openstack-17.1-for-rhel-9-x86_64-rpms", state: enabled}
            - {name: "fast-datapath-for-rhel-9-x86_64-rpms", state: enabled}
            - {name: "openstack-dev-preview-for-rhel-9-x86_64-rpms", state: enabled}
  ...
  nodes:
    edpm-compute-0: <i class="conum" data-value="1"></i><b>(1)</b>
      hostName: edpm-compute-0
      ansible:
        ansibleHost: 192.168.122.100
        ansibleVars: <i class="conum" data-value="2"></i><b>(2)</b>
          ctlplane_ip: 192.168.122.100
          internalapi_ip: 172.17.0.100
          storage_ip: 172.18.0.100
          tenant_ip: 172.19.0.100
          fqdn_internalapi: edpm-compute-0.example.com
    edpm-compute-1:
      hostName: edpm-compute-1
      ansible:
        ansibleHost: 192.168.122.101
        ansibleVars:
          ctlplane_ip: 192.168.122.101
          internalapi_ip: 172.17.0.101
          storage_ip: 172.18.0.101
          tenant_ip: 172.19.0.101
          fqdn_internalapi: edpm-compute-1.example.com</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The node definition reference, for example, <code>edpm-compute-0</code>. Each node in the node set must have a node definition.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Node-specific Ansible variables that customize the node.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Nodes defined within the <code>nodes</code> section can configure the same Ansible variables that are configured in the <code>nodeTemplate</code> section. Where an Ansible variable is configured for both a specific node and within the <code>nodeTemplate</code> section, the node-specific values override those from the <code>nodeTemplate</code> section.</p>
</li>
<li>
<p>You do not need to replicate all the <code>nodeTemplate</code> Ansible variables for a node to override the default and set some node-specific values. You only need to configure the Ansible variables you want to override for the node.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For information about the properties you can use to configure node attributes, see <a href="#ref_OpenStackDataPlaneNodeSet-CR-properties_dataplane"><code>OpenStackDataPlaneNodeSet</code> CR properties</a>. For example <code>OpenStackDataPlaneNodeSet</code> CR <code>nodes</code> definitions, see <a href="#ref_example-OpenStackDataPlaneNodeSet-CR-for-preprovisioned-nodes_dataplane">Example <code>OpenStackDataPlaneNodeSet</code> CR for pre-provisioned nodes</a> or <a href="#ref_example-OpenStackDataPlaneNodeSet-CR-for-bare-metal-nodes_dataplane">Example <code>OpenStackDataPlaneNodeSet</code> CR for bare metal nodes</a>.</p>
</div>
</li>
<li>
<p>Optional: Customize the container images used by the <code>edpm-ansible</code> roles. The following example shows the default images:</p>
<div class="listingblock">
<div class="content">
<pre>spec:
  ...
  nodeTemplate:
    ...
    ansible:
      ...
      ansibleVars:
        edpm_iscsid_image: "quay.io/podified-antelope-centos9/openstack-iscsid:current-podified"
        edpm_logrotate_crond_image: "quay.io/podified-antelope-centos9/openstack-cron:current-podified"
        edpm_ovn_controller_agent_image: "quay.io/podified-antelope-centos9/openstack-frr:current-podified"
        edpm_ovn_metadata_agent_image: "quay.io/podified-antelope-centos9/openstack-neutron-metadata-agent-ovn:current-podified"
        edpm_frr_image: "quay.io/podified-antelope-centos9/openstack-frr:current-podified"
        edpm_ovn_bgp_agent_image: "quay.io/podified-antelope-centos9/openstack-ovn-bgp-agent:current-podified"
        telemetry_node_exporter_image: "quay.io/prometheus/node-exporter:v1.5.0"
        edpm_telemetry_kepler_image: "quay.io/sustainable_computing_io/kepler"
        edpm_libvirt_image: "quay.io/podified-antelope-centos9/openstack-nova-libvirt:current-podified"
        edpm_nova_compute_image: "quay.io/podified-antelope-centos9/openstack-nova-compute:current-podified"
        edpm_neutron_sriov_image: "quay.io/podified-antelope-centos9/openstack-neutron-sriov-agent:current-podified"
        edpm_multipathd_image: "quay.io/podified-antelope-centos9/openstack-multipathd:current-podified"</pre>
</div>
</div>
</li>
<li>
<p>Save the <code>openstack-edpm.yaml</code> definition file.</p>
</li>
<li>
<p>Create the data plane resources:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc create -f openstack-edpm.yaml</pre>
</div>
</div>
</li>
<li>
<p>Verify that the data plane resources have been created:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackdataplanenodeset
NAME           		STATUS MESSAGE
openstack-edpm-ipam 	False  NodeSet setup ready, waiting for OpenStackDataPlaneDeployment...</pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>Secret</code> resource was created for the node set:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get secret | grep openstack-edpm-ipam
dataplanenodeset-openstack-edpm-ipam Opaque 1 3m50s</pre>
</div>
</div>
</li>
<li>
<p>Verify the services were created:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackdataplaneservice
NAME                AGE
configure-network   6d7h
configure-os        6d6h
install-os          6d6h
run-os              6d6h
validate-network    6d6h
ovn                 6d6h
libvirt             6d6h
nova                6d6h
telemetry           6d6h</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_composable_services">Composable services</h3>
<div class="paragraph">
<p>Composable services with openstack-operator provide a way for users to
customize services that are deployed on dataplane nodes. It is possible to
"compose" a set of services such that the dataplane deployment can be
customized in whichever ways are needed.</p>
</div>
<div class="paragraph">
<p>Composing services can take different forms. The interfaces in
openstack-operator allow for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enabling/disabling services</p>
</li>
<li>
<p>Ordering services</p>
</li>
<li>
<p>Developing custom services</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the purposes of the interfaces in openstack-operator, a service is an
ansible execution that manages a software deployment (installation,
configuration, execution, etc) on dataplane nodes. The ansible content that
makes up each service is defined by the service itself. Each service is a
resource instance of the
<a href="#openstack_dataplaneservice.adoc"><code>OpenStackDataPlaneService</code></a> CRD.</p>
</div>
<div class="sect3">
<h4 id="_openstack_operator_provided_services">openstack-operator provided services</h4>
<div class="paragraph">
<p>openstack-operator provides a default list of services that will be deployed on
dataplane nodes. The services list is set on the
<a href="#openstackdataplanenodesetspec">OpenStackDataPlaneNodeSet</a> CRD.</p>
</div>
<div class="paragraph">
<p>The default list of services as they will appear on the <code>services</code> field on an
<code>OpenStackDataPlaneNodeSet</code> spec is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>services:
  - redhat
  - download-cache
  - bootstrap
  - configure-network
  - validate-network
  - install-os
  - configure-os
  - run-os
  - libvirt
  - nova
  - ovn
  - neutron-metadata
  - telemetry</pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>services</code> field is omitted from the <code>OpenStackDataPlaneNodeSet</code> spec,
then the above list will be used.</p>
</div>
<div class="paragraph">
<p>The associated <code>OpenStackDataPlaneService</code> resources are reconciled during
<code>OpenStackDataPlaneNodeSet</code> reconciliation if the service is in the NodeSets'
service list.</p>
</div>
<div class="paragraph">
<p>The DataPlane Operator also includes the following services that are not enabled by default:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;"/>
<col style="width: 60%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>ceph-client</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Include this service to configure data plane nodes as clients of a Red Hat Ceph Storage server. Include between the <code>install-os</code> and <code>configure-os</code> services. The <code>OpenStackDataPlaneNodeSet</code> CR must include the following configuration to access the Red Hat Ceph Storage secrets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
spec:
  ...
  nodeTemplate:
    extraMounts:
    - extraVolType: Ceph
      volumes:
      - name: ceph
        secret:
          secretName: ceph-conf-files
      mounts:
      - name: ceph
        mountPath: "/etc/ceph"
        readOnly: true</pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>ceph-hci-pre</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Include this service to prepare data plane nodes to host Red Hat Ceph Storage in an HCI configuration. For more information, see <a href="#assembly_configuring-a-hyperconverged-infrastructure-environment">Configuring a Hyperconverged Infrastructure environment</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>configure-ovs-dpdk</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Include this service to configure OvS DPDK configuration on EDPM nodes. This service is needed to enable OvS DPDK on the compute nodes.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>neutron-sriov</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Include this service to run a Neutron SR-IOV NIC agent on the data plane nodes.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>neutron-metadata</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Include this service to run the Neutron OVN Metadata agent on the data plane nodes. This agent is required to provide metadata services to the Compute nodes.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>neutron-ovn</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Include this service to run the Neutron OVN agent on the data plane nodes. This agent is required to provide QoS to hardware offloaded ports on the Compute nodes.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>neutron-dhcp</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Include this service to run a Neutron DHCP agent on the data plane nodes.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>cleanup</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Include this service to clean up containers and configurations for services that have been removed from the nodeset. The cleanup service compares the current services list with previously deployed services, removes containers for services no longer in the list, removes startup_config and configuration files, and runs service-specific cleanup tasks. Use this service via <code>servicesOverride</code> for one-time cleanup after removing services from a nodeset, or add to the services list if cleanup should run on every deployment.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For more information about the available default services, see <a href="https://github.com/openstack-k8s-operators/openstack-operator/tree/main/config/services" class="bare">https://github.com/openstack-k8s-operators/openstack-operator/tree/main/config/services</a>.</p>
</div>
<div class="paragraph">
<p>You can enable and disable services for an <code>OpenStackDataPlaneNodeSet</code> resource.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Do not change the order of the default service deployments.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use the <code>OpenStackDataPlaneService</code> CRD to create custom services that you can deploy on your data plane nodes. You add your custom services to the default list of services where the service must be executed. For more information, see <a href="#proc_creating-a-custom-service_dataplane">Creating a custom service</a>.</p>
</div>
<div class="paragraph">
<p>You can view the details of a service by viewing the YAML representation of the resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackdataplaneservice configure-network -o yaml</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_overriding_services_for_the_deployment">Overriding services for the deployment</h4>
<div class="paragraph">
<p>The list of services that will be deployed when an
<code>OpenStackDataPlaneDeployment</code> is created is set on each
<code>OpenStackDataPlaneNodeSet</code> that is included in the <code>nodeSets</code> list on the
<code>OpenStackDataPlaneDeployment</code>.</p>
</div>
<div class="paragraph">
<p>This allows for deploying a different set of services on different
<code>OpenStackDataPlaneNodeSets</code> using the same <code>OpenStackDataPlaneDeployment</code>
resource simultaneously. It also maintains the association between services and
nodeSets on the nodeSet itself. This association is important when nodeSets are
used to group nodes with hardware and configuration differences that require
the need for deploying different services on different nodeSets.</p>
</div>
<div class="paragraph">
<p>In some specific cases, it may be needed to override what services are deployed
on all nodeSets included in an <code>OpenStackDataPlaneDeployment</code>. These cases can
vary, but are often related to day 2 workflows such as update, upgrade, and
scale out. In these cases, it may be needed to execute a smaller subset of
services, or just a single service, across all nodeSets in the
<code>OpenStackDataPlaneDeployment</code>.</p>
</div>
<div class="paragraph">
<p>The <code>servicesOverride</code> field on <code>OpenStackDataPlaneDeployment</code> allow for this
behavior. Setting this field changes what services are deployed when the
<code>OpenStackDataPlaneDeployment</code> is created. If the field is set, only the
services listed in the field will be deployed on all nodeSets.</p>
</div>
<div class="paragraph">
<p>If deployment has been configured with <code>tlsEnabled</code> set to <code>True</code> in the
original <code>OpenStackDataPlaneNodeSet</code> CR, it is recommended to add also
<code>install-certs</code> to the list of services in <code>servicesOverride</code> list. That will
install certificates potentially required by the other services in
the destination nodes.</p>
</div>
<div class="paragraph">
<p>The following example <code>OpenStackDataPlaneDeployment</code> resource illustrates using
<code>servicesOverride</code> to perform a pre-upgrade task of executing just the ovn
service.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: openstack-edpm-pre-upgrade-ovn
spec:

  nodeSets:
    - openstack-edpm

  // Only the services here will be executed. Overriding any services value
  // on the openstack-edpm nodeSet.
  // Service install-certs is added here to install certificates
  // potentially required by the ovn service
  servicesOverride:
    - install-certs
    - ovn</pre>
</div>
</div>
<div class="sect4">
<h5 id="_cleaning_up_removed_services">Cleaning up removed services</h5>
<div class="paragraph">
<p>When services are removed from a nodeset&#8217;s services list, their containers and
configuration files remain on the data plane nodes. Use the <code>cleanup</code> service
to remove these artifacts.</p>
</div>
<div class="paragraph">
<p>The cleanup service tracks which services were previously deployed on each node.
When executed, it identifies services that are no longer in the nodeset&#8217;s
services list and removes their:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Containers</p>
</li>
<li>
<p>Startup configuration files</p>
</li>
<li>
<p>Other configuration files</p>
</li>
<li>
<p>Service-specific artifacts (via cleanup tasks defined in each role)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To enable cleanup of orphaned containers, set the <code>edpm_cleanup_orphaned_containers</code>
Ansible variable to <code>true</code> using <code>ansibleExtraVars</code> on the deployment.</p>
</div>
<div class="paragraph">
<p>The following example shows how to run a one-time cleanup after removing
services from a nodeset:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: openstack-edpm-cleanup
spec:
  nodeSets:
    - openstack-edpm
  ansibleExtraVars:
    edpm_cleanup_orphaned_containers: true
  servicesOverride:
    - cleanup</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc_creating-a-custom-service_dataplane">Creating a custom service</h4>
<div class="paragraph _abstract">
<p>You can use the <code>OpenStackDataPlaneService</code> CRD to create custom services to deploy on your data plane nodes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Do not create a custom service with the same name as one of the default services. If a custom service name matches a default service name, the default service values overwrite the custom service values during <code>OpenStackDataPlaneNodeSet</code> reconciliation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You specify the Ansible execution for your service with either an Ansible playbook or by including the free-form play contents directly in the <code>spec</code> section of the service.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You cannot use both an Ansible playbook and an Ansible play in the same service.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <code>OpenStackDataPlaneService</code> CR and save it to a YAML file on your workstation, for example <code>custom-service.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: custom-service
spec:
  label: dataplane-deployment-custom-service</pre>
</div>
</div>
</li>
<li>
<p>Specify the Ansible commands to create the custom service, by referencing an Ansible playbook or by including the Ansible play in the <code>spec</code>:</p>
<div class="ulist">
<ul>
<li>
<p>Specify the Ansible playbook to use:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: custom-service
spec:
  label: dataplane-deployment-custom-service
  playbook: osp.edpm.configure_os</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For information about how to create an Ansible playbook, see <a href="https://docs.ansible.com/ansible-core/devel/getting_started/get_started_playbook.html">Creating a playbook</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specify the Ansible play as a string that uses Ansible playbook syntax:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: custom-service
spec:
  label: dataplane-deployment-custom-service
  playbookContents: |
    hosts: all
    tasks:
      - name: Hello World!
        shell: "echo Hello World!"
        register: output
      - name: Show output
        debug:
          msg: "{{ output.stdout }}"
      - name: Hello World role
        import_role: hello_world</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: To override the default container image used by the <code>ansible-runner</code> execution environment with a custom image that uses additional Ansible content for a custom service, build and include a custom <code>ansible-runner</code> image. For information, see <a href="#proc_building-a-custom-ansible-runner-image_dataplane">Building a custom <code>ansible-runner</code> image</a>.</p>
</li>
<li>
<p>Optional: Designate and configure a node set for a Compute feature or workload. For more information, see <a href="#proc_configuring-a-node-set-for-a-Compute-feature-or-workload_dataplane">Configuring a node set for a Compute feature or workload</a>.</p>
</li>
<li>
<p>Optional: Specify <a href="#datasource">DataSource</a> resources to use to pass <code>ConfigMaps</code> or <code>Secrets</code> into the <code>OpenStackAnsibleEE</code> job. When the <code>optional</code> field is true on a <a href="#datasource">DataSource</a> <code>configMapRef</code> or <code>secretRef</code>, the resource is optional, and an error won&#8217;t occur when it doesn&#8217;t exist.</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: custom-service
spec:
  ...
  playbookContents: |
    ...
  dataSources:
	  - configMapRef:
		    name: hello-world-cm-0
    - secretRef:
	      name: hello-world-secret-0
    - secretRef:
        name: hello-world-secret-1
		    # This secret is optional, it does not need to exist.
        optional: true</pre>
</div>
</div>
<div class="paragraph">
<p>A mount is created for each <code>ConfigMap</code> and <code>Secret</code> in the <code>OpenStackAnsibleEE</code> pod with a filename that matches the resource value. The mounts are created under <code>/var/lib/openstack/configs/&lt;service name&gt;</code>.</p>
</div>
</li>
<li>
<p>Optional: It may be necessary to run some services on all nodesets at the same time. These services need to have their <code>deployOnAllNodeSets</code> field set to true. If these services are repated in multiple nodeset specs included in a deployment, they would be ignored from subsequent nodeset services and would be run only once.</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: custom-global-service
spec:
  label: custom-global-service
  playbookContents: |
    - hosts: localhost
      gather_facts: no
      name: global play
      tasks:
        - name: Sleep
          command: sleep 1
          delegate_to: localhost
  deployOnAllNodeSets: true</pre>
</div>
</div>
</li>
<li>
<p>Optional: Specify the <code>edpmServiceType</code> field for the service. Different custom services may use the same ansible content to manage the same EDPM service (such as <code>ovn</code> or <code>nova</code>). The <code>DataSources</code>, TLS certificates, and CA certificates need to be mounted at the same locations so they can be found by the ansible content even when using a custom service. <code>edpmServiceType</code> is used to create this association. The value is the name of the default service that uses the same ansible content as the custom service. If there are multiple services with the same <code>edpmServiceType</code> listed in a nodeset or deployment spec, latter ones would be ignored.</p>
<div class="paragraph">
<p>For example, a custom service that uses the <code>edpm_ovn</code> ansible content from <code>edpm-ansible</code> would set <code>edpmServiceType</code> to <code>ovn</code>, which matches the default <code>ovn</code> service name provided by <code>openstack-operator</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: custom-ovn-service
spec:
  edpmServiceType: ovn</pre>
</div>
</div>
</li>
<li>
<p>Create the custom service:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc apply -f custom-service.yaml</pre>
</div>
</div>
</li>
<li>
<p>Verify that the custom service is created:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackdataplaneservice &lt;custom_service_name&gt; -o yaml</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_enabling_a_custom_service">Enabling a custom service</h5>
<div class="paragraph">
<p>To add a custom service to be executed as part of an <code>OpenStackDataPlaneNodeSet</code>
deployment, add the service name to the <code>services</code> field list on the <code>NodeSet</code>. Add
the service name in the order that it should be executed relative to the other
services. This example shows adding the <code>hello-world</code> service as the first
service to execute for the <code>edpm-compute</code> <code>NodeSet</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm
spec:
  services:
    - hello-world
    - redhat
    - download-cache
    - bootstrap
    - configure-network
    - validate-network
    - install-os
    - configure-os
    - run-os
    - ovn
    - neutron-metadata
    - libvirt
    - nova
  nodes:
    edpm-compute:
      ansible:
        ansibleHost: 172.20.12.67
        ansibleSSHPrivateKeySecret: dataplane-ansible-ssh-private-key-secret
        ansibleUser: cloud-admin
        ansibleVars:
          ansible_ssh_transfer_method: scp
          ctlplane_ip: 172.20.12.67
          external_ip: 172.20.12.76
          fqdn_internalapi: edpm-compute-1.example.com
          internalapi_ip: 172.17.0.101
          storage_ip: 172.18.0.101
          tenant_ip: 172.10.0.101
      hostName: edpm-compute-0
      networkConfig: {}
      nova:
        cellName: cell1
        deploy: true
        novaInstance: nova
  nodeTemplate: {}</pre>
</div>
</div>
<div class="paragraph">
<p>When customizing the services list, the default list of services must be
reproduced and then customized if the intent is to still deploy those services.
If just the <code>hello-world</code> service was listed in the list, then that is the only
service that would be deployed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Exercise caution when including a service that is meant to be exectured on every <code>NodeSet</code> in the list.
Some services may behave in unexpected ways when executed multiple times on the same node.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc_configuring-a-node-set-for-a-Compute-feature-or-workload_dataplane">Configuring a node set for a Compute feature or workload</h4>
<div class="paragraph">
<p>You can designate a node set for a particular Compute feature or workload. To designate and configure a node set for a feature, complete the following tasks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a <code>ConfigMap</code> CR to configure the Compute nodes.</p>
</li>
<li>
<p>Create a custom <code>nova</code> service for the feature that runs the <code>osp.edpm.nova</code> playbook.</p>
</li>
<li>
<p>Include the <code>ConfigMap</code> CR in the custom <code>nova</code> service.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create <code>ConfigMap</code> CR to configure the Compute nodes. For example, to enable CPU pinning on the Compute nodes, create the following <code>ConfigMap</code> object:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: v1
kind: ConfigMap
metadata:
  name: nova-cpu-pinning-configmap
  namespace: openstack
data:
  25-nova-cpu-pinning.conf: |
    [compute]
    cpu_shared_set = 2,6
    cpu_dedicated_set = 1,3,5,7</pre>
</div>
</div>
<div class="paragraph">
<p>When the service is deployed it adds the configuration to <code>etc/nova/nova.conf.d/</code> in the <code>nova_compute</code> container.</p>
</div>
<div class="paragraph">
<p>For more information on creating <code>ConfigMap</code> objects, see <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">Creating and using config maps</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can use a <code>Secret</code> to create the custom configuration instead if the configuration includes sensitive information, such as passwords or certificates that are required for certification.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a custom <code>nova</code> service for the feature. For information about how to create a custom service, see <a href="#proc_creating-a-custom-service_dataplane">Creating a custom service</a>.</p>
</li>
<li>
<p>Add the <code>ConfigMap</code> CR to the custom <code>nova</code> service:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: nova-cpu-pinning-service
spec:
  label: dataplane-deployment-custom-service
    playbook: osp.edpm.nova
  configMaps:
    - nova-cpu-pinning-configmap</pre>
</div>
</div>
</li>
<li>
<p>Specify the <code>Secret</code> CR for the cell that the node set that runs this service connects to:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: nova-cpu-pinning-service
spec:
  label: dataplane-deployment-custom-service
    playbook: osp.edpm.nova
  configMaps:
    - nova-cpu-pinning-configmap
  secrets:
    - nova-cell1-compute-config</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc_building-a-custom-ansible-runner-image_dataplane">Building a custom <code>ansible-runner</code> image</h4>
<div class="paragraph _abstract">
<p>You can override the default container image used by the <code>ansible-runner</code> execution environment with your own custom image when you need additional Ansible content for a custom service.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Containerfile</code> that adds the custom content to the default image:</p>
<div class="listingblock">
<div class="content">
<pre>FROM quay.io/openstack-k8s-operators/openstack-ansibleee-runner:latest
COPY my_custom_role /usr/share/ansible/roles/my_custom_role</pre>
</div>
</div>
</li>
<li>
<p>Build and push the image to a container registry:</p>
<div class="listingblock">
<div class="content">
<pre>$ podman build -t quay.io/example_user/my_custom_image:latest .
$ podman push quay.io/example_user/my_custom_role:latest</pre>
</div>
</div>
</li>
<li>
<p>Specify your new container image as the image that the <code>ansible-runner</code> execution environment must use to add the additional Ansible content that your custom service requires, such as Ansible roles or modules:</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: custom-service
spec:
  label: dataplane-deployment-custom-service
  openStackAnsibleEERunnerImage: quay.io/openstack-k8s-operators/openstack-ansibleee-runner:latest <i class="conum" data-value="1"></i><b>(1)</b>
  playbookContents: |</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Your container image that the <code>ansible-runner</code> execution environment uses to execute Ansible.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ref_example-OpenStackDataPlaneNodeSet-CR-for-preprovisioned-nodes_dataplane">Example <code>OpenStackDataPlaneNodeSet</code> CR for pre-provisioned nodes</h3>
<div class="paragraph _abstract">
<p>The following example <code>OpenStackDataPlaneNodeSet</code> CR creates a set of generic Compute nodes with some node-specific configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
  namespace: openstack
spec:
  env: <i class="conum" data-value="1"></i><b>(1)</b>
    - name: ANSIBLE_FORCE_COLOR
      value: "True"
  networkAttachments: <i class="conum" data-value="2"></i><b>(2)</b>
    - ctlplane
  nodeTemplate: <i class="conum" data-value="3"></i><b>(3)</b>
    ansible:
      ansibleUser: cloud-admin <i class="conum" data-value="4"></i><b>(4)</b>
      ansibleVars: <i class="conum" data-value="5"></i><b>(5)</b>
        edpm_network_config_template: | <i class="conum" data-value="6"></i><b>(6)</b>
          ---
          {% set mtu_list = [ctlplane_mtu] %}
          {% for network in nodeset_networks %}
          {% set _ = mtu_list.append(lookup('vars', networks_lower[network] ~ '_mtu')) %}
          {%- endfor %}
          {% set min_viable_mtu = mtu_list | max %}
          network_config:
          - type: ovs_bridge
            name: {{ neutron_physical_bridge_name }}
            mtu: {{ min_viable_mtu }}
            use_dhcp: false
            dns_servers: {{ ctlplane_dns_nameservers }}
            domain: {{ dns_search_domains }}
            addresses:
            - ip_netmask: {{ ctlplane_ip }}/{{ ctlplane_cidr }}
            routes: {{ ctlplane_host_routes }}
            members:
            - type: interface
              name: nic1
              mtu: {{ min_viable_mtu }}
              # force the MAC address of the bridge to this interface
              primary: true
          {% for network in nodeset_networks %}
            - type: vlan
              mtu: {{ lookup('vars', networks_lower[network] ~ '_mtu') }}
              vlan_id: {{ lookup('vars', networks_lower[network] ~ '_vlan_id') }}
              addresses:
              - ip_netmask:
                  {{ lookup('vars', networks_lower[network] ~ '_ip') }}/{{ lookup('vars', networks_lower[network] ~ '_cidr') }}
              routes: {{ lookup('vars', networks_lower[network] ~ '_host_routes') }}
          {% endfor %}
        edpm_nodes_validation_validate_controllers_icmp: false
        edpm_nodes_validation_validate_gateway_icmp: false
        edpm_sshd_allowed_ranges:
          - 192.168.122.0/24
        enable_debug: false
        gather_facts: false
        neutron_physical_bridge_name: br-ex
        neutron_public_interface_name: eth0
    ansibleSSHPrivateKeySecret: dataplane-ansible-ssh-private-key-secret <i class="conum" data-value="7"></i><b>(7)</b>
  nodes:
    edpm-compute-0: <i class="conum" data-value="8"></i><b>(8)</b>
      ansible:
        ansibleHost: 192.168.122.100
      hostName: edpm-compute-0
      networks:
        - defaultRoute: true
          fixedIP: 192.168.122.100
          name: ctlplane
          subnetName: subnet1
        - name: internalapi
          subnetName: subnet1
        - name: storage
          subnetName: subnet1
        - name: tenant
          subnetName: subnet1
  preProvisioned: true <i class="conum" data-value="9"></i><b>(9)</b>
  services: <i class="conum" data-value="10"></i><b>(10)</b>
    - redhat
    - bootstrap
    - download-cache
    - configure-network
    - validate-network
    - install-os
    - configure-os
    - ssh-known-hosts
    - run-os
    - reboot-os
    - install-certs
    - ovn
    - neutron-metadata
    - libvirt
    - nova
    - telemetry
  tlsEnabled: true</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Optional: A list of environment variables to pass to the pod.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The networks the <code>ansibleee-runner</code> connects to, specified as a list of <code>netattach</code> resource names.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The common configuration to apply to all nodes in this set of nodes.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The user associated with the secret you created in <a href="#proc_creating-the-SSH-key-secrets_dataplane">Creating the SSH key secrets</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The Ansible variables that customize the set of nodes. For a complete list of Ansible variables, see <a href="https://openstack-k8s-operators.github.io/edpm-ansible/" class="bare">https://openstack-k8s-operators.github.io/edpm-ansible/</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The network configuration template to apply to nodes in the set. For sample templates, see <a href="https://github.com/openstack-k8s-operators/edpm-ansible/tree/main/roles/edpm_network_config/templates" class="bare">https://github.com/openstack-k8s-operators/edpm-ansible/tree/main/roles/edpm_network_config/templates</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The name of the secret that you created in <a href="#proc_creating-the-SSH-key-secrets_dataplane">Creating the SSH key secrets</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The node definition reference, for example, <code>edpm-compute-0</code>. Each node in the node set must have a node definition.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Specify if the nodes in this set are pre-provisioned, or if they must be provisioned when creating the resource.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The services that are deployed on the data plane nodes in this <code>OpenStackDataPlaneNodeSet</code> CR.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ref_example-OpenStackDataPlaneNodeSet-CR-for-bare-metal-nodes_dataplane">Example <code>OpenStackDataPlaneNodeSet</code> CR for bare metal nodes</h3>
<div class="paragraph _abstract">
<p>The following example <code>OpenStackDataPlaneNodeSet</code> CR creates a set of generic Compute nodes with some node-specific configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
  namespace: openstack
spec:
  baremetalSetTemplate: <i class="conum" data-value="1"></i><b>(1)</b>
    bmhLabelSelector:
      app: openstack
    cloudUserName: cloud-admin
    ctlplaneInterface: enp1s0
  env: <i class="conum" data-value="2"></i><b>(2)</b>
    - name: ANSIBLE_FORCE_COLOR
      value: "True"
  networkAttachments: <i class="conum" data-value="3"></i><b>(3)</b>
    - ctlplane
  nodeTemplate: <i class="conum" data-value="4"></i><b>(4)</b>
    ansible:
      ansibleUser: cloud-admin <i class="conum" data-value="5"></i><b>(5)</b>
      ansibleVars: <i class="conum" data-value="6"></i><b>(6)</b>
        edpm_network_config_template: | <i class="conum" data-value="7"></i><b>(7)</b>
          ---
          {% set mtu_list = [ctlplane_mtu] %}
          {% for network in nodeset_networks %}
          {% set _ = mtu_list.append(lookup('vars', networks_lower[network] ~ '_mtu')) %}
          {%- endfor %}
          {% set min_viable_mtu = mtu_list | max %}
          network_config:
          - type: ovs_bridge
            name: {{ neutron_physical_bridge_name }}
            mtu: {{ min_viable_mtu }}
            use_dhcp: false
            dns_servers: {{ ctlplane_dns_nameservers }}
            domain: {{ dns_search_domains }}
            addresses:
            - ip_netmask: {{ ctlplane_ip }}/{{ ctlplane_cidr }}
            routes: {{ ctlplane_host_routes }}
            members:
            - type: interface
              name: nic1
              mtu: {{ min_viable_mtu }}
              # force the MAC address of the bridge to this interface
              primary: true
          {% for network in nodeset_networks %}
            - type: vlan
              mtu: {{ lookup('vars', networks_lower[network] ~ '_mtu') }}
              vlan_id: {{ lookup('vars', networks_lower[network] ~ '_vlan_id') }}
              addresses:
              - ip_netmask:
                  {{ lookup('vars', networks_lower[network] ~ '_ip') }}/{{ lookup('vars', networks_lower[network] ~ '_cidr') }}
              routes: {{ lookup('vars', networks_lower[network] ~ '_host_routes') }}
          {% endfor %}
        edpm_nodes_validation_validate_controllers_icmp: false
        edpm_nodes_validation_validate_gateway_icmp: false
        edpm_sshd_allowed_ranges:
          - 192.168.111.0/24
        enable_debug: false
        gather_facts: false
        neutron_physical_bridge_name: br-ex
        neutron_public_interface_name: eth0
    ansibleSSHPrivateKeySecret: dataplane-ansible-ssh-private-key-secret <i class="conum" data-value="8"></i><b>(8)</b>
    networks: <i class="conum" data-value="9"></i><b>(9)</b>
      - defaultRoute: true
        name: ctlplane
        subnetName: subnet1
      - name: internalapi
        subnetName: subnet1
      - name: storage
        subnetName: subnet1
      - name: tenant
        subnetName: subnet1
  nodes:
    edpm-compute-0: <i class="conum" data-value="10"></i><b>(10)</b>
      hostName: edpm-compute-0
  preProvisioned: false
  services: <i class="conum" data-value="11"></i><b>(11)</b>
    - redhat
    - bootstrap
    - download-cache
    - configure-network
    - validate-network
    - install-os
    - configure-os
    - ssh-known-hosts
    - run-os
    - reboot-os
    - install-certs
    - ovn
    - neutron-metadata
    - libvirt
    - nova
    - telemetry
  tlsEnabled: true</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the bare metal template for bare metal nodes that must be provisioned when creating the resource. Optionally includes <code>ctlplaneBond</code> for network interface bonding configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Optional: A list of environment variables to pass to the pod.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The networks the <code>ansibleee-runner</code> connects to, specified as a list of <code>netattach</code> resource names.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The common configuration to apply to all nodes in this set of nodes.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The user associated with the secret you created in <a href="#proc_creating-the-SSH-key-secrets_dataplane">Creating the SSH key secrets</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The Ansible variables that customize the set of nodes. For a complete list of Ansible variables, see <a href="https://openstack-k8s-operators.github.io/edpm-ansible/" class="bare">https://openstack-k8s-operators.github.io/edpm-ansible/</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The network configuration template to apply to nodes in the set. For sample templates, see <a href="https://github.com/openstack-k8s-operators/edpm-ansible/tree/main/roles/edpm_network_config/templates" class="bare">https://github.com/openstack-k8s-operators/edpm-ansible/tree/main/roles/edpm_network_config/templates</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The name of the secret that you created in <a href="#proc_creating-the-SSH-key-secrets_dataplane">Creating the SSH key secrets</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Networks for the bare metal nodes.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The node definition reference, for example, <code>edpm-compute-0</code>. Each node in the node set must have a node definition.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>The services that are deployed on the data plane nodes in this <code>OpenStackDataPlaneNodeSet</code> CR.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ref_data-plane-conditions-and-states_dataplane">Data plane conditions and states</h3>
<div class="paragraph _abstract">
<p>Each data plane resource has a series of conditions within their <code>status</code> subresource that indicates the overall state of the resource, including its deployment progress.</p>
</div>
<div class="paragraph">
<p>For an <code>OpenStackDataPlaneNodeSet</code>, until an <code>OpenStackDataPlaneDeployment</code> has been started and finished successfully, the <code>Ready</code> condition is <code>False</code>. When the deployment  succeeds, the <code>Ready</code> condition is set to <code>True</code>. A subsequent deployment sets the <code>Ready</code> condition to <code>False</code> until the deployment succeeds, when the <code>Ready</code> condition is set to <code>True</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. <code>OpenStackDataPlaneNodeSet</code> CR conditions</caption>
<colgroup>
<col style="width: 40%;"/>
<col style="width: 60%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Condition</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Ready</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>"True": The <code>OpenStackDataPlaneNodeSet</code> CR is successfully deployed.</p>
</li>
<li>
<p>"False": The deployment is not yet requested or has failed, or there are other failed conditions.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>SetupReady</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True": All setup tasks for a resource are complete. Setup tasks include verifying the SSH key secret, verifying other fields on the resource, and creating the Ansible inventory for each resource. Each service-specific condition is set to "True" when that service completes deployment. You can check the service conditions to see which services have completed their deployment, or which services failed.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>DeploymentReady</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True":  The NodeSet has been successfully deployed.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>InputReady</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True": The required inputs are available and ready.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>NodeSetDNSDataReady</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True": DNSData resources are ready.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>NodeSetIPReservationReady</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True": The IPSet resources are ready.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>NodeSetBaremetalProvisionReady</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True": Bare metal nodes are provisioned and ready.</p>
</div></div></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. <code>OpenStackDataPlaneNodeSet</code> status fields</caption>
<colgroup>
<col style="width: 40%;"/>
<col style="width: 60%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Status field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Deployed</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>"True": The <code>OpenStackDataPlaneNodeSet</code> CR is successfully deployed.</p>
</li>
<li>
<p>"False": The deployment is not yet requested or has failed, or there are other failed conditions.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>DNSClusterAddresses</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>CtlplaneSearchDomain</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. <code>OpenStackDataPlaneDeployment</code> CR conditions</caption>
<colgroup>
<col style="width: 40%;"/>
<col style="width: 60%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Condition</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Ready</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>"True": The data plane is successfully deployed.</p>
</li>
<li>
<p>"False": The data plane deployment failed, or there are other failed conditions.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>DeploymentReady</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True": The data plane is successfully deployed.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>InputReady</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True": The required inputs are available and ready.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;NodeSet&gt; Deployment Ready</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True": The deployment has succeeded for the named <code>NodeSet</code>, indicating all services for the <code>NodeSet</code> have succeeded.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;NodeSet&gt; &lt;Service&gt; Deployment Ready</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True": The deployment has succeeded for the named <code>NodeSet</code> and <code>Service</code>. Each <code>&lt;NodeSet&gt; &lt;Service&gt; Deployment Ready</code> specific condition is set to "True" as that service completes successfully for the named <code>NodeSet</code>. Once all services are complete for a <code>NodeSet</code>, the <code>&lt;NodeSet&gt; Deployment Ready</code> condition is set to "True". The service conditions indicate which services have completed their deployment, or which services failed and for which <code>NodeSets</code>.</p>
</div></div></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. <code>OpenStackDataPlaneDeployment</code> status fields</caption>
<colgroup>
<col style="width: 40%;"/>
<col style="width: 60%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Status field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Deployed</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>"True": The data plane is successfully deployed. All Services for all NodeSets have succeeded.</p>
</li>
<li>
<p>"False": The deployment is not yet requested or has failed, or there are other failed conditions.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. <code>OpenStackDataPlaneService</code> CR conditions</caption>
<colgroup>
<col style="width: 40%;"/>
<col style="width: 60%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Condition</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Ready</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"True": The service has been created and is ready for use.
"False": The service has failed to be created.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="con_provisioning-bare-metal-data-plane-nodes_dataplane">Provisioning bare metal data plane nodes</h3>
<div class="paragraph _abstract">
<p>Provisioning bare metal nodes on the data plane is supported with the Red Hat OpenShift
Container Platform (RHOCP) Cluster Baremetal Operator (CBO). The CBO is a RHOCP Operator
responsible for deploying all the components that are required to provision bare metal
nodes within the RHOCP cluster, including the Bare Metal Operator (BMO) and Ironic
containers.</p>
</div>
<div class="sect3">
<h4 id="_installer_provisioned_infrastructure">Installer-Provisioned Infrastructure</h4>
<div class="paragraph">
<p>CBO is enabled by default on RHOCP clusters that are installed with the baremetal
installer-provisioned infrastructure. You can configure installer-provisioned clusters
with a provisioning network to enable both virtual media and network boot installations.
You can alternatively configure an installer-provisioned cluster without a provisioning
network so that only virtual media provisioning is possible.</p>
</div>
</div>
<div class="sect3">
<h4 id="_assisted_installer_provisioned_infrastructure">Assisted Installer Provisioned Infrastructure</h4>
<div class="paragraph">
<p>You can enable CBO on clusters installed with the Assisted Installer, and you can manually
add the provisioning network to the Assisted Installer cluster after installation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_user_provisioned_infrastructure">User Provisioned Infrastructure</h4>
<div class="paragraph">
<p>You can activate CBO on RHOCP clusters installed with user-provisioned infrastructure by
creating a Provisioning CR. You cannot add a provisioning network to a user-provisioned
cluster.</p>
</div>
<div class="paragraph">
<p>For user-provisioned insfrastructure a provisioning CR has to be created manually as below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apiVersion: metal3.io/v1alpha1
kind: Provisioning
metadata:
  name: provisioning-configuration
spec:
  provisioningNetwork: "Disabled"
  watchAllNamespaces: false</pre>
</div>
</div>
<div class="paragraph">
<p>BMO manages the available hosts on clusters and performs the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inspects node hardware details and reports them to the corresponding BareMetalHost CR.
This includes information about CPUs, RAM, disks and NICs.</p>
</li>
<li>
<p>Provisions nodes with a specific image.</p>
</li>
<li>
<p>Cleans node disk contents before and after provisioning.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_provisioning_nodes_with_openstackdataplanenodeset">Provisioning Nodes with OpenStackDataPlaneNodeSet</h4>
<div class="paragraph">
<p>Before deploying dataplane nodes on baremetal, ensure that CBO has been enabled/activated
with clusters installed with the different installers mentioned above.</p>
</div>
<div class="paragraph">
<p>Sufficient number of edpm node BareMetalHost(BMH) CRs should be created and be in
<code>Available</code> state (after inspection).By default baremetal-operator would be looking
for BMHs in the <code>openshift-machine-api</code> namespace.</p>
</div>
<div class="paragraph">
<p><code>Provisioning</code> resource should be patched to watch all namespaces with <code>watchAllNamespaces: true</code>
as the secrets would be created in <code>openstack</code> namespace, in spite of BMHs in <code>openshift-machine-api</code>
namespace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc patch provisioning provisioning-configuration --type merge -p '{"spec":{"watchAllNamespaces": true }}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sample BMH spec:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apiVersion: metal3.io/v1alpha1
kind: BareMetalHost
metadata:
  name: edpm-compute-01
  namespace: openstack
  labels:
    app: openstack
    workload: compute
spec:
  bmc:
    address: redfish+http://192.168.111.1:8000/redfish/v1/Systems/e8efd888-f844-4fe0-9e2e-498f4ab7806d
    credentialsName: node-bmc-secret
  bootMACAddress: 00:c7:e4:a7:e7:f3
  bootMode: UEFI
  online: false</pre>
</div>
</div>
<div class="paragraph">
<p>BMH <code>labels</code> should be set appropriately for the desired nodes so that it can be used
by the <code>bmhLabelSelector</code> in the <code>OpenStackDataPlaneNodeSet</code> spec.</p>
</div>
<div class="paragraph">
<p>For virtual-media provisioning BMC address should use virtual-media as below.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>bmc:
  address: redfish-virtualmedia+http://192.168.111.1:8000/redfish/v1/Systems/e8efd888-f844-4fe0-9e2e-498f4ab7806d</pre>
</div>
</div>
<div class="paragraph">
<p>To provision the baremetal nodes for edpm, OpenStackDataPlaneNodeSet spec should have the
<code>baremetalSetTemplate</code> section as show below. Other than <code>bmhLabelSelector</code>, <code>hardwareReqs</code>
field can also be provided for appropriate BMH selection. To select a particular BMH for a
node, <code>bmhLabelSelector</code> can be provided in the node section of the <code>OpenStackDataPlaneNodeSet</code>
spec. These labels would be used in addition to the labels set in <code>baremetalSetTemplate</code> to
select BMHs for the node.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm
spec:
  baremetalSetTemplate:
    bmhLabelSelector:
      app: openstack
      workload: compute
    ctlplaneInterface: enp1s0
    cloudUserName: cloud-admin
  nodes:
    edpm-compute-0
      hostName: edpm-compute-0
      ansible:
        ansibleHost: 192.168.122.100
      bmhLabelSelector:
        nodeName: edpm-compute-01</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_network_interface_bonding_for_control_plane">Configuring Network Interface Bonding for Control Plane</h4>
<div class="paragraph">
<p>Network interface bonding (also known as NIC teaming) can be configured for the control plane
network to provide redundancy and increased throughput. The bonding configuration is specified
in the <code>baremetalSetTemplate</code> section using the <code>ctlplaneBond</code> field.</p>
</div>
<div class="paragraph">
<p>The bonding configuration includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bondInterfaces</code> - List of physical interfaces to bond (minimum 2 interfaces required)</p>
</li>
<li>
<p><code>bondMode</code> - Bonding mode to use (default: "active-backup")</p>
</li>
<li>
<p><code>bondOptions</code> - Additional bonding options as key-value pairs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Supported bonding modes include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>active-backup</code> - Only one interface is active at a time for fault tolerance</p>
</li>
<li>
<p><code>802.3ad</code> - IEEE 802.3ad Dynamic link aggregation (LACP)</p>
</li>
<li>
<p><code>balance-rr</code> - Round-robin policy for load balancing</p>
</li>
<li>
<p><code>balance-xor</code> - XOR policy for load balancing</p>
</li>
<li>
<p>Other modes supported by cloud-init</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example configuration with bonding:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm
spec:
  baremetalSetTemplate:
    bmhLabelSelector:
      app: openstack
      workload: compute
    ctlplaneInterface: bond0
    ctlplaneBond:
      bondInterfaces:
        - eno1
        - eno2
      bondMode: "802.3ad"
      bondOptions:
        bond-miimon: "100"
        bond-xmit-hash-policy: "layer3+4"
    cloudUserName: cloud-admin
  nodes:
    edpm-compute-0:
      hostName: edpm-compute-0</pre>
</div>
</div>
<div class="paragraph">
<p>When bonding is configured, the <code>ctlplaneInterface</code> should be set to the bond interface name
(e.g., <code>bond0</code>), and the physical interfaces specified in <code>bondInterfaces</code> will be configured
as members of the bond during node provisioning.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_custom_os_images_with_provision_server">Using custom OS Images with Provision Server</h4>
<div class="paragraph">
<p>This assumes you have already built a qcow2 image with all the required packages for EDPM
deployment. For instructions on building custom images, refer to the
<a href="https://github.com/openstack-k8s-operators/edpm-image-builder">edpm-image-builder</a>.</p>
</div>
<div class="paragraph">
<p>By default, OpenStackBaremetalSet automatically creates an <code>OpenStackProvisionServer</code> per
nodeset to serve the bundled OS image for node provisioning. You can also use a custom provision
server with a different OS image.</p>
</div>
<div class="paragraph">
<p>To use a custom OS image, you must first package your qcow2 image as a container image.
The packaging process is the same for all approaches described below.</p>
</div>
<div class="sect4">
<h5 id="_packaging_your_custom_qcow2_image">Packaging Your Custom qcow2 Image</h5>
<div class="sect5">
<h6 id="_container_image_requirements">Container Image Requirements</h6>
<div class="paragraph">
<p>The container image used for <code>osContainerImageUrl</code> must:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Contain the qcow2 disk image file and its checksum file</p>
</li>
<li>
<p>Have an entrypoint script (like <code>copy_out.sh</code>) that copies the qcow2 file to the directory
specified by the <code>DEST_DIR</code> environment variable</p>
</li>
<li>
<p>Exit successfully after copying the file (it runs as an init container)</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="_building_a_container_image_from_an_existing_qcow2">Building a Container Image from an Existing qcow2</h6>
<div class="paragraph">
<p>If you have an existing qcow2 image, you can package it using the <code>copy_out.sh</code> script from
the <a href="https://github.com/openstack-k8s-operators/edpm-image-builder">edpm-image-builder</a>
repository.</p>
</div>
<div class="sect6">
<h7 id="_step_1_generate_checksum_file">Step 1: Generate Checksum File</h7>
<div class="paragraph">
<p><strong>Required:</strong> Create a checksum file for your qcow2 image. The provision server requires a
checksum file to function properly - the checksum discovery agent will fail if no checksum
file is found. The provision server supports MD5, SHA256, or SHA512 checksums. The checksum
file must contain the hash type in its filename (e.g., <code>md5</code>, <code>sha256</code>, or <code>sha512</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh"># For SHA256 (recommended)
sha256sum my-custom-image.qcow2 &gt; my-custom-image.qcow2.sha256sum

# Or for MD5
md5sum my-custom-image.qcow2 &gt; my-custom-image.qcow2.md5sum

# Or for SHA512
sha512sum my-custom-image.qcow2 &gt; my-custom-image.qcow2.sha512sum</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_step_2_clone_the_repository">Step 2: Clone the Repository</h7>
<div class="paragraph">
<p>Clone the edpm-image-builder repository to get the <code>copy_out.sh</code> script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">git clone https://github.com/openstack-k8s-operators/edpm-image-builder.git
cd edpm-image-builder</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_step_3_create_containerfile">Step 3: Create Containerfile</h7>
<div class="paragraph">
<p>Create a <code>Containerfile</code> (or <code>Dockerfile</code>) in the same directory. Copy both your qcow2 image
and its checksum file (checksum is required):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-dockerfile hljs" data-lang="dockerfile">FROM registry.access.redhat.com/ubi9/ubi-minimal:9.6

# Copy your qcow2 image and checksum file into the container
# The copy_out.sh script expects files in the root directory (/) by default
COPY my-custom-image.qcow2 /
COPY my-custom-image.qcow2.sha256sum /

# Copy the copy_out.sh script from the repository
COPY copy_out.sh /copy_out.sh
RUN chmod +x /copy_out.sh

ENTRYPOINT ["/copy_out.sh"]</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>my-custom-image.qcow2</code> with your actual qcow2 filename</p>
</li>
<li>
<p>Replace <code>my-custom-image.qcow2.sha256sum</code> with your checksum filename (must contain <code>md5</code>,
<code>sha256</code>, or <code>sha512</code> in the filename to be detected by the provision server)</p>
</li>
<li>
<p>The files are copied to <code>/</code> (root directory) because <code>copy_out.sh</code> expects to find them
there by default (the default <code>SRC_DIR</code> is <code>/</code>). You can set <code>ENV SRC_DIR=&lt;path&gt;</code> in your
Containerfile if you want to use a different source directory.</p>
</li>
<li>
<p>The <code>copy_out.sh</code> script handles both compressed (<code>.qcow2.gz</code>) and uncompressed (<code>.qcow2</code>)
images</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_step_4_build_and_push">Step 4: Build and Push</h7>
<div class="paragraph">
<p>Build and push the container image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">buildah bud -f Containerfile -t &lt;your-registry&gt;/my-custom-os-image:latest
buildah push &lt;your-registry&gt;/my-custom-os-image:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or using podman/docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">podman build -f Containerfile -t &lt;your-registry&gt;/my-custom-os-image:latest
podman push &lt;your-registry&gt;/my-custom-os-image:latest</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_using_the_custom_os_image">Using the Custom OS Image</h5>
<div class="paragraph">
<p>After packaging your custom qcow2 image as a container image, you can use it with one of the
following approaches:</p>
</div>
<div class="sect5">
<h6 id="_using_openstackversion_cr_recommended">Using OpenStackVersion CR (Recommended)</h6>
<div class="paragraph">
<p>To use a custom OS image across multiple nodesets while maintaining centralized version
management, you can patch the <code>OpenStackVersion</code> CR with the custom image in
<code>customContainerImages</code>. This allows all nodesets to use the same custom image without
specifying the container image URL individually in each nodeset.</p>
</div>
<div class="paragraph">
<p><strong>Tip:</strong> If you name your qcow2 image <code>edpm-hardened-uefi.qcow2</code> (the default osImage name)
, you can avoid having to specify the <code>osImage</code> field in every nodeset.</p>
</div>
<div class="paragraph">
<p>Otherwise, you will need to specify the <code>osImage</code> field with your custom image name in each
nodeset.</p>
</div>
<div class="paragraph">
<p>Patch the <code>OpenStackVersion</code> CR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">oc patch openstackversion openstack --type='merge' -p='
spec:
  customContainerImages:
    osContainerImage: &lt;your-registry&gt;/my-custom-os-image:latest
'</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_using_oscontainerimageurl_in_baremetalsettemplate">Using osContainerImageUrl in baremetalSetTemplate</h6>
<div class="paragraph">
<p>It is also possible to specify <code>osContainerImageUrl</code> directly in the <code>baremetalSetTemplate</code>
of your <code>OpenStackDataPlaneNodeSet</code>, this approach requires updating each nodeset individually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm
spec:
  baremetalSetTemplate:
    bmhLabelSelector:
      app: openstack
      workload: compute
    ctlplaneInterface: enp1s0
    cloudUserName: cloud-admin
    osImage: my-custom-image.qcow2
    osContainerImageUrl: &lt;your-registry&gt;/my-custom-os-image:latest
  nodes:
    edpm-compute-0:
      hostName: edpm-compute-0</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_creating_a_custom_openstackprovisionserver">Creating a Custom OpenStackProvisionServer</h6>
<div class="paragraph">
<p>You can also create a dedicated <code>OpenStackProvisionServer</code> resource. Note that this requires
specifying the provision server in each nodeset. This approach allows you to use the same
provision server for multiple nodesets and avoid exhausting available host ports, since each
auto-created provision server uses a host port.</p>
</div>
<div class="paragraph">
<p>After building and pushing your container image (as described in the packaging section above),
create the <code>OpenStackProvisionServer</code> resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: baremetal.openstack.org/v1beta1
kind: OpenStackProvisionServer
metadata:
  name: openstackprovisionserver
spec:
  interface: enp1s0
  port: 6190
  osImage: my-custom-image.qcow2  # qcow2 file inside the container
  osContainerImageUrl: &lt;your-registry&gt;/my-custom-os-image:latest
  apacheImageUrl: registry.redhat.io/ubi9/httpd-24:latest
  agentImageUrl: quay.io/openstack-k8s-operators/openstack-baremetal-operator-agent:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then reference this provision server in your <code>OpenStackDataPlaneNodeSet</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: example-nodeset
spec:
  baremetalSetTemplate:
    provisionServerName: openstackprovisionserver
    osImage: my-custom-image.qcow2
    deploymentSSHSecret: custom-ssh-secret
    ctlplaneInterface: enp1s0
  nodes:
    edpm-compute-0:
      hostName: edpm-compute-0</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_relevant_status_condition">Relevant Status Condition</h5>
<div class="paragraph">
<p><code>NodeSetBaremetalProvisionReady</code> condition in status condtions reflects the status of
baremetal provisioning as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get openstackdataplanenodeset openstack-edpm-ipam -o json | jq '.status.conditions[] | select(.type=="NodeSetBaremetalProvisionReady")'
{
  "lastTransitionTime": "2024-02-01T04:41:58Z",
  "message": "NodeSetBaremetalProvisionReady ready",
  "reason": "Ready",
  "status": "True",
  "type": "NodeSetBaremetalProvisionReady"
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc_deploying-the-data-plane_dataplane">Deploying the data plane</h3>
<div class="paragraph _abstract">
<p>You use the <code>OpenStackDataPlaneDeployment</code> CRD to configure the services on the data plane nodes and deploy the data plane. Create an <code>OpenStackDataPlaneDeployment</code> custom resource (CR) that deploys each of your <code>OpenStackDataPlaneNodeSet</code> CRs.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <code>OpenStackDataPlaneDeployment</code> CR and save it to a file named <code>openstack-edpm-deploy.yaml</code> on your workstation.</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: edpm-deployment-ipam
spec:
  nodeSets:
    - openstack-edpm-ipam
    - &lt;nodeSet_name&gt;
    - ...
    - &lt;nodeSet_name&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;nodeSet_name&gt;</code> with the names of the <code>OpenStackDataPlaneNodeSet</code> CRs that you want to include in your data plane deployment.</p>
</li>
<li>
<p>You can optionally provide  <code>ansibleJobNodeSelector</code> to run the ansible jobs
on specific set of OCP worker nodes. For example, worker nodes with
<code>ctlplane</code> network, as ansible jobs require <code>ctlplane</code> NAD.
The <code>ansibleJobNodeSelector</code> field contains key/value pairs that a node&#8217;s
labels must match in order to be selected to run the job.</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: edpm-deployment-ipam
spec:
  nodeSets:
    - openstack-edpm-ipam
    - &lt;nodeSet_name&gt;
    - ...
    - &lt;nodeSet_name&gt;
  ansibleJobNodeSelector:
    nodeWith: ctlplane</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Save the <code>openstack-edpm-deploy.yaml</code> deployment file.</p>
</li>
<li>
<p>Deploy the data plane:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc create -f openstack-edpm-deploy.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>You can view the Ansible logs while the deployment executes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc get pod -l app=openstackansibleee -w
$ oc logs -l app=openstackansibleee -f --max-log-requests 20</pre>
</div>
</div>
</li>
<li>
<p>Verify that the data plane is deployed:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackdataplanedeployment
NAME             	STATUS   MESSAGE
edpm-deployment-ipam   True     Setup Complete


$ oc get openstackdataplanenodeset
NAME             	STATUS   MESSAGE
openstack-edpm-ipam   True     NodeSet Ready</pre>
</div>
</div>
<div class="paragraph">
<p>For information on the meaning of the returned status, see <a href="#ref_data-plane-conditions-and-states_dataplane">Data plane conditions and states</a>.</p>
</div>
<div class="paragraph">
<p>If the status indicates that the data plane has not been deployed, then troubleshoot the deployment. For information, see <a href="#proc_troubleshooting-data-plane-creation-and-deployment_dataplane">Troubleshooting the data plane creation and deployment</a>.</p>
</div>
</li>
<li>
<p>Map the Compute nodes to the Compute cell that they are connected to:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc rsh nova-cell0-conductor-0 nova-manage cell_v2 discover_hosts --verbose</pre>
</div>
</div>
<div class="paragraph">
<p>If you did not create additional cells, this command maps the Compute nodes to <code>cell1</code>.</p>
</div>
</li>
<li>
<p>Access the remote shell for the <code>openstackclient</code> pod and verify that the deployed Compute nodes are visible on the control plane:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc rsh -n openstack openstackclient
$ openstack hypervisor list</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_persistent_logs">Persistent logs</h3>
<div class="paragraph">
<p>For enabling persistent logging:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a <a href="https://docs.openshift.com/container-platform/4.14/storage/understanding-persistent-storage.html#persistent-volumes_understanding-persistent-storage">PersistentVolume</a> and a <a href="https://docs.openshift.com/container-platform/4.14/storage/understanding-persistent-storage.html#persistent-volume-claims_understanding-persistent-storage">PersistentVolumeClaim</a></p>
</li>
<li>
<p>Mount <code>/runner/artifacts</code> into the PersistentVolume through <code>extraMounts</code> field</p>
</li>
</ol>
</div>
<h6 id="_example" class="discrete">Example:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
spec:
  ...
  nodeTemplate:
    extraMounts:
      - extraVolType: Logs
        volumes:
        - name: ansible-logs
          persistentVolumeClaim:
            claimName: &lt;PersistentVolumeClaim name&gt;
        mounts:
        - name: ansible-logs
          mountPath: "/runner/artifacts"</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_accessing_the_logs">Accessing the logs</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Query for pods with the OpenStackAnsibleEE label</p>
<div class="literalblock">
<div class="content">
<pre>oc get pods -l app=openstackansibleee</pre>
</div>
</div>
<div class="paragraph">
<p>Sample output:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>configure-network-edpm-compute-j6r4l   0/1     Completed           0          3m36s
validate-network-edpm-compute-6g7n9    0/1     Pending             0          0s
validate-network-edpm-compute-6g7n9    0/1     ContainerCreating   0          11s
validate-network-edpm-compute-6g7n9    1/1     Running             0          13s</pre>
</div>
</div>
</li>
<li>
<p>SSH into a pod</p>
<div class="paragraph">
<p>When a pod is running:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc rsh validate-network-edpm-compute-6g7n9</pre>
</div>
</div>
<div class="paragraph">
<p>When a pod is <strong>not</strong> running:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc debug configure-network-edpm-compute-j6r4l</pre>
</div>
</div>
</li>
<li>
<p>List the directories under <code>/runner/artifacts</code></p>
<div class="literalblock">
<div class="content">
<pre>ls /runner/artifacts</pre>
</div>
</div>
<div class="paragraph">
<p>Sample output:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>configure-network-edpm-compute
validate-network-edpm-compute</pre>
</div>
</div>
</li>
<li>
<p>Get the stdout of the desired artifact</p>
<div class="literalblock">
<div class="content">
<pre>cat /runner/artifacts/configure-network-edpm-compute/stdout</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc_troubleshooting-data-plane-creation-and-deployment_dataplane">Troubleshooting data plane creation and deployment</h3>
<div class="paragraph _abstract">
<p>Each data plane deployment in the environment has associated services. Each of these services have a job condition message that matches to the current status of the AnsibleEE job executing for that service. This information can be used to troubleshoot deployments when services are not deploying or operating correctly.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Determine the name and status of all deployments:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackdataplanedeployment</pre>
</div>
</div>
<div class="paragraph">
<p>The following example output shows two deployments currently in progress:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackdataplanedeployment

NAME                   NODESETS             STATUS   MESSAGE
openstack-edpm-ipam1   ["openstack-edpm"]   False    Deployment in progress
openstack-edpm-ipam2   ["openstack-edpm"]   False    Deployment in progress</pre>
</div>
</div>
</li>
<li>
<p>Determine the name and status of all services and their job condition:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackansibleee</pre>
</div>
</div>
<div class="paragraph">
<p>The following example output shows all services and their job condition for all current deployments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackansibleee

NAME                             NETWORKATTACHMENTS   STATUS   MESSAGE
bootstrap-openstack-edpm         ["ctlplane"]         True     Job completed
download-cache-openstack-edpm    ["ctlplane"]         False    Job in progress
repo-setup-openstack-edpm        ["ctlplane"]         True     Job completed
validate-network-another-osdpd   ["ctlplane"]         False    Job in progress</pre>
</div>
</div>
</li>
<li>
<p>Filter for the name and service for a specific deployment:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackansibleee -l openstackdataplanedeployment=&lt;deployment_name&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;deployment_name&gt;</code> with the name of the deployment to use to filter the services list.</p>
<div class="paragraph">
<p>The following example filters the list to only show services and their job condition for the <code>openstack-edpm-ipam1</code> deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackansibleee -l openstackdataplanedeployment=openstack-edpm-ipam1

NAME                            NETWORKATTACHMENTS   STATUS   MESSAGE
bootstrap-openstack-edpm        ["ctlplane"]         True     Job completed
download-cache-openstack-edpm   ["ctlplane"]         False    Job in progress
repo-setup-openstack-edpm       ["ctlplane"]         True     Job completed</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Job Condition Messages</div>
<p>AnsibleEE jobs have an associated condition message that indicates the current state of the service job. This condition message is displayed in the <code>MESSAGE</code> field of the <code>oc get openstackansibleee</code> command output. Jobs return one of the following conditions when queried:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Job not started</code>: The job has not started.</p>
</li>
<li>
<p><code>Job in progress</code>: The job is currently running.</p>
</li>
<li>
<p><code>Job completed</code>: The job execution is complete.</p>
</li>
<li>
<p><code>Job error occured &lt;error_message&gt;</code>: The job execution stopped unexpectedly. The <code>&lt;error_message&gt;</code> is replaced with a specific error message.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To further investigate a service displaying a particular job condition message, use the command <code>oc logs job/&lt;service&gt;</code> to display the logs associated with that service. For example, to display the logs for the <code>repo-setup-openstack-edpm</code> service, use the command <code>oc logs job/repo-setup-openstack-edpm</code>.</p>
</div>
<div class="paragraph">
<div class="title">Check service pod status reports</div>
<p>During reconciliation of OpenStackDataPlaneDeployment resources, Kubernetes Pods associated with OpenStackAnsibleEE jobs are marked with label <code>openstackdataplanedeployment=&lt;OpenStackDataPlaneDeployment.Name&gt;</code>.
This allows selection and monitoring of these pods using CLI commands.</p>
</div>
<div class="paragraph">
<p>When encountering failures within OpenStackAnsibleEE jobs, the resulting Kubernetes Pod reports will be formatted with an error message in the following manner: <code>openstackansibleee job &lt;POD_NAME&gt; failed due to &lt;ERROR&gt; with message: &lt;ERROR_MSG&gt;</code>.</p>
</div>
<div class="paragraph">
<p>These reports can provide valuable insights into the cause of the failure and aid in resolving related issues.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_an_openstackdataplanenodeset_with_internal_tls_enabled">Deploying an OpenStackDataPlaneNodeSet with Internal TLS Enabled</h3>
<div class="paragraph">
<p>When an OpenStackDataPlaneNodeSet is deployed with TLS Enabled, communications
between dataplane services and with control plane services can be encrypted using
TLS connections.</p>
</div>
<div class="paragraph">
<p>Functionality has been added to the openstack-operator to generate the needed
certificates for all compute nodes in the nodeset.  The details on how to enable
this functionality and how dataplane services (including custom services) can take
advantage of this functionality is provided here.</p>
</div>
<div class="paragraph">
<p>In addtion, an attribute has been added to the OpenStackDataplaneService spec to
allow a CACert TLS bundle to be provided.</p>
</div>
<div class="sect3">
<h4 id="_prerequisites_2">Prerequisites</h4>
<div class="paragraph">
<p>Certificates for dataplane services are generated by certmanager issuers, which are
referenced in the OpenStackDataplaneService attributes below.  These issuers must be
created beforehand.</p>
</div>
<div class="paragraph">
<p>In addition, OpenStackDataplaneService contains an attribute that allows the deployer
to specify a secret containing a TLS CA bundle.  This secret should also be created
beforehand.</p>
</div>
</div>
<div class="sect3">
<h4 id="_basic_deloyment_steps">Basic deloyment steps</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the issuers and cacert bundle secrets as described in the pre-requisites above.
These were likely created as part of the control plane deployment.
(TODO - link to issuer/cacert docs when available)</p>
</li>
<li>
<p>Enable TLS on the OpenStackDataPlaneNodeSet and create the nodeset.  Ensure that the
install-certs or similar service (described below) is in the list of services before
any services that require certs.</p>
</li>
<li>
<p>Deploy the OpenStackDataPlane.  Certs should be created and copied to the compute nodes
in the nodeset.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_enabling_tls_on_an_openstackdataplanenodeset">Enabling TLS on an OpenStackDataPlaneNodeSet</h4>
<div class="paragraph">
<p>The OpenstackDataPlaneNodeSet has an attribute tlsEnabled, which defaults to false.
The certficate generation code will be executed only if this attribute is set to true.</p>
</div>
</div>
<div class="sect3">
<h4 id="_openstackdataplaneservice_attributes">OpenStackDataplaneService attributes</h4>
<div class="paragraph">
<p>Certificate generation is controlled by several attributes in the OpenstackDataplaneService
specification.  An example is provided below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: libvirt
spec:
  label: libvirt
  playbook: osp.edpm.libvirt
  tlsCerts:
    default:
      contents:
        - dnsnames
        - ips
      networks:
        - CtlPlane
      keyUsages:
        - digital signature
        - key encipherment
        - server auth
        - client auth
      issuer: osp-rootca-issuer-internal
  caCerts: combined-ca-bundle</pre>
</div>
</div>
<div class="paragraph">
<p>A more minimal configuration is provided below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: service1
spec:
  label: service1
  playbook: osp.edpm.service1
  tlsCerts:
    default:
      contents:
        - dnsnames
  caCerts: combined-ca-bundle</pre>
</div>
</div>
<div class="sect4">
<h5 id="_cacerts">caCerts</h5>
<div class="paragraph">
<p>This optional attribute is a string pointing to the secret containing the TLS CA certificate
bundle to be mounted for the dataplane service.  This secret is expected to be created in
the same namespace (default: openstack) beforehand.</p>
</div>
</div>
<div class="sect4">
<h5 id="_tlscerts">tlsCerts</h5>
<div class="paragraph">
<p>Not all dataplane services will require TLS certificates.  For example, dataplane services
that install the OS or download caches do not need TLS certificates.</p>
</div>
<div class="paragraph">
<p>tlsCerts is a map of certificates to be generated for the service.  By convention, the
default pre-defined services use "default" as the hash key if only one service is needed, but this
is not required.  Ultimately, the hash key will be part of the path where the cert is located.</p>
</div>
<div class="paragraph">
<p>Most services will only require one certificate.  Some though, like libvirt, may require
more than one certificate.</p>
</div>
<div class="paragraph">
<p>If tlsCerts is defined (and tlsEnabled is set on the nodeset), certs will be generated as
prescribed by the following attributes:</p>
</div>
<div class="sect5">
<h6 id="_contents">contents</h6>
<div class="paragraph">
<p>This attribute describes what information is included in the subject alternative names (SAN)
in the certificate.  At this time, only two values are possible ("dnsnames" and "ips").
In the libvirt example, both attributes are added.  This attribute is required.</p>
</div>
</div>
<div class="sect5">
<h6 id="_networks">networks</h6>
<div class="paragraph">
<p>This attribute describes which networks will be added to the SAN.  For instance, in the libvirt
example configuration, the DNSName and IPAdress for the node on the Ctlplane will be added to the SAN.
If networks is not defined, the relevant contents for all networks will be added to the SAN.
So, in the configuration for service1 above, dns names for all networks on the node are added
to the SAN.</p>
</div>
</div>
<div class="sect5">
<h6 id="_issuer">issuer</h6>
<div class="paragraph">
<p>This attribute corresponds to the label for the certmanager issuer that is used to issue the certificate.
The label can be different from the name of the issuer. There can be only one issuer with the specified label.
If more than one issuer has the label, an error is generated. If the issuers attribute is not set, as in the
configuration for <code>service1</code>, the certificates are issued with the default root CA for internal TLS as defined
in <code>lib-common</code>, which is set to the label "osp-rootca-issuer-internal" for the <code>rootca-internal</code> issuer.</p>
</div>
</div>
<div class="sect5">
<h6 id="_keyusages">keyUsages</h6>
<div class="paragraph">
<p>This attribute is a list of key uages to be included as key usage extensions in the certificate.  The
strings that correspond to valid usages are provided by the <a href="https://github.com/cert-manager/cert-manager/pkg/apis/certmanager/v1/types.go">certmanage api</a>.
If this attribute is not provided, the default set of key usages as defined in <a href="https://github.com/openstack-k8s-operators/lib-common/blob/main/modules/certmanager/certificate.go">lib-common</a>.
will be used.  These are "key encipherment", "digital signature" and "server auth".  In the above examples, we
see that libvirt defines this attribute because the "client auth" key usage is also needed.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_addcertmounts">addCertMounts</h5>
<div class="paragraph">
<p>This attribute specifies whether or not to mount the certificates and keys generated for all
dataplane services (for all nodes in the nodeset) in the ansible EE pod for the service.
This attribute defaults to false.</p>
</div>
<div class="paragraph">
<p>The current design has a special dataplane service "install-certs" that is expected to run before
any services that need certificates, and which has this attribute set to true.  The purpose of this
dataplane service is to copy the certs to the correct place on the compute nodes.  This dataplane
service is described in more detail below.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_gritty_details">The gritty details</h4>
<div class="sect4">
<h5 id="_how_the_certificates_are_generated">How the certificates are generated</h5>
<div class="paragraph">
<p>When tlsEnabled is set to True on the nodeset, and tlsCerts is defined for the dataplane
service, certificates will be requested from the certmanager issuer designated in the issuer attribute
(or a default) as described above.</p>
</div>
<div class="paragraph">
<p>The contents of the certificate (subject name, subject alternative names, etc.) are defined using the
contents and issuer attributes as described above.</p>
</div>
<div class="paragraph">
<p>The certficates are generated when an OpenstackDataplaneDeployment is created, but before any ansible EE
pods are created.</p>
</div>
<div class="paragraph">
<p>When the certificates are created, certmanager stores the certificates in secrets which are named
"cert-&lt;service_name&gt;-&lt;hash_key&gt;-&lt;node_name&gt;-#".  The # symbol represents the secret number, beginning with 0.
Kubernetes distributions, such as Red Hat Openshift Platform, have a maximum secret size of 1 MiB. If the size
of the created certificates and keys is larger than the maximum size of a single secret, then multiple secrets
are created. Each secret receives its number and contains the certificate, key and cacert.</p>
</div>
<div class="paragraph">
<p>The certificates for all the nodes in the node set for a given service are collected in secrets named
"&lt;nodeset&gt;-&lt;service_name&gt;-&lt;hash_key&gt;-certs-#", where the <code>#</code> symbol represents the generated secret
number that starts at <code>0</code>.  These secrets are mounted in the ansibleEE when <code>addCertMounts</code> is enabled.</p>
</div>
</div>
<div class="sect4">
<h5 id="_how_the_certificates_are_transferred_to_the_compute_nodes">How the certificates are transferred to the compute nodes</h5>
<div class="paragraph">
<p>A dataplane service ("install-certs") has been added to added to copy over the certificates to the
compute nodes.  As noted above, this service has the addCertMounts attribute set to True.  It is expected
that this service will be executed before any other services that require TLS certs.</p>
</div>
<div class="paragraph">
<p>The service:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mounts the <code>&lt;nodeset&gt;-&lt;service_name&gt;-&lt;hash_key&gt;-certs-#</code> secrets for all services that have tlsCertsEnabled` set to "true".</p>
</li>
<li>
<p>For each node, calls the <code>osp.edpm.install_certs</code> role which copies all the certificates and keys for that node to
<code>/var/lib/openstack/certs/&lt;service_name&gt;/&lt;hash_key&gt;</code>.  The cacert bundles are copied to <code>/var/lib/openstack/cacerts/&lt;service_name&gt;</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Code should then be added to each service&#8217;s ansible role to use the certs as needed.  For example, in
libvirt&#8217;s role, we move the certs and keys to standard locations on the compute host.  Other roles may
mount the certs and keys into their containers using kolla or otherwise.  The certs and keys for all the
services are available as needed for all services.</p>
</div>
</div>
<div class="sect4">
<h5 id="_whats_happens_when_the_certificates_are_renewed">Whats happens when the certificates are renewed?</h5>
<div class="paragraph">
<p>The secrets that store the certificates and keys that are generated by certmanager (which are named
cert-&lt;service_name&gt;-&lt;hash_key&gt;_&lt;node_name&gt;) are owned by certmanager.  When they are created, they are labelled
using "osdp-service", "osdp-service-cert-key" and "osdpns" to indicate the dataplane service, hash key and nodeset
accordingly.</p>
</div>
<div class="paragraph">
<p>At the end of the deployment, these secrets are hashed and the values are stored in the secretHashes
status field of the nodeset and deployment.  In this way, these cert secrets are treated in exactly the
same way as any other dataplane service related secrets.</p>
</div>
<div class="paragraph">
<p>Certmanager will automatically renew certificates prior to their expiration, which will result in
modifications to the secrets.</p>
</div>
<div class="paragraph">
<p>The deployer can periodically review the hashes for these secrets to determine if any of them have
changed - this is currently expected to be a manual process - and then may choose to invoke a new
deployment to update the certificates and keys.</p>
</div>
</div>
<div class="sect4">
<h5 id="_how_to_enable_cert_generation_for_your_dataplane_service">How to enable cert generation for your dataplane service</h5>
<div class="paragraph">
<p>Based on the above description, the steps are pretty straightforward.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a tlsCerts attribute to your dataplane service.  Set the contents, networks and issuer according
to your needs.  The service1 configuration is a minimal specification and will provide a cert
with dnsNames for all the interfaces of the compute node in the SAN, issued by the internal TLS CA.
This is probably sufficient for most use cases.</p>
</li>
<li>
<p>Add a specification for a CACertBundle.  This attribute can be added to mount a CACert bundle even
if no cert generation is needed.</p>
</li>
<li>
<p>The "install-certs: service should run before your service.  It will copy the certs and cacerts
to a standard location.  See the section above.</p>
</li>
<li>
<p>Modify your role to do something with the generated certs.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scaling_the_dataplane">Scaling the DataPlane</h3>
<div class="sect3">
<h4 id="_scaling_out">Scaling Out</h4>
<div class="paragraph">
<p>Scale out of an existing dataplane with more edpm nodes can be achieved by adding new
nodes to the <code>nodes</code> section of the <code>OpenStackDataPlaneNodeSet</code> spec. Ensure that
there are enough BMHs in <code>Available</code> state in the required namespace with the desired
labels for baremetal nodes.</p>
</div>
<div class="literalblock">
<div class="title">Pre-Provisioned:</div>
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
spec:
  preProvisioned: True
  nodes:
  ...
    edpm-compute-2:
      hostName: edpm-compute-2
      ansible:
        ansibleHost: 192.168.122.102
      networks:
      - name: CtlPlane
        subnetName: subnet1
        defaultRoute: true
        fixedIP: 192.168.122.102
      - name: InternalApi
        subnetName: subnet1
      - name: Storage
        subnetName: subnet1
      - name: Tenant
        subnetName: subnet1
  ...</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Baremetal:</div>
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
spec:
  nodes:
  ...
    edpm-compute-2:
      hostName: edpm-compute-2
  ...</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
To deploy on the additional nodes, a <strong>new</strong> <code>OpenStackDataPlaneDeployment</code> CR should be
created with the <code>OpenStackDataPlaneNodeSet</code> in the <code>nodeSets</code> section.
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="title">New OpenStackDataPlaneDeployment:</div>
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: new-deployment # Do not re-use the name from previous OpenStackDataPlaneDeployment
spec:
 nodeSets:
   - openstack-edpm-ipam # scaled out nodeset name</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Before applying the <strong>new</strong> <code>OpenStackDataPlaneDeployment</code> CR, verify
if the <code>OpenStackDataPlaneNodeSet</code> in the <code>nodeSets</code> section has reached the <code>SetupReady</code> status.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc wait openstackdataplanenodeset openstack-edpm-ipam --for condition=SetupReady --timeout=10m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once deployment completes <code>OpenStackDataPlaneNodeSet</code> would be ready as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get openstackdataplanenodeset openstack-edpm-ipam
NAME                  STATUS   MESSAGE
openstack-edpm-ipam   True     NodeSet Ready</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the scaled out nodes are compute nodes, once the <code>OpenStackDataPlaneNodeSet</code> reaches
<code>NodeSet Ready</code>, <code>nova-manage cell_v2 discover_hosts</code> should be run to make the new
compute nodes show-up in hypervisor list and become usable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc rsh nova-cell0-conductor-0 nova-manage cell_v2 discover_hosts --verbose
Found 2 cell mappings.
Skipping cell0 since it does not contain hosts.
Getting computes from cell 'cell1': 75f666d2-922d-45af-8bdb-d897a1bc9b1c
Checking host mapping for compute host 'edpm-compute-2': 6afda7af-2953-4400-842c-a327a0e43a74
Creating host mapping for compute host 'edpm-compute-2': 6afda7af-2953-4400-842c-a327a0e43a74
Found 1 unmapped computes in cell: 75f666d2-922d-45af-8bdb-d897a1bc9b1c

$ oc rsh openstackclient openstack hypervisor list
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+
| ID                                   | Hypervisor Hostname                 | Hypervisor Type | Host IP         | State |
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+
| cc05372a-27bd-4b33-985e-b0009c9e515e | edpm-compute-1.ctlplane.example.com | QEMU            | 192.168.221.101 | up    |
| 5e3f7b5d-39fd-430c-80d1-084086bdccde | edpm-compute-0.ctlplane.example.com | QEMU            | 192.168.221.100 | up    |
| 6afda7af-2953-4400-842c-a327a0e43a74 | edpm-compute-2.ctlplane.example.com | QEMU            | 192.168.221.102 | up    |
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_scaling_out_with_different_configuration">Scaling Out with different configuration</h4>
<div class="paragraph">
<p>If the deployment needs to be scaled out to nodes that require different
configuration (e.g. different kernel args, network config, or openstack config)
compared to the configuration in the current <code>OpenStackDataPlaneNodeSet</code>
then the new nodes cannot be added to the existing <code>OpenStackDataPlaneNodeSet</code>
but a new <code>OpenStackDataPlaneNodeSet</code> needs to be created that contains the
new nodes and the new configuration for those nodes. Then a new
<code>OpenStackDataPlaneDeployment</code> needs to be created that points to <strong>both the
existing and the new <code>OpenStackDataPlaneNodeSets</code></strong> to trigger the scale out.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If only the new <code>OpenStackDataPlaneNodeSet</code> is included into the new
<code>OpenStackDataPlaneDeployment</code> then the scale out seems to succeed but will
be incomplete causing that VM move operations will fail between nodes
in the different <code>OpenStackDataPlaneNodeSets</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_scaling_in">Scaling In</h4>
<div class="paragraph">
<p>The procedure for removing edpm nodes from dataplane involves some manual cleanup steps
after evacuation of workload.</p>
</div>
<div class="paragraph">
<p>For edpm compute nodes removal following steps should be performed.</p>
</div>
<div class="sect4">
<h5 id="_disable_nova_compute_service">Disable nova-compute service</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc rsh openstackclient openstack compute service list
+--------------------------------------+----------------+------------------------+----------+---------+-------+----------------------------+
| ID                                   | Binary         | Host                   | Zone     | Status  | State | Updated At                 |
+--------------------------------------+----------------+------------------------+----------+---------+-------+----------------------------+
| 11105d9b-9ef7-4d6f-8d17-6eb8db175d76 | nova-conductor | nova-cell1-conductor-0 | internal | enabled | up    | 2024-02-01T03:59:42.000000 |
| 31e2ee14-a124-4e02-b11d-87c2cdca3c56 | nova-compute   | edpm-compute-1         | nova     | enabled | up    | 2024-02-01T03:59:38.000000 |
| bd031e6e-89d8-4839-b345-5f124ec4c07e | nova-compute   | edpm-compute-0         | nova     | enabled | up    | 2024-02-01T03:59:37.000000 |
| f70912f9-eaaa-4caa-906f-a38e20667af4 | nova-compute   | edpm-compute-2         | nova     | enabled | up    | 2024-02-01T03:59:38.000000 |
| 8a4622c3-0fb8-498a-81d8-a9c23c0be5fc | nova-conductor | nova-cell0-conductor-0 | internal | enabled | up    | 2024-02-01T03:59:37.000000 |
| 5ad386ec-ac2d-4238-a671-d9402432d326 | nova-scheduler | nova-scheduler-0       | internal | enabled | up    | 2024-02-01T03:59:38.000000 |
+--------------------------------------+----------------+------------------------+----------+---------+-------+----------------------------+

$ oc rsh openstackclient openstack compute service set edpm-compute-2 nova-compute --disable</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_stop_ovn_and_nova_compute_containers">Stop ovn and nova-compute containers</h5>
<div class="paragraph">
<p>ssh to the edpm node to be removed and stop the containers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ ssh -i out/edpm/ansibleee-ssh-key-id_rsa cloud-admin@192.168.221.102

[cloud-admin@edpm-compute-2 ~]$ sudo systemctl stop edpm_ovn_controller

[cloud-admin@edpm-compute-2 ~]$ sudo systemctl stop edpm_ovn_metadata_agent

[cloud-admin@edpm-compute-2 ~]$ sudo systemctl stop edpm_nova_compute</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_delete_network_agents">Delete network agents</h5>
<div class="paragraph">
<p>Delete the agents for the compute nodes to be removed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc rsh openstackclient openstack network agent list

+--------------------------------------+------------------------------+----------------+-------------------+-------+-------+----------------+
| ID                                   | Agent Type                   | Host           | Availability Zone | Alive | State | Binary         |
+--------------------------------------+------------------------------+----------------+-------------------+-------+-------+----------------+
| d2b9e5d0-a406-41c2-9bc3-e74aaf113450 | OVN Controller Gateway agent | worker-0       |                   | :-)   | UP    | ovn-controller |
| 9529e28e-522e-48f6-82e2-c5caf1cf5a14 | OVN Controller Gateway agent | worker-1       |                   | :-)   | UP    | ovn-controller |
| 91bd4981-1e81-4fe8-b628-8581add36f13 | OVN Controller agent         | edpm-compute-1 |                   | :-)   | UP    | ovn-controller |
| bdc1dd13-586f-4553-90d6-14348f6be150 | OVN Controller agent         | edpm-compute-0 |                   | :-)   | UP    | ovn-controller |
| f7bb5520-27df-470b-9566-0aa7e5fef583 | OVN Controller agent         | edpm-compute-2 |                   | :-)   | UP    | ovn-controller |
+--------------------------------------+------------------------------+----------------+-------------------+-------+-------+----------------+

$ oc rsh openstackclient openstack network agent delete f7bb5520-27df-470b-9566-0aa7e5fef583</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_delete_nova_compute_service">Delete nova-compute service</h5>
<div class="paragraph">
<p>Delete <code>nova-compute</code> service for the removed node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc rsh openstackclient openstack compute service delete f70912f9-eaaa-4caa-906f-a38e20667af4

$ oc rsh openstackclient openstack hypervisor list
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+
| ID                                   | Hypervisor Hostname                 | Hypervisor Type | Host IP         | State |
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+
| cc05372a-27bd-4b33-985e-b0009c9e515e | edpm-compute-1.ctlplane.example.com | QEMU            | 192.168.221.101 | up    |
| 5e3f7b5d-39fd-430c-80d1-084086bdccde | edpm-compute-0.ctlplane.example.com | QEMU            | 192.168.221.100 | up    |
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_patch_openstackdataplanenodeset_to_remove_node">Patch OpenStackDataPlaneNodeSet to remove node</h5>
<div class="paragraph">
<p>Once the cleanup is complete, patch <code>OpenStackDataPlaneNodeSet</code> CR to remove the
nodes from the <code>nodes</code> section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc patch openstackdataplanenodeset/openstack-edpm --type json --patch '[{ "op": "remove", "path": "/spec/nodes/edpm-compute-2" }]'
openstackdataplanenodeset.dataplane.openstack.org/openstack-edpm patched</code></pre>
</div>
</div>
<div class="paragraph">
<p>For baremetal provisioned node this would start de-provisioning the removed node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get bmh
NAME         STATE            CONSUMER              ONLINE   ERROR   AGE
compute-01   provisioned      openstack-edpm        true             2d21h
compute-02   provisioned      openstack-edpm        true             2d21h
compute-03   deprovisioning                         false            43h</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_scaling_in_by_removing_a_nodeset">Scaling In by removing a NodeSet</h4>
<div class="paragraph">
<p>If a full <code>OpenStackDataPlaneNodeSet</code> has to be removed, steps mentioned
above to disable <code>nova-compute</code> services, stop the <code>ovn</code> and <code>nova-compute</code>
containers on nodes, delete network agents and delete <code>nova-compute</code> services
should be done for each compute. Finally the <code>OpenStackDataPlaneNodeSet</code> CR can
be deleted. If this <code>OpenStackDataPlaneNodeSet</code> is the only one listing the
<code>ssh-known-hosts</code> service, then this service needs to be added to one or more
of the remaining <code>OpenStackDataPlaneNodeSets</code>. To remove the ssh host keys of
the removed nodes of this <code>OpenStackDataPlaneNodeSet</code> from other nodes a new
<code>OpenStackDataPlaneDeployment</code> needs to be created that points to all the
remaining <code>OpenStackDataPlaneNodeSets</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ansibleee_runner_variables">AnsibleEE runner variables</h3>
<div class="paragraph">
<p>Number of variables can be used to modify behavior of the AnsibleEE runner
executing given job, such as timeouts and caching.
These are expanded in the <code>env/settings</code> <a href="https://github.com/openstack-k8s-operators/edpm-ansible/blob/main/openstack_ansibleee/settings">file</a>.
And further documented in Ansible Runner <a href="https://ansible.readthedocs.io/projects/runner/en/stable/intro/#env-settings-settings-for-runner-itself">docs</a>.</p>
</div>
<div class="paragraph">
<p>All of these variables are left set to sensible defaults, nevertheless, some changes may be necessary,
depending on particulars of individual deployments.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ansible_variables">Ansible variables</h3>
<div class="paragraph">
<p>The list of ansible variables that can be set under <code>ansibleVars</code> is extensive.
To understand what variables are available for each service, see the
documentation in the <a href="#create-openstackdataplaneservices">Create
OpenStackDataPlaneServices</a> section.</p>
</div>
<div class="paragraph">
<p>Common configurations that can be enabled with <code>ansibleVars</code> are also
documented at <a href="#common_configurations.adoc">Common Configurations</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the case of <code>ansibleVars</code>, the value is merged with that of the value from
the nodeTemplate. This makes it so that the entire value of <code>ansibleVars</code> from
the nodeTemplate does not need to be reproduced for each node just to set a few
node specific values.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_importing_ansible_variables">Importing ansible variables</h4>
<div class="paragraph">
<p><code>ansibleVarsFrom</code> allows you to set ansible variables for an <code>OpenStackDataPlaneNodeSet</code> by
referencing either a ConfigMap or a Secret. When you use <code>ansibleVarsFrom</code>, all the key-value
pairs in the referenced ConfigMap or Secret are set as environment variables for the <code>OpenStackDataPlaneNodeSet</code>.
You can also specify a common prefix string.</p>
</div>
<div class="paragraph">
<div class="title">Example:</div>
<p>Adding ansible variables from ConfigMap:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a ConfigMap containing the ansible variables</p>
<div class="literalblock">
<div class="content">
<pre>apiVersion: v1
kind: ConfigMap
metadata:
  name: common-edpm-vars
data:
  edpm_config_var1: value1
  edpm_config_var2: value2</pre>
</div>
</div>
</li>
<li>
<p>Update the <code>ansibleVarsFrom</code> with the ConfigMap name</p>
<div class="literalblock">
<div class="content">
<pre>ansibleVarsFrom:
  - configMapRef:
        name: common-edpm-vars</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Example:</div>
<p>Execute <code>subscription-manager register</code> from corresponding Secret</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a Secret containing the credentials</p>
<div class="literalblock">
<div class="content">
<pre>apiVersion: v1
kind: Secret
metadata:
  name: subscription-manager
data:
  username: &lt;base64 encoded username&gt;
  password: &lt;base64 encoded password&gt;</pre>
</div>
</div>
</li>
<li>
<p>Update the <code>ansibleVarsFrom</code> with the Secret name, and <code>ansibleVars</code> with the variables generated from the Secret</p>
<div class="literalblock">
<div class="content">
<pre>ansibleVarsFrom:
  - prefix: subscription_manager_
    secretRef:
      name: subscription-manager
ansibleVars:
    edpm_bootstrap_command: |
      subscription-manager register --username {{ subscription_manager_username }} --password {{ subscription_manager_password }}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Values defined by an ansibleVars with a duplicate key take precedence</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_common_configurations">Common Configurations</h3>
<div class="paragraph">
<p>This page documents some of the common configurations that can be enabled
through ansible variables. The ansible variables that affect the configuration
of the ansible executions are set in the <code>ansibleVars</code> field on the dataplane
resources.</p>
</div>
<div class="paragraph">
<p>The full set of ansible variables available for configuration are documented
within each role in the
<a href="https://github.com/openstack-k8s-operators/edpm-ansible/tree/main/roles">edpm-ansible</a>
repository.</p>
</div>
<div class="sect3">
<h4 id="_initial_bootstrap_command">Initial bootstrap command</h4>
<div class="paragraph">
<p><strong>Variable</strong>: <code>edpm_bootstrap_command</code>
<strong>Type</strong>: <code>string</code>
<strong>Role</strong>: <a href="https://github.com/openstack-k8s-operators/edpm-ansible/tree/main/roles/edpm_bootstrap">edpm_bootstrap</a></p>
</div>
<div class="paragraph">
<p>The <code>edpm_bootstrap_command</code> variable can be used to pass a shell command(s) that
will be executed as early as possible in the deployment as part of the
<code>configure-network</code> service. If the <code>services</code> list is customized with services
that execute prior to <code>configure-network</code> then the command(s) specified by
<code>edpm_bootstrap_command</code> would run after the custom services.</p>
</div>
<div class="paragraph">
<p>The string value for <code>edpm_bootstrap_command</code> is passed directly to the ansible
<a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html">shell</a>.
As such, when using multiple shell commands, the <code>|</code> character must be used to
preserve new lines in the <code>YAML</code> value:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>edpm_bootstrap_command: |
    command 1
    command 2
    etc.</pre>
</div>
</div>
<div class="sect4">
<h5 id="_using_edpm_bootstrap_command_for_system_registration">Using <code>edpm_bootstrap_command</code> for system registration</h5>
<div class="paragraph">
<p><code>edpm_bootstrap_command</code> can be used to perform system registration in order to
enable needed package repositories. Choose a registration method (either Portal
or Satellite) and refer to the provided links below for instructions to create
the registration commands.</p>
</div>
<div class="sect5">
<h6 id="_red_hat_customer_portal_registration">Red Hat Customer Portal registration</h6>
<div class="paragraph">
<p>The registration commands for the Red Hat Customer Portal are documented at
<a href="https://access.redhat.com/solutions/253273" class="bare">https://access.redhat.com/solutions/253273</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_red_hat_satellite_registration">Red Hat Satellite registration</h6>
<div class="paragraph">
<p>The registration commands for Red Hat Satellite version 6.13 are documented at
<a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.13/html-single/managing_hosts/index#Registering_Hosts_to_Server_managing-hosts" class="bare">https://access.redhat.com/documentation/en-us/red_hat_satellite/6.13/html-single/managing_hosts/index#Registering_Hosts_to_Server_managing-hosts</a>.</p>
</div>
<div class="paragraph">
<p>If not using Satellite version 6.13, then refer to the specific version of the
documentation for the version of Satellite that is in use.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_using_edpm_bootstrap_command_for_configuring_system_proxy_settings">Using <code>edpm_bootstrap_command</code> for configuring system proxy settings</h5>
<div class="paragraph">
<p><code>edpm_bootstrap_command</code> can be used to configure system proxy settings by
adding the proxy environment variables to <code>/etc/environment</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>edpm_bootstrap_command: |
    cat &gt;&gt;/etc/environment &lt;&lt;EOF
    http_proxy="http://USERNAME:PASSWORD@proxy-server.example.com:3128/"
    https_proxy="http://USERNAME:PASSWORD@proxy-server.example.com:3128/"
    no_proxy="localhost,127.0.0.1,::1" # Add any hosts to bypass the proxy
    EOF</pre>
</div>
</div>
<div class="paragraph">
<p>Note that these variable values won&#8217;t always apply to tasks executed by
ansible. To ensure ansible tasks always use a proxy, create the
<code>edpm_playbook_environment</code> secret and reference it on the
<code>OpenStackDataPlaneNodeSet</code> as shown in
xref:proc_creating-a-set-of-data-plane-nodes.adoc.</p>
</div>
</div>
<div class="sect4">
<h5 id="_customizing_container_image_locations">Customizing container image locations</h5>
<div class="paragraph">
<p>The container images used by the various roles from edpm-ansible can pull from
customized locations. The ansible variables used to set the locations and their
default values are:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>edpm_iscsid_image: "quay.io/podified-antelope-centos9/openstack-iscsid
edpm_logrotate_crond_image: "quay.io/podified-antelope-centos9/openstack-cron
edpm_ovn_controller_agent_image: "quay.io/podified-antelope-centos9/openstack-ovn-controller
edpm_frr_image: "quay.io/podified-antelope-centos9/openstack-frr
edpm_ovn_bgp_agent_image: "quay.io/podified-antelope-centos9/openstack-ovn-bgp-agent
edpm_ovn_bgp_agent_local_ovn_nb_db_image: "quay.io/podified-antelope-centos9/openstack-ovn-nb-db-server
edpm_ovn_bgp_agent_local_ovn_sb_db_image: "quay.io/podified-antelope-centos9/openstack-ovn-sb-db-server
edpm_ovn_bgp_agent_local_ovn_northd_image: "quay.io/podified-antelope-centos9/openstack-ovn-northd
edpm_ovn_bgp_agent_local_ovn_controller_image: "quay.io/podified-antelope-centos9/openstack-ovn-controller
edpm_telemetry_node_exporter_image: quay.io/prometheus/node-exporter
edpm_telemetry_kepler_image: "quay.io/sustainable_computing_io/kepler"
edpm_telemetry_ceilometer_compute_image: quay.io/podified-antelope-centos9/openstack-ceilometer-compute
edpm_telemetry_ceilometer_ipmi_image: quay.io/podified-antelope-centos9/openstack-ceilometer-ipmi
edpm_nova_compute_image: "quay.io/podified-antelope-centos9/openstack-nova-compute
edpm_neutron_sriov_image: "quay.io/podified-antelope-centos9/openstack-neutron-sriov-agent
edpm_multipathd_image: "quay.io/podified-antelope-centos9/openstack-multipathd
edpm_neutron_dhcp_image: "quay.io/podified-antelope-centos9/openstack-neutron-dhcp-agent
edpm_neutron_metadata_agent_image: "quay.io/podified-antelope-centos9/openstack-neutron-metadata-agent-ovn
edpm_neutron_ovn_agent_image: "quay.io/podified-antelope-centos9/openstack-neutron-ovn-agent
edpm_swift_proxy_image: "quay.io/podified-antelope-centos9/openstack-swift-proxy-server
edpm_swift_account_image: "quay.io/podified-antelope-centos9/openstack-swift-account
edpm_swift_container_image: "quay.io/podified-antelope-centos9/openstack-swift-container
edpm_swift_object_image: "quay.io/podified-antelope-centos9/openstack-swift-object</pre>
</div>
</div>
<div class="paragraph">
<p>Set any of the above ansible variables within the <code>ansibleVars</code> sections of
<code>OpenStackDataPlaneNodeSet</code> to customize the container image locations.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_network_isolation">Network Isolation</h4>
<div class="paragraph">
<p>Network Isolation refers to the practice of separating network traffic by
function, and configuring the networks on dataplane nodes. Nodes will need
connectivity to various control plane services running on OCP. These services
may be bound to different networks. Each of those networks needs to be
configured as required on dataplane nodes.</p>
</div>
<div class="paragraph">
<p>For further details on the network architecture of the control plane, see
<a href="https://github.com/openstack-k8s-operators/docs/blob/main/networking.md" class="bare">https://github.com/openstack-k8s-operators/docs/blob/main/networking.md</a>.</p>
</div>
<div class="sect4">
<h5 id="_configuring_networking_with_edpm_network_config">Configuring networking with edpm_network_config</h5>
<div class="paragraph">
<p>The
<a href="https://github.com/openstack-k8s-operators/edpm-ansible/tree/main/roles/edpm_network_config">edpm_network_config</a>
ansible role is responsible for configuring networking on dataplane nodes.</p>
</div>
<div class="paragraph">
<p>The <code>edpm_network_config_template</code> variable specifies the contents of a jinja2
template that describes the networking configuration to be applied. The
template itself also contains variables that can be used to customize the
networking configuration for a specific node (IP addresses, interface names,
routes, etc). See template examples provided in the nic-config-samples directory:
<a href="https://github.com/openstack-k8s-operators/openstack-operator/tree/main/config/samples/nic-config-samples" class="bare">https://github.com/openstack-k8s-operators/openstack-operator/tree/main/config/samples/nic-config-samples</a>.</p>
</div>
<div class="paragraph">
<p>These samples can be used inline within the <code>OpenStackDataPlaneNodeSet</code> CR
under then <code>ansibleVars</code> section (see our current sample files for examples
of the inline implementation).</p>
</div>
<div class="paragraph">
<p>The following is an example
<a href="#ansibleopts">ansibleVars</a>
field that shows defining the variables that configure the
<code>edpm_network_config</code> role.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ansibleVars:
  ctlplane_ip: 192.168.122.100
  internalapi_ip: 172.17.0.100
  storage_ip: 172.18.0.100
  tenant_ip: 172.19.0.100
  fqdn_internalapi: edpm-compute-0.example.com
  edpm_network_config_template: |
	 ---
	 {% set mtu_list = [ctlplane_mtu] %}
	 {% for network in nodeset_networks %}
	 {% set _ = mtu_list.append(lookup('vars', networks_lower[network] ~ '_mtu')) %}
	 {%- endfor %}
	 {% set min_viable_mtu = mtu_list | max %}
	 network_config:
	 - type: ovs_bridge
	 name: {{ neutron_physical_bridge_name }}
	 mtu: {{ min_viable_mtu }}
	 use_dhcp: false
	 dns_servers: {{ ctlplane_dns_nameservers }}
	 domain: {{ dns_search_domains }}
	 addresses:
	 - ip_netmask: {{ ctlplane_ip }}/{{ ctlplane_cidr }}
	 routes: {{ ctlplane_host_routes }}
	 members:
	 - type: interface
	 	name: nic1
	 	mtu: {{ min_viable_mtu }}
	 	# force the MAC address of the bridge to this interface
	 	primary: true
	 {% for network in nodeset_networks %}
	 - type: vlan
	 	mtu: {{ lookup('vars', networks_lower[network] ~ '_mtu') }}
	 	vlan_id: {{ lookup('vars', networks_lower[network] ~ '_vlan_id') }}
	 	addresses:
	 	- ip_netmask:
	 		{{ lookup('vars', networks_lower[network] ~ '_ip') }}/{{ lookup('vars', networks_lower[network] ~ '_cidr') }}
	 	routes: {{ lookup('vars', networks_lower[network] ~ '_host_routes') }}
	 {% endfor %}</pre>
</div>
</div>
<div class="paragraph">
<p>This configuration would be applied by the
<a href="#_dataplane_operator_provided_services">configure-network</a> service when
it&#8217;s executed.</p>
</div>
</div>
<div class="sect4">
<h5 id="_network_attachment_definitions">Network attachment definitions</h5>
<div class="paragraph">
<p>The
<a href="https://github.com/openstack-k8s-operators/docs/blob/main/networking.md#network-attachment-definitions"><code>NetworkAttachmentDefinition</code></a>
resource is used to describe how pods can be attached to different networks.
Network attachment definitions can be specified on the
<a href="#openstack_dataplanenodeset.adoc"><code>OpenStackDataPlaneNodeSet</code></a> resource using the
<code>NetworkAttachments</code> field.</p>
</div>
<div class="paragraph">
<p>The network attachments are used to describe which networks will be connected
to the pod that is running ansible-runner. They do not enable networks on the
dataplane nodes themselves. For example, adding the <code>internalapi</code> network
attachment to <code>NetworkAttachments</code> means the ansible-runner pod will be
connected to the <code>internalapi</code> network. This can enable scenarios where ansible
needs to connect to different networks.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interacting_with_ansible">Interacting with Ansible</h3>
<div class="paragraph">
<p>When a dataplane service is executed during a deployment, a corresponding
Kubernetes Job is created. This Kubernetes Job is the associated ansible
execution with the service.</p>
</div>
<div class="paragraph">
<p>During reconciliation a
<a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/job-v1/">Job</a>
resource is created which in turn creates a
<a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/">Pod</a> resource. The pod is started with an <a href="https://docs.ansible.com/automation-controller/latest/html/userguide/execution_environments.html">Ansible Execution Environment</a> image, and runs <a href="https://ansible.readthedocs.io/projects/runner/en/stable/">ansible-runner</a>.</p>
</div>
<div class="sect3">
<h4 id="_retrieving_and_inspecting_ansible_execution_jobs">Retrieving and inspecting Ansible Execution Jobs</h4>
<div class="paragraph">
<p>The Kubernetes jobs are labelled with the name of the <code>OpenStackDataPlaneDeployment</code>.
Jobs for each <code>OpenStackDataPlaneDeployment</code> can be seen by listing jobs by the label:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc get job -l openstackdataplanedeployment=edpm-compute
NAME                                                 STATUS     COMPLETIONS   DURATION   AGE
bootstrap-edpm-compute-openstack-edpm-ipam           Complete   1/1           78s        25h
configure-network-edpm-compute-openstack-edpm-ipam   Complete   1/1           37s        25h
configure-os-edpm-compute-openstack-edpm-ipam        Complete   1/1           66s        25h
download-cache-edpm-compute-openstack-edpm-ipam      Complete   1/1           64s        25h
install-certs-edpm-compute-openstack-edpm-ipam       Complete   1/1           46s        25h
install-os-edpm-compute-openstack-edpm-ipam          Complete   1/1           57s        25h
libvirt-edpm-compute-openstack-edpm-ipam             Complete   1/1           2m37s      25h
neutron-metadata-edpm-compute-openstack-edpm-ipam    Complete   1/1           61s        25h
nova-edpm-compute-openstack-edpm-ipam                Complete   1/1           3m20s      25h
ovn-edpm-compute-openstack-edpm-ipam                 Complete   1/1           78s        25h
run-os-edpm-compute-openstack-edpm-ipam              Complete   1/1           33s        25h
ssh-known-hosts-edpm-compute                         Complete   1/1           19s        25h
telemetry-edpm-compute-openstack-edpm-ipam           Complete   1/1           2m5s       25h
validate-network-edpm-compute-openstack-edpm-ipam    Complete   1/1           16s        25h</pre>
</div>
</div>
<div class="paragraph">
<p>Logs can be checked using <code>oc logs -f job/&lt;job-name&gt;</code>. For example, if we want to check the logs
from the configure-network job:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> $ oc logs -f jobs/configure-network-edpm-compute-openstack-edpm-ipam | tail -n2
PLAY RECAP *********************************************************************
edpm-compute-0             : ok=22   changed=0    unreachable=0    failed=0    skipped=17   rescued=0    ignored=0</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_controlling_the_ansible_execution">Controlling the Ansible execution</h4>
<div class="paragraph">
<p>For specifying the
ansible <a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_tags.html#selecting-or-skipping-tags-when-you-run-a-playbook">tags, skip-tags</a>,
and <a href="https://docs.ansible.com/ansible/latest/inventory_guide/intro_patterns.html#patterns-and-ad-hoc-commands">limit</a></p>
</div>
<div class="paragraph">
<p>The fields in OpenStackDataPlaneDeployment that correspond to these options are:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ansibleTags
ansibleSkipTags
ansibleLimit</pre>
</div>
</div>
<div class="paragraph">
<p>The syntax for these fields match the syntax that ansible accepts on the
command line for <code>ansible-playbook</code> and <code>ansible-runner</code> for each of these
fields.</p>
</div>
<div class="paragraph">
<p>Example usage of these fields:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: openstack-edpm
spec:
  ansibleTags: containers
  ansibleSkipTags: packages
  ansibleLimit: compute1*,compute2*</pre>
</div>
</div>
<div class="paragraph">
<p>The above example translates to an ansible command with the following
arguments:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>--tags containers --skip-tags packages --limit compute1*,compute2*</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hashes">Hashes</h3>
<div class="sect3">
<h4 id="_nodeset_config_changes">NodeSet Config Changes</h4>
<div class="paragraph">
<p>We create a Hash of the inputs located in the OpenStackDataPlaneNodeSet Spec Nodes and NodeTemplate sections.
This hash is then stored in the <code>status.configHash</code> field. If the current value of the configHash is different
to the deployedConfigHash, then it is necessary to recreate the <code>OpenStackDataPlaneDeployment</code> to roll out
the new changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ oc get osdpns -o yaml | yq '.items[0].status.configHash'
"n648hd6h88hc7h86hc7h568h585h79h5"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This field can be used to inform user decisions around when a new deploy is needed to reconclie the changes to the NodeSet.</p>
</div>
</div>
<div class="sect3">
<h4 id="_openstackdataplanenodeset_deployment_hashes">OpenStackDataPlaneNodeSet deployment hashes</h4>
<div class="paragraph">
<p>Each <code>OpenStackDataPlaneService</code> can optionally have an associated list of
<code>ConfigMaps</code> and <code>Secrets</code> that are mounted as file data into the
<code>OpenStackAnsibleEE</code> job started to deploy that service. The ansible content
then is able to consume those files as necessary. See <a href="#proc_creating-a-custom-service_dataplane">Configuring a custom
service</a> for more details.</p>
</div>
<div class="paragraph">
<p>When an <code>OpenStackDataPlaneDeployment</code> succeeds, the computed hash of each
<code>ConfigMap</code> and <code>Secret</code> for each <code>OpenStackDataPlaneService</code> that was deployed
is saved on the status of each <code>OpenStackDataPlaneNodeSet</code> referenced by the
<code>OpenStackDataPlaneDeployment</code>.</p>
</div>
<div class="paragraph">
<p>These hashes can be compared against the current hash of the <code>ConfigMap</code> or
<code>Secret</code> to see if there is newer input data that has not been deployed to the
<code>OpenStackDataPlaneNodeSet</code>. For example if the hash of
<code>nova-cell1-compute-config</code> <code>Secret</code> in the <code>OpenStackDataPlaneNodeSet</code> status
is different from the hash of <code>nova-cell1-compute-config</code> in the
<code>novacell/nova-cell1</code> status, then there is nova-compute control plane configuration
data the needs to be deployed to the EDPM compute nodes.</p>
</div>
<div class="paragraph">
<p>For example, the following hashes are saved on the <code>OpenStackDataPlaneNodeSet</code>
status after a typical deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get openstackdataplanenodeset openstack-edpm -o yaml

&lt;snip&gt;
status:
  conditions:
	&lt;snip&gt;
  configMapHashes:
    ovncontroller-config: n655h5...
  secretHashes:
    neutron-dhcp-agent-neutron-config: n9ch5...
    neutron-ovn-metadata-agent-neutron-config: n588h...
    neutron-sriov-agent-neutron-config: n648h...
    nova-cell1-compute-config: n576h...
    nova-metadata-neutron-config: n56fh...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_ipam_and_internal_dns_service">Using IPAM and Internal DNS Service</h3>
<div class="paragraph">
<p>To use IPAM and DNS Service with dataplane a <code>NetConfig</code> CR should exist with the
required networks, subnets and their allocation pools and <code>dns</code> service should be
enabled in <code>OpenStackControlPlane</code> CR.</p>
</div>
<div class="paragraph">
<p>When using IPAM, networks for the Node/NodeSet can be defined in the
<code>OpenStackDataPlaneNodeSet</code> CR either in the <code>nodes</code> or <code>nodeTemplate</code> section.</p>
</div>
<div class="paragraph">
<p>For predictable IP, networks should be added in the <code>nodes</code> section with desired
predictable IP as <code>fixedIP</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">&lt;snip&gt;
    nodes:
      edpm-compute-0:
        hostName: edpm-compute-0
        ansible:
          ansibleHost: 192.168.122.100
        networks:
        - name: ctlplane
          subnetName: subnet1
          defaultRoute: true
          fixedIP: 192.168.122.100
        - name: internalapi
          subnetName: subnet1
        - name: storage
          subnetName: subnet1
        - name: tenant
          subnetName: subnet1
&lt;snip&gt;
-------
&lt;snip&gt;
    nodeTemplate:
      networks:
      - name: ctlplane
        subnetName: subnet1
        defaultRoute: true
      - name: internalapi
        subnetName: subnet1
      - name: storage
        subnetName: subnet1
      - name: tenant
        subnetName: subnet1
&lt;snip&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_relevant_status_conditions">Relevant Status Conditions</h4>
<div class="paragraph">
<p><code>NodeSetIPReservationReady</code> and <code>NodeSetDNSDataReady</code> conditions in status condtions reflects the status of
IPReservation and DNSData as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get openstackdataplanenodeset openstack-edpm -o json | jq '.status.conditions[] | select(.type=="NodeSetIPReservationReady")'
{
  "lastTransitionTime": "2024-01-31T12:16:21Z",
  "message": "NodeSetIPReservationReady ready",
  "reason": "Ready",
  "status": "True",
  "type": "NodeSetIPReservationReady"
}

$ oc get openstackdataplanenodeset openstack-edpm-ipam -o json | jq '.status.conditions[] | select(.type=="NodeSetDNSDataReady")'
{
  "lastTransitionTime": "2024-01-31T12:16:21Z",
  "message": "NodeSetDNSDataReady ready",
  "reason": "Ready",
  "status": "True",
  "type": "NodeSetDNSDataReady"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly_hotfixing-the-data-plane">Hotfixing the data plane</h3>
<div class="paragraph _abstract">
<p>You can update the OpenStack data plane when hotfix content is available. Hotfix content
can be delivered as RPM packages or container images.</p>
</div>
<div class="paragraph">
<p>You apply a container hotfix to the data plane nodes by updating any running
containers to run from container images where the hotfix content has been
applied. Container hotfix content can be delivered as either RPMs or already
updated container images.</p>
</div>
<div class="paragraph">
<p>How the software is installed on the data plane nodes determines which of the
following methods you need to use to apply the hotfix content:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Node software was installed by using RPMs: Apply the hotfix to the RPM content.</p>
</li>
<li>
<p>Node software was installed by using container images: Apply the hotfix to the container content with either RPMs or container images.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="proc_hotfixing-the-data-plane-rpm-content-dataplane">Hotfixing the data plane RPM content</h4>
<div class="paragraph _abstract">
<p>You install RPM hotfix content directly on to the data plane nodes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Obtain the RPM hotfix content from the source and store it locally:</p>
<div class="listingblock">
<div class="content">
<pre>$ mkdir -p &lt;hotfix_id&gt;/rpms
$ cp /path/to/hotfix/*.rpm &lt;hotfix_id&gt;/rpms</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;hotfix_id&gt;</code> with a hotfix identifier such as a Jira issue, for example <code>osprh-0000</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Copy the RPM hotfix content to the affected data plane nodes:</p>
<div class="listingblock">
<div class="content">
<pre>$ ssh &lt;ssh_user&gt;@&lt;data_plane_node&gt; mkdir -p /tmp/&lt;hotfix_id&gt;/rpms
$ scp &lt;hotfix_id&gt;/rpms/*.rpm &lt;ssh_user&gt;@&lt;data_plane_node&gt;:/tmp/&lt;hotfix_id&gt;/rpms</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;ssh_user&gt;</code> with the SSH user name.</p>
</li>
<li>
<p>Replace <code>&lt;data_plane_node&gt;</code> with the hostname or IP for the data plane node.</p>
</li>
<li>
<p>Replace <code>&lt;hotfix_id&gt;</code> with a hotfix identifier such as a Jira issue, for example <code>osprh-0000</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Repeat this step for each data plane node that the hotfix must be applied to.</p>
</div>
</li>
<li>
<p>Update the RPM hotfix content on the affected data plane nodes.</p>
<div class="listingblock">
<div class="content">
<pre>$ ssh &lt;ssh_user&gt;@&lt;data_plane_node&gt;
$ sudo dnf in -y /tmp/&lt;hotfix_id&gt;/rpms/*.rpm</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;ssh_user&gt;</code> with the SSH user name.</p>
</li>
<li>
<p>Replace <code>&lt;data_plane_node&gt;</code> with the hostname or IP for the data plane node.</p>
</li>
<li>
<p>Replace <code>&lt;hotfix_id&gt;</code> with a hotfix identifier such as a Jira issue, for example <code>osprh-0000</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Perform any additional custom steps that are detailed in the hotfix instructions to complete the application of the RPM hotfix content.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc_hotfixing-the-data-plane-container-content-rpms-dataplane">Hotfixing the data plane container content with RPM&#8217;s</h4>
<div class="paragraph _abstract">
<p>When container hotfix content is delivered as RPM&#8217;s, you must update the container images manually.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>From a RHEL workstation, server, or virtual machine, ensure the following packages are installed:</p>
<div class="ulist">
<ul>
<li>
<p>buildah</p>
</li>
<li>
<p>podman</p>
</li>
</ul>
</div>
</li>
<li>
<p>From a RHEL workstation, server, or virtual machine, collect the hotfix RPMs into a new directory:</p>
<div class="listingblock">
<div class="content">
<pre>$ mkdir -p &lt;hotfix_id&gt;/rpms
$ cp /path/to/hotfix/*.rpm &lt;hotfix_id&gt;/rpms</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;hotfix_id&gt;</code> with a hotfix identifier such as a Jira issue, for example <code>osprh-0000</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a container image tagged with your registry account details and a hotfix identifier:</p>
<div class="listingblock">
<div class="content">
<pre>$ updated_container="&lt;updated_container_registry&gt;/&lt;updated_container_project&gt;/&lt;container_image&gt;:&lt;hotfix_id&gt;"
$ container=$(buildah from &lt;container_registry&gt;/&lt;container_project&gt;/&lt;container_image&gt;:&lt;container_tag&gt;)
$ buildah run --user root $container mkdir -p /&lt;hotfix_id&gt;/rpms
$ buildah copy --user root $container &lt;hotfix_id&gt;/rpms/*.rpm /hotfix_id/rpms
$ buildah run --user root rpm -F /&lt;hotfix_id/rpms/*.rpm
$ buildah commit $container $updated_container
$ buildah push $updated_container</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;hotfix_id&gt;</code> with a hotfix identifier such as a Jira issue, for example <code>osprh-0000</code>.</p>
</li>
<li>
<p>Replace <code>&lt;updated_container_registry&gt;</code> with a container registry to serve the updated container image. The OCP internal container image registry can be used.</p>
</li>
<li>
<p>Replace <code>&lt;updated_container_project&gt;</code> with a container project to use for the updated container image.</p>
</li>
<li>
<p>Replace <code>&lt;container_project&gt;</code> with the container project for the container being updated.</p>
</li>
<li>
<p>Replace <code>&lt;container_registry&gt;</code> with the container registry for the container being updated.</p>
</li>
<li>
<p>Replace <code>&lt;container_image&gt;</code> with the container image being updated.</p>
</li>
<li>
<p>Replace <code>&lt;container_tag&gt;</code> with the container tag being updated.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The values for <code>&lt;updated_container_registry&gt;</code> and <code>&lt;container_registry&gt;</code> can be the same. The values for <code>&lt;updated_container_project&gt;</code> and <code>&lt;container_project&gt;</code> can be the same. The container images will be differentiated based on the value of their tags.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Hotfix the updated container image on the affected data plane nodes. Use the <a href="#proc_hotfixing-the-data-plane-container-content-images">Hotfixing the data plane container content with images</a> procedure to apply the hotfixed container image.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc_hotfixing-the-data-plane-container-content-images-dataplane">Hotfixing the data plane container content with images</h4>
<div class="paragraph _abstract">
<p>When container hotfix content is delivered as images, the container processes need to be restarted to use the new images. This will be accomplished by creating a new <code>OpenStackDataPlaneDeployment</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Optional: Prepare the container hotfix image in a container registry where the image can be pulled by affected data plane nodes:</p>
<div class="listingblock">
<div class="content">
<pre>$ podman pull &lt;container_registry&gt;/&lt;container_project&gt;/&lt;container_image&gt;:&lt;container_tag&gt;
$ podman tag &lt;container_registry&gt;/&lt;container_project&gt;/&lt;container_image&gt;:&lt;container_tag&gt; &lt;updated_container_registry&gt;/&lt;updated_container_project&gt;/&lt;container_image&gt;:&lt;container_tag&gt;
$ podman push &lt;updated_container_registry&gt;/&lt;updated_container_project&gt;/&lt;container_image&gt;:&lt;container_tag&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;container_registry&gt;</code> with the source registry for the hotfixed container image.</p>
</li>
<li>
<p>Replace <code>&lt;container_project&gt;</code> with the source project for the hotfixed container image.</p>
</li>
<li>
<p>Replace <code>&lt;container_image&gt;</code> with the hotfixed container image.</p>
</li>
<li>
<p>Replace <code>&lt;container_tag&gt;</code> with the tag for the hotfixed container image.</p>
</li>
<li>
<p>Replace <code>&lt;updated_container_registry&gt;</code> with a container registry to serve the hotfixed container image. You can use the OpenShift internal container image registry.</p>
</li>
<li>
<p>Replace <code>&lt;updated_container_project&gt;</code> with a container project to use for the hotfixed container image.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Update the affected <code>OpenStackDataPlaneNodeSet</code> resources by customizing the container locations to the hotfixed container locations. For more information about how to set the hotfixed container locations, see <a href="#_customizing_container_image_locations">Customizing container image locations</a>.</p>
</li>
<li>
<p>Create a new <code>OpenStackDataPlaneDeployment</code> resource that deploys the affected <code>OpenStackDataPlaneNodeSet</code> resources. For more information about how to create <code>OpenStackDataPlaneDeployment</code> resources, see <a href="#proc_deploying-the-data-plane_dataplane">Deploying the data plane</a>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can restrict the list of services for the <code>OpenStackDataPlaneDeployment</code> to only those affected by the hotfix by using the <code>servicesOverride</code> field. For more information, see <a href="#_overriding_services_for_the_deployment">Overriding services for the deployment</a>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly_updating-the-data-plane">Updating the data plane</h3>
<div class="paragraph _abstract">
<p>You can perform a minor update of your OpenStack data plane environment to keep
it updated with the latest packages and containers.</p>
</div>
<div class="paragraph">
<p>You must coordinate the minor update of the OpenStack data plane environment
with a minor update of the control plane. OVN containers on the data plane
nodes should not be updated until OVN containers on the control plane have been
updated.</p>
</div>
<div class="paragraph">
<p>See
<a href="https://github.com/openstack-k8s-operators/dev-docs/blob/main/version_updates.md">OpenStackVersion</a>
and
<a href="https://github.com/openstack-k8s-operators/dev-docs/blob/main/ovs-update.md">Open
vSwitch update</a> for more information.</p>
</div>
<div class="sect3">
<h4 id="proc_updating-the-data-plane-ovn-dataplane">Updating OVN on the data plane</h4>
<div class="paragraph _abstract">
<p>You update OVN content (containers) on the data plane once OVN on the control
plane has been updated.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Validate that OVN has been updated on the control plane.</p>
<div class="listingblock">
<div class="content">
<pre>$ oc wait openstackversion &lt;openstack_ctlplane_name&gt; --for=condition=MinorUpdateOVNControlplane</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;openstack_ctlplane_name&gt;</code> with the name of the OpenStack control plane resource.</p>
<div class="paragraph">
<p>The following example output shows the condition has been met:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openstackversion.core.openstack.org/openstack-galera-network-isolation condition met</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create an <code>OpenStackDataPlaneDeployment</code> CR and save it to a file named <code>openstack-edpm-update.yaml</code> on your workstation.</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: edpm-deployment-ipam-update
spec:
  nodeSets:
    - openstack-edpm-ipam
    - &lt;nodeSet_name&gt;
    - ...
    - &lt;nodeSet_name&gt;
  servicesOverride:
    - ovn</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;nodeSet_name&gt;</code> with the names of the <code>OpenStackDataPlaneNodeSet</code> CRs that you want to include in your data plane minor update.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>servicesOverride</code> field is set to include only <code>ovn</code> as the <code>ovn</code> service must be updated first in isolation. If using a custom service to manage <code>ovn</code>, then use that custom service name instead of <code>ovn</code> in <code>servicesOverride</code>. Additionally if other custom services must be updated at the same time as <code>ovn</code>, then they can be included in <code>servicesOverride</code> as well.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Save the <code>openstack-edpm-update.yaml</code> deployment file.</p>
</li>
<li>
<p>Update the data plane:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc create -f openstack-edpm-update.yaml</pre>
</div>
</div>
</li>
<li>
<p>Verify that the data plane update deployment succeeded:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackdataplanedeployment
NAME             			STATUS   MESSAGE
edpm-deployment-ipam   		True     Setup Complete
edpm-deployment-ipam-update True     Setup Complete</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once OVN has been updated on the data plane, the rest of the control plane minor update will automatically proceed. Once the control plane minor update is finished, the rest of the data plane can be updated.</p>
</div>
<div class="paragraph">
<div class="title">Troubleshooting</div>
<p>See <a href="#proc_troubleshooting-data-plane-creation-and-deployment_dataplane">Troubleshooting data plane creation and deployment</a> for troubleshooting any deployment failures.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc_updating-the-data-plane-dataplane">Updating other services on the data plane</h4>
<div class="paragraph _abstract">
<p>Once OVN has been updated on the control plane and data plane, and the rest of the control plane has completed updating, you update the rest of the services on the data plane.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Validate that the rest of the minor update has completed on the control plane.</p>
<div class="listingblock">
<div class="content">
<pre>$ oc wait openstackversion &lt;openstack_ctlplane_name&gt; --for=condition=MinorUpdateControlplane</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;openstack_ctlplane_name&gt;</code> with the name of the OpenStack control plane resource.</p>
<div class="paragraph">
<p>The following example output shows the condition has been met:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openstackversion.core.openstack.org/openstack-galera-network-isolation condition met</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create an <code>OpenStackDataPlaneDeployment</code> CR and save it to a file named <code>openstack-edpm-update-services.yaml</code> on your workstation.</p>
<div class="listingblock">
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: edpm-deployment-ipam-update-services
spec:
  nodeSets:
    - openstack-edpm-ipam
    - &lt;nodeSet_name&gt;
    - ...
    - &lt;nodeSet_name&gt;
  servicesOverride:
    - update</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;nodeSet_name&gt;</code> with the names of the <code>OpenStackDataPlaneNodeSet</code> CRs that you want to include in your data plane minor update.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>servicesOverride</code> field is set to include only <code>update</code>. The <code>update</code> service applies only the tasks needed to update the packages and containers on the EDPM nodes. When using custom services, include those here as well, or their equivalent custom services that apply the needed update tasks.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Save the <code>openstack-edpm-update-services.yaml</code> deployment file.</p>
</li>
<li>
<p>Update the data plane:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc create -f openstack-edpm-update-services.yaml</pre>
</div>
</div>
</li>
<li>
<p>Verify that the data plane update deployment succeeded:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get openstackdataplanedeployment
NAME             						STATUS   MESSAGE
edpm-deployment-ipam   					True     Setup Complete
edpm-deployment-ipam-update 			True     Setup Complete
edpm-deployment-ipam-update-services 	True     Setup Complete</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Troubleshooting</div>
<p>See <a href="#proc_troubleshooting-data-plane-creation-and-deployment_dataplane">Troubleshooting data plane creation and deployment</a> for troubleshooting any deployment failures.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dataplane_performance_tuning_for_large_scale_deployments">DataPlane Performance Tuning for large scale deployments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide covers strategies for scaling and optimizing performance when
deploying and managing OpenStack External Data Plane Management (EDPM) nodes
using the openstack-operator.</p>
</div>
<div class="sect2">
<h3 id="_overview">Overview</h3>
<div class="paragraph">
<p>The openstack-operator uses Ansible to configure and manage external compute
nodes through its DataPlane functionality. Understanding how to structure your
NodeSets and tune Ansible execution is critical for achieving optimal
deployment performance, especially in large-scale environments.</p>
</div>
<div class="sect3">
<h4 id="_key_performance_factors">Key Performance Factors</h4>
<div class="ulist">
<ul>
<li>
<p><strong>NodeSet organization</strong>: How nodes are grouped affects parallelism</p>
</li>
<li>
<p><strong>Ansible parallelism</strong>: Configuration of forks and execution strategy</p>
</li>
<li>
<p><strong>Service execution order</strong>: Services run sequentially within each NodeSet</p>
</li>
<li>
<p><strong>Network and hardware resources</strong>: Available SSH connections, CPU, memory</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nodeset_grouping_strategies">NodeSet Grouping Strategies</h3>
<div class="paragraph">
<p>A <code>OpenStackDataPlaneNodeSet</code> represents a group of nodes with similar
configuration. How you group nodes significantly impacts deployment performance
and manageability.</p>
</div>
<div class="sect3">
<h4 id="_strategy_1_single_large_nodeset">Strategy 1: Single Large NodeSet</h4>
<div class="paragraph">
<p>Group all similar nodes (e.g., all compute nodes) into one NodeSet.</p>
</div>
<div class="listingblock">
<div class="title">Single Large NodeSet Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: compute-nodes
spec:
  nodes:
    compute-0:
      hostName: compute-0
      ansible:
        ansibleHost: 192.168.122.100
    compute-1:
      hostName: compute-1
      ansible:
        ansibleHost: 192.168.122.101
    # ... Up to any large number of computes
    compute-99:
      hostName: compute-99
      ansible:
        ansibleHost: 192.168.122.199</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Advantages:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Single Ansible execution handles all nodes</p>
</li>
<li>
<p>Ansible&#8217;s built-in parallelism (forks) manages concurrency</p>
</li>
<li>
<p>Simpler to manage - one OpenStackDataPlaneNodeSet CR to track</p>
</li>
<li>
<p>Consistent configuration across all nodes</p>
</li>
<li>
<p>Efficient OpenShift resource usage - less ansible-runner pods during
OpenStackDataPlaneDeployment execution</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Disadvantages:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Limited parallelism by Ansible forks setting</p>
</li>
<li>
<p>Single failure point - one playbook error may affect all nodes in the NodeSet</p>
</li>
<li>
<p>Harder to isolate problems to specific node subsets</p>
</li>
<li>
<p>Longer serial operations (e.g., gathering facts from 100 nodes)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_strategy_2_multiple_smaller_nodesets">Strategy 2: Multiple Smaller NodeSets</h4>
<div class="paragraph">
<p>Divide nodes into multiple NodeSets, each with a subset of nodes.</p>
</div>
<div class="listingblock">
<div class="title">Multiple NodeSets Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: compute-group-1
spec:
  nodes:
    compute-0:
      hostName: compute-0
      ansible:
        ansibleHost: 192.168.122.100
    # ... compute-1 through compute-24
---
apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: compute-group-2
spec:
  nodes:
    compute-25:
      hostName: compute-25
      ansible:
        ansibleHost: 192.168.122.125
    # ... compute-26 through compute-49</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Advantages:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Increased parallelism</strong>: Multiple ansible-runner pods execute simultaneously
for each NodeSet.</p>
</li>
<li>
<p>Better failure isolation - one NodeSet&#8217;s failure doesn&#8217;t block others</p>
</li>
<li>
<p>Easier troubleshooting and isolation of issues</p>
</li>
<li>
<p>Can deploy groups incrementally or independently</p>
</li>
<li>
<p>Lower memory per ansible-runner pod</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Disadvantages:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>More NodeSet CRs to manage and monitor</p>
</li>
<li>
<p>Potential for configuration drift between NodeSets</p>
</li>
<li>
<p>Higher OpenShift overhead - multiple ansible-runner pods</p>
</li>
<li>
<p>More complex deployment orchestration</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_strategy_3_role_based_nodesets">Strategy 3: Role-Based NodeSets</h4>
<div class="paragraph">
<p>Group nodes by their role or function rather than arbitrarily.</p>
</div>
<div class="listingblock">
<div class="title">Role-Based NodeSets Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: compute-standard
spec:
  nodes:
    compute-0:
      hostName: compute-0
      ansible:
        ansibleHost: 192.168.122.100
    # ... standard compute nodes
---
apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: compute-gpu
spec:
  nodeTemplate:
    ansible:
      ansibleVars:
        edpm_nova_pci_passthrough_whitelist:
          - '{"vendor_id": "10de", "product_id": "1b38"}'
  nodes:
    compute-gpu-0:
      hostName: compute-gpu-0
      ansible:
        ansibleHost: 192.168.122.210
    # ... GPU compute nodes</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Advantages:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Different configurations for different node types</p>
</li>
<li>
<p>Clear organizational structure</p>
</li>
<li>
<p>Natural parallelism across different roles</p>
</li>
<li>
<p>Easier capacity planning and management</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Disadvantages:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>May not maximize parallelism if roles have different node counts</p>
</li>
<li>
<p>Configuration must be carefully managed across NodeSets</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Shares similar advantages and disadvantages as using multiple smaller NodeSets.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parallel_execution_patterns">Parallel Execution Patterns</h3>
<div class="paragraph">
<p>Understanding how the openstack-operator executes deployments is key to optimization.</p>
</div>
<div class="sect3">
<h4 id="_nodeset_level_parallelism">NodeSet-Level Parallelism</h4>
<div class="paragraph">
<p>When you create an <code>OpenStackDataPlaneDeployment</code> with multiple NodeSets, the operator starts them sequentially but they execute in parallel:</p>
</div>
<div class="listingblock">
<div class="title">Multiple NodeSets Deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: edpm-deployment
spec:
  nodeSets:
    - compute-group-1
    - compute-group-2
    - compute-group-3
    - compute-group-4</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Execution flow:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Operator starts deployment for <code>compute-group-1</code>  ansible-runner pod launches</p>
</li>
<li>
<p>Operator starts deployment for <code>compute-group-2</code>  ansible-runner pod launches</p>
</li>
<li>
<p>Operator starts deployment for <code>compute-group-3</code>  ansible-runner pod launches</p>
</li>
<li>
<p>Operator starts deployment for <code>compute-group-4</code>  ansible-runner pod launches</p>
</li>
<li>
<p>All four ansible-runner pods execute in parallel</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This means <strong>4 separate Ansible executions run simultaneously</strong>, each processing
their respective NodeSets.</p>
</div>
</div>
<div class="sect3">
<h4 id="_service_level_execution">Service-Level Execution</h4>
<div class="paragraph">
<p>Within each NodeSet, services execute <strong>sequentially</strong> (one after another). You
cannot parallelize service execution within a single NodeSet, but multiple
NodeSets executing in parallel means those services run in parallel across
NodeSets.</p>
</div>
</div>
<div class="sect3">
<h4 id="_node_level_parallelism_within_ansible">Node-Level Parallelism Within Ansible</h4>
<div class="paragraph">
<p>Within a single Ansible execution (one NodeSet), parallelism is controlled by
Ansible&#8217;s <code>forks</code> setting. This determines how many nodes Ansible configures
simultaneously.</p>
</div>
<div class="paragraph">
<p><strong>Default behavior</strong> (from edpm-ansible playbooks):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Strategy</strong>: <code>linear</code> (waits for all hosts to complete a task before moving to next task)</p>
</li>
<li>
<p><strong>Forks</strong>: Defaults to 5 (can be overridden with <code>ANSIBLE_FORKS</code>)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ansible_performance_tuning">Ansible Performance Tuning</h3>
<div class="sect3">
<h4 id="_environment_variables">Environment Variables</h4>
<div class="paragraph">
<p>You can configure Ansible behavior by setting Ansible specific environment
variables in the NodeSet spec:</p>
</div>
<div class="listingblock">
<div class="title">Complete Tuned NodeSet Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: compute-optimized
spec:
  env:
    # Enable colored output for easier log reading
    - name: ANSIBLE_FORCE_COLOR
      value: "True"

    # Increase parallel execution (default: 5)
    # Set based on your control plane resources
    - name: ANSIBLE_FORKS
      value: "50"

    # Increase SSH connection timeout (default: 10)
    # Useful for slow networks or heavily loaded nodes
    - name: ANSIBLE_TIMEOUT
      value: "30"

    # Enable pipelining to reduce SSH overhead
    # Requires sudo without requiretty
    - name: ANSIBLE_PIPELINING
      value: "True"

    # Increase SSH connection persistence
    # Reuses SSH connections for better performance
    - name: ANSIBLE_SSH_PIPELINING
      value: "True"

    # Control SSH connection multiplexing
    - name: ANSIBLE_SSH_CONTROL_PATH_DIR
      value: "/tmp/ansible-ssh-%%h-%%p-%%r"

    # Set callback plugins for better output
    - name: ANSIBLE_STDOUT_CALLBACK
      value: "yaml"

    # Increase async job status polling
    - name: ANSIBLE_POLL_INTERVAL
      value: "5"
  nodes:
    compute-0:
      # ... node definitions</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_common_ansible_tuning_techniques">Common Ansible Tuning Techniques</h4>
<div class="paragraph">
<p>See
<a href="https://docs.ansible.com/projects/ansible/latest/reference_appendices/config.html" class="bare">https://docs.ansible.com/projects/ansible/latest/reference_appendices/config.html</a>
for a comprehensive list of ansible configuration settings.</p>
</div>
<div class="paragraph">
<p>The following are the more common configuration settings related to performance
tuning for large environments.</p>
</div>
<div class="sect4">
<h5 id="_optimize_fork_count">Optimize Fork Count</h5>
<div class="paragraph">
<p>The <code>ANSIBLE_FORKS</code> setting is the most impactful tuning parameter.</p>
</div>
<div class="paragraph">
<p><strong>Considerations:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Control plane resources</strong>: More forks require more CPU/memory in the ansible-runner pod</p>
</li>
<li>
<p><strong>Network capacity</strong>: More simultaneous SSH connections</p>
</li>
<li>
<p><strong>Target node capacity</strong>: Nodes must handle concurrent configuration tasks</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Recommendations:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Small deployments (&lt; 10 nodes): <code>ANSIBLE_FORKS=5-10</code></p>
</li>
<li>
<p>Medium deployments (10-50 nodes): <code>ANSIBLE_FORKS=20-30</code></p>
</li>
<li>
<p>Large deployments (50-100 nodes): <code>ANSIBLE_FORKS=50-75</code></p>
</li>
<li>
<p>Very large (100+ nodes): Consider multiple NodeSets instead of very high fork count</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: ANSIBLE_FORKS
    value: "50"  # Tune based on your environment</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Performance impact</strong>: Increased parallelism can decrease deployment times.</p>
</div>
</div>
<div class="sect4">
<h5 id="_enable_ssh_pipelining">Enable SSH Pipelining</h5>
<div class="paragraph">
<p>Pipelining reduces the number of SSH operations required for each task. See
<a href="https://docs.ansible.com/projects/ansible/latest/collections/ansible/builtin/ssh_connection.html#parameter-pipelining" class="bare">https://docs.ansible.com/projects/ansible/latest/collections/ansible/builtin/ssh_connection.html#parameter-pipelining</a>
for more details.</p>
</div>
<div class="paragraph">
<p><strong>Requirements:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>SSH user must have passwordless sudo or sudo without <code>requiretty</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: ANSIBLE_PIPELINING
    value: "True"
  - name: ANSIBLE_SSH_PIPELINING
    value: "True"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_increase_timeouts_for_slow_environments">Increase Timeouts for Slow Environments</h5>
<div class="paragraph">
<p>If you have slow networks or heavily loaded nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: ANSIBLE_TIMEOUT
    value: "60"  # SSH connection timeout in seconds
  - name: ANSIBLE_GATHER_TIMEOUT
    value: "60"  # Fact gathering timeout</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_control_output_and_logging">Control Output and Logging</h5>
<div class="paragraph">
<p>Reduce overhead from excessive logging:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: ANSIBLE_STDOUT_CALLBACK
    value: "yaml"  # or "json" for structured output
  - name: ANSIBLE_DISPLAY_SKIPPED_HOSTS
    value: "False"
  - name: ANSIBLE_DISPLAY_OK_HOSTS
    value: "False"  # Only show changed/failed
  - name: ANSIBLE_RETRY_FILES_ENABLED
    value: "False"  # Disable retry files</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_ssh_connection_multiplexing">SSH Connection Multiplexing</h5>
<div class="paragraph">
<p>Reuse SSH connections for better performance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: ANSIBLE_SSH_CONTROL_PATH
    value: "/tmp/ansible-ssh-%%h-%%p-%%r"
  - name: ANSIBLE_SSH_CONTROL_PERSIST
    value: "60s"  # Keep connections alive for 60 seconds</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_ansiblelimit_for_targeted_deployments">Using ansibleLimit for Targeted Deployments</h3>
<div class="paragraph">
<p>The <code>ansibleLimit</code> field allows you to target specific nodes within your NodeSets without modifying the NodeSet definitions.</p>
</div>
<div class="sect3">
<h4 id="_basic_usage">Basic Usage</h4>
<div class="paragraph">
<p>Deploy only to specific nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: limited-deployment
spec:
  nodeSets:
    - compute-nodes
  ansibleLimit: "compute-0,compute-5,compute-10"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This deploys only to <code>compute-0</code>, <code>compute-5</code>, and <code>compute-10</code> within the <code>compute-nodes</code> NodeSet.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pattern_matching">Pattern Matching</h4>
<div class="paragraph">
<p>Use Ansible patterns for more flexible targeting.
See
<a href="https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_patterns.html" class="bare">https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_patterns.html</a>
for more details on using ansible limit and pattern matching.</p>
</div>
<div class="paragraph">
<p>Example OpenStackDataPlaneDeployment&#8217;s using ansibleLimit and pattern matching:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: pattern-limited-deployment
spec:
  nodeSets:
    - compute-nodes
  ansibleLimit: "compute-[0:9]"  # First 10 nodes (compute-0 through compute-9)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wildcard_patterns">Wildcard Patterns</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  nodeSets:
    - compute-nodes
  ansibleLimit: "compute-1*"  # Matches compute-1, compute-10, compute-11, etc.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_use_cases_for_ansible_limit">Use Cases for ansible limit</h4>
<div class="sect4">
<h5 id="_gradual_rollout">Gradual Rollout</h5>
<div class="paragraph">
<p>Deploy to nodes incrementally to validate changes:</p>
</div>
<div class="listingblock">
<div class="title">Phase 1: Deploy to first subset  of nodes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: rollout-phase-1
spec:
  nodeSets:
    - compute-nodes
  ansibleLimit: "compute-[0:9]"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Phase 2: Deploy to next subset of nodes after validation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: rollout-phase-2
spec:
  nodeSets:
    - compute-nodes
  ansibleLimit: "compute-[10:49]"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_hotfix_deployment">Hotfix Deployment</h5>
<div class="paragraph">
<p>Fix issues on specific problematic nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: hotfix-deployment
spec:
  nodeSets:
    - compute-nodes
  ansibleLimit: "compute-15,compute-23,compute-67"
  servicesOverride
    - "configure-os"  # Only reconfigure OS</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_testing_changes">Testing Changes</h5>
<div class="paragraph">
<p>Test configuration changes on a canary node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: canary-test
spec:
  nodeSets:
    - compute-nodes
  ansibleLimit: "compute-0"  # Single canary node</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_combining_with_multiple_nodesets">Combining with Multiple NodeSets</h5>
<div class="paragraph">
<p>The <code>ansibleLimit</code> applies to all NodeSets in the deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: multi-nodeset-limited
spec:
  nodeSets:
    - compute-group-1
    - compute-group-2
    - compute-group-3
  ansibleLimit: "compute-[0:9]"  # Applies to all three NodeSets</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will deploy to <code>compute-0</code> through <code>compute-9</code>, in which ever NodeSets
they are specified in the 3 referenced NodeSets.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scaling_strategy_comparison">Scaling Strategy Comparison</h3>
<div class="sect3">
<h4 id="_scenario_100_compute_nodes_deployment">Scenario: 100 Compute Nodes Deployment</h4>
<div class="paragraph">
<p>Let&#8217;s compare different strategies for deploying 100 compute nodes.</p>
</div>
<div class="sect4">
<h5 id="_option_1_single_large_nodeset">Option 1: Single Large NodeSet</h5>
<div class="listingblock">
<div class="title">Configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: all-computes
spec:
  env:
    - name: ANSIBLE_FORKS
      value: "50"
  nodes:
    # compute-0 through compute-99 (100 nodes)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Characteristics:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ansible executions per service</strong>: 1</p>
</li>
<li>
<p><strong>Parallelism</strong>: Up to 50 nodes at once (limited by ANSIBLE_FORKS)</p>
</li>
<li>
<p><strong>ansible-runner pods per service</strong>: 1</p>
</li>
<li>
<p><strong>Fact gathering</strong>: Serial across 100 nodes (even with forks, each batch completes before next)</p>
</li>
<li>
<p><strong>Failure handling</strong>: One failure may require redeploying all 100 nodes</p>
</li>
<li>
<p><strong>Resource usage</strong>: One large ansible-runner pod per service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Timeline example</strong> (assuming 10 services, 5 minutes per service per node):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With forks=50: Two batches of 50 nodes</p>
</li>
<li>
<p>Service 1: Batch 1 (50 nodes) runs in parallel = 5 min, then Batch 2 (50 nodes) = 5 min  10 min total</p>
</li>
<li>
<p>Service 2: Same pattern  10 min total</p>
</li>
<li>
<p>Total for ~10 services: ~100 minutes</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_option_2_four_nodesets_25_nodes_each">Option 2: Four NodeSets (25 nodes each)</h5>
<div class="listingblock">
<div class="title">Configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># compute-group-1: compute-0 through compute-24
# compute-group-2: compute-25 through compute-49
# compute-group-3: compute-50 through compute-74
# compute-group-4: compute-75 through compute-99

apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: compute-group-1
spec:
  env:
    - name: ANSIBLE_FORKS
      value: "25"
  nodes:
    # 25 nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: deploy-all-groups
spec:
  nodeSets:
    - compute-group-1
    - compute-group-2
    - compute-group-3
    - compute-group-4</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Characteristics:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ansible executions per service</strong>: 4 (in parallel)</p>
</li>
<li>
<p><strong>Parallelism</strong>: 4 NodeSets  25 nodes = 100 nodes effectively in parallel</p>
</li>
<li>
<p><strong>ansible-runner pods per service</strong>: 4</p>
</li>
<li>
<p><strong>Fact gathering</strong>: Parallel across 4 groups</p>
</li>
<li>
<p><strong>Failure handling</strong>: One group&#8217;s failure doesn&#8217;t block others</p>
</li>
<li>
<p><strong>Resource usage</strong>: Four medium ansible-runner pods per service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Timeline example</strong> (same assumptions):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With forks=25: Each NodeSet processes all 25 nodes in one batch</p>
</li>
<li>
<p>Service 1: All 4 groups run in parallel = 5 min total</p>
</li>
<li>
<p>Service 2: All 4 groups run in parallel = 5 min total</p>
</li>
<li>
<p>Total for all services: ~50 minutes (2x faster than Option 1)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_comparison_table">Comparison Table</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Aspect</th>
<th class="tableblock halign-left valign-top">Single NodeSet (100)</th>
<th class="tableblock halign-left valign-top">4 NodeSets (25 each)</th>
<th class="tableblock halign-left valign-top">10 NodeSets (10 each)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Parallelism</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limited (50 forks max)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High (4 executions)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum (10 executions)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Deployment Time</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~100 minutes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~50 minutes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~50 minutes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Resource Overhead</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low (1 pod)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium (4 pods)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High (10 pods)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Failure Isolation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Poor (all-or-nothing)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Good (25% chunks)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Excellent (10% chunks)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Management Complexity</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Simple (1 CR)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Moderate (4 CRs)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complex (10 CRs)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Troubleshooting</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Difficult</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Easier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Easiest</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Best For</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Small deployments, uniform nodes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Balanced performance/management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum speed, good isolation</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_recommendations">Recommendations</h4>
<div class="paragraph">
<p><strong>Use Single Large NodeSet when:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>You have less nodes in the NodeSet than a reasonable setting for ansible
forks</p>
</li>
<li>
<p>Resources are constrained (can&#8217;t run multiple pods)</p>
</li>
<li>
<p>Configuration is identical across all nodes</p>
</li>
<li>
<p>Simplicity is more important than speed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Use Multiple Medium NodeSets when:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>You want balanced performance and manageability</p>
</li>
<li>
<p>Some failure isolation is important</p>
</li>
<li>
<p>You have sufficient cluster resources for multiple pods</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Use Many Small NodeSets when:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maximum deployment speed is critical</p>
</li>
<li>
<p>Strong failure isolation is required</p>
</li>
<li>
<p>You have ample cluster resources</p>
</li>
<li>
<p>You can manage the additional CRs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Use Role-Based NodeSets when:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Nodes have different configurations</p>
</li>
<li>
<p>Different hardware types exist</p>
</li>
<li>
<p>You need to deploy to subsets frequently</p>
</li>
<li>
<p>Organizational clarity is important</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_best_practices">Best Practices</h3>
<div class="sect3">
<h4 id="_start_conservative_then_optimize">Start Conservative, Then Optimize</h4>
<div class="paragraph">
<p>Begin with modest settings and increase based on observed performance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># Initial deployment
env:
  - name: ANSIBLE_FORKS
    value: "10"

# After monitoring, if resources allow
env:
  - name: ANSIBLE_FORKS
    value: "30"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_use_ansible_limit_for_validation">Use ansible limit for Validation</h4>
<div class="paragraph">
<p>Before deploying to all nodes, test on a subset:</p>
</div>
<div class="listingblock">
<div class="title">Test deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: validation-deployment
spec:
  nodeSets:
    - compute-nodes
  ansibleLimit: "compute-0,compute-1"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Full deployment after validation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: production-deployment
spec:
  nodeSets:
    - compute-nodes</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scaling_the_dataplane_2">Scaling the DataPlane</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_scaling_out_2">Scaling Out</h3>
<div class="paragraph">
<p>Scale out of an existing dataplane with more edpm nodes can be achieved by adding new
nodes to the <code>nodes</code> section of the <code>OpenStackDataPlaneNodeSet</code> spec. Ensure that
there are enough BMHs in <code>Available</code> state in the required namespace with the desired
labels for baremetal nodes.</p>
</div>
<div class="literalblock">
<div class="title">Pre-Provisioned:</div>
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
spec:
  preProvisioned: True
  nodes:
  ...
    edpm-compute-2:
      hostName: edpm-compute-2
      ansible:
        ansibleHost: 192.168.122.102
      networks:
      - name: CtlPlane
        subnetName: subnet1
        defaultRoute: true
        fixedIP: 192.168.122.102
      - name: InternalApi
        subnetName: subnet1
      - name: Storage
        subnetName: subnet1
      - name: Tenant
        subnetName: subnet1
  ...</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Baremetal:</div>
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  name: openstack-edpm-ipam
spec:
  nodes:
  ...
    edpm-compute-2:
      hostName: edpm-compute-2
  ...</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
To deploy on the additional nodes, a <strong>new</strong> <code>OpenStackDataPlaneDeployment</code> CR should be
created with the <code>OpenStackDataPlaneNodeSet</code> in the <code>nodeSets</code> section.
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="title">New OpenStackDataPlaneDeployment:</div>
<div class="content">
<pre>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneDeployment
metadata:
  name: new-deployment # Do not re-use the name from previous OpenStackDataPlaneDeployment
spec:
 nodeSets:
   - openstack-edpm-ipam # scaled out nodeset name</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Before applying the <strong>new</strong> <code>OpenStackDataPlaneDeployment</code> CR, verify
if the <code>OpenStackDataPlaneNodeSet</code> in the <code>nodeSets</code> section has reached the <code>SetupReady</code> status.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc wait openstackdataplanenodeset openstack-edpm-ipam --for condition=SetupReady --timeout=10m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once deployment completes <code>OpenStackDataPlaneNodeSet</code> would be ready as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get openstackdataplanenodeset openstack-edpm-ipam
NAME                  STATUS   MESSAGE
openstack-edpm-ipam   True     NodeSet Ready</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the scaled out nodes are compute nodes, once the <code>OpenStackDataPlaneNodeSet</code> reaches
<code>NodeSet Ready</code>, <code>nova-manage cell_v2 discover_hosts</code> should be run to make the new
compute nodes show-up in hypervisor list and become usable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc rsh nova-cell0-conductor-0 nova-manage cell_v2 discover_hosts --verbose
Found 2 cell mappings.
Skipping cell0 since it does not contain hosts.
Getting computes from cell 'cell1': 75f666d2-922d-45af-8bdb-d897a1bc9b1c
Checking host mapping for compute host 'edpm-compute-2': 6afda7af-2953-4400-842c-a327a0e43a74
Creating host mapping for compute host 'edpm-compute-2': 6afda7af-2953-4400-842c-a327a0e43a74
Found 1 unmapped computes in cell: 75f666d2-922d-45af-8bdb-d897a1bc9b1c

$ oc rsh openstackclient openstack hypervisor list
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+
| ID                                   | Hypervisor Hostname                 | Hypervisor Type | Host IP         | State |
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+
| cc05372a-27bd-4b33-985e-b0009c9e515e | edpm-compute-1.ctlplane.example.com | QEMU            | 192.168.221.101 | up    |
| 5e3f7b5d-39fd-430c-80d1-084086bdccde | edpm-compute-0.ctlplane.example.com | QEMU            | 192.168.221.100 | up    |
| 6afda7af-2953-4400-842c-a327a0e43a74 | edpm-compute-2.ctlplane.example.com | QEMU            | 192.168.221.102 | up    |
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scaling_out_with_different_configuration_2">Scaling Out with different configuration</h3>
<div class="paragraph">
<p>If the deployment needs to be scaled out to nodes that require different
configuration (e.g. different kernel args, network config, or openstack config)
compared to the configuration in the current <code>OpenStackDataPlaneNodeSet</code>
then the new nodes cannot be added to the existing <code>OpenStackDataPlaneNodeSet</code>
but a new <code>OpenStackDataPlaneNodeSet</code> needs to be created that contains the
new nodes and the new configuration for those nodes. Then a new
<code>OpenStackDataPlaneDeployment</code> needs to be created that points to <strong>both the
existing and the new <code>OpenStackDataPlaneNodeSets</code></strong> to trigger the scale out.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If only the new <code>OpenStackDataPlaneNodeSet</code> is included into the new
<code>OpenStackDataPlaneDeployment</code> then the scale out seems to succeed but will
be incomplete causing that VM move operations will fail between nodes
in the different <code>OpenStackDataPlaneNodeSets</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_scaling_in_2">Scaling In</h3>
<div class="paragraph">
<p>The procedure for removing edpm nodes from dataplane involves some manual cleanup steps
after evacuation of workload.</p>
</div>
<div class="paragraph">
<p>For edpm compute nodes removal following steps should be performed.</p>
</div>
<div class="sect3">
<h4 id="_disable_nova_compute_service_2">Disable nova-compute service</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc rsh openstackclient openstack compute service list
+--------------------------------------+----------------+------------------------+----------+---------+-------+----------------------------+
| ID                                   | Binary         | Host                   | Zone     | Status  | State | Updated At                 |
+--------------------------------------+----------------+------------------------+----------+---------+-------+----------------------------+
| 11105d9b-9ef7-4d6f-8d17-6eb8db175d76 | nova-conductor | nova-cell1-conductor-0 | internal | enabled | up    | 2024-02-01T03:59:42.000000 |
| 31e2ee14-a124-4e02-b11d-87c2cdca3c56 | nova-compute   | edpm-compute-1         | nova     | enabled | up    | 2024-02-01T03:59:38.000000 |
| bd031e6e-89d8-4839-b345-5f124ec4c07e | nova-compute   | edpm-compute-0         | nova     | enabled | up    | 2024-02-01T03:59:37.000000 |
| f70912f9-eaaa-4caa-906f-a38e20667af4 | nova-compute   | edpm-compute-2         | nova     | enabled | up    | 2024-02-01T03:59:38.000000 |
| 8a4622c3-0fb8-498a-81d8-a9c23c0be5fc | nova-conductor | nova-cell0-conductor-0 | internal | enabled | up    | 2024-02-01T03:59:37.000000 |
| 5ad386ec-ac2d-4238-a671-d9402432d326 | nova-scheduler | nova-scheduler-0       | internal | enabled | up    | 2024-02-01T03:59:38.000000 |
+--------------------------------------+----------------+------------------------+----------+---------+-------+----------------------------+

$ oc rsh openstackclient openstack compute service set edpm-compute-2 nova-compute --disable</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_stop_ovn_and_nova_compute_containers_2">Stop ovn and nova-compute containers</h4>
<div class="paragraph">
<p>ssh to the edpm node to be removed and stop the containers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ ssh -i out/edpm/ansibleee-ssh-key-id_rsa cloud-admin@192.168.221.102

[cloud-admin@edpm-compute-2 ~]$ sudo systemctl stop edpm_ovn_controller

[cloud-admin@edpm-compute-2 ~]$ sudo systemctl stop edpm_ovn_metadata_agent

[cloud-admin@edpm-compute-2 ~]$ sudo systemctl stop edpm_nova_compute</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_delete_network_agents_2">Delete network agents</h4>
<div class="paragraph">
<p>Delete the agents for the compute nodes to be removed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc rsh openstackclient openstack network agent list

+--------------------------------------+------------------------------+----------------+-------------------+-------+-------+----------------+
| ID                                   | Agent Type                   | Host           | Availability Zone | Alive | State | Binary         |
+--------------------------------------+------------------------------+----------------+-------------------+-------+-------+----------------+
| d2b9e5d0-a406-41c2-9bc3-e74aaf113450 | OVN Controller Gateway agent | worker-0       |                   | :-)   | UP    | ovn-controller |
| 9529e28e-522e-48f6-82e2-c5caf1cf5a14 | OVN Controller Gateway agent | worker-1       |                   | :-)   | UP    | ovn-controller |
| 91bd4981-1e81-4fe8-b628-8581add36f13 | OVN Controller agent         | edpm-compute-1 |                   | :-)   | UP    | ovn-controller |
| bdc1dd13-586f-4553-90d6-14348f6be150 | OVN Controller agent         | edpm-compute-0 |                   | :-)   | UP    | ovn-controller |
| f7bb5520-27df-470b-9566-0aa7e5fef583 | OVN Controller agent         | edpm-compute-2 |                   | :-)   | UP    | ovn-controller |
+--------------------------------------+------------------------------+----------------+-------------------+-------+-------+----------------+

$ oc rsh openstackclient openstack network agent delete f7bb5520-27df-470b-9566-0aa7e5fef583</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_delete_nova_compute_service_2">Delete nova-compute service</h4>
<div class="paragraph">
<p>Delete <code>nova-compute</code> service for the removed node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc rsh openstackclient openstack compute service delete f70912f9-eaaa-4caa-906f-a38e20667af4

$ oc rsh openstackclient openstack hypervisor list
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+
| ID                                   | Hypervisor Hostname                 | Hypervisor Type | Host IP         | State |
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+
| cc05372a-27bd-4b33-985e-b0009c9e515e | edpm-compute-1.ctlplane.example.com | QEMU            | 192.168.221.101 | up    |
| 5e3f7b5d-39fd-430c-80d1-084086bdccde | edpm-compute-0.ctlplane.example.com | QEMU            | 192.168.221.100 | up    |
+--------------------------------------+-------------------------------------+-----------------+-----------------+-------+</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_patch_openstackdataplanenodeset_to_remove_node_2">Patch OpenStackDataPlaneNodeSet to remove node</h4>
<div class="paragraph">
<p>Once the cleanup is complete, patch <code>OpenStackDataPlaneNodeSet</code> CR to remove the
nodes from the <code>nodes</code> section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc patch openstackdataplanenodeset/openstack-edpm --type json --patch '[{ "op": "remove", "path": "/spec/nodes/edpm-compute-2" }]'
openstackdataplanenodeset.dataplane.openstack.org/openstack-edpm patched</code></pre>
</div>
</div>
<div class="paragraph">
<p>For baremetal provisioned node this would start de-provisioning the removed node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get bmh
NAME         STATE            CONSUMER              ONLINE   ERROR   AGE
compute-01   provisioned      openstack-edpm        true             2d21h
compute-02   provisioned      openstack-edpm        true             2d21h
compute-03   deprovisioning                         false            43h</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scaling_in_by_removing_a_nodeset_2">Scaling In by removing a NodeSet</h3>
<div class="paragraph">
<p>If a full <code>OpenStackDataPlaneNodeSet</code> has to be removed, steps mentioned
above to disable <code>nova-compute</code> services, stop the <code>ovn</code> and <code>nova-compute</code>
containers on nodes, delete network agents and delete <code>nova-compute</code> services
should be done for each compute. Finally the <code>OpenStackDataPlaneNodeSet</code> CR can
be deleted. If this <code>OpenStackDataPlaneNodeSet</code> is the only one listing the
<code>ssh-known-hosts</code> service, then this service needs to be added to one or more
of the remaining <code>OpenStackDataPlaneNodeSets</code>. To remove the ssh host keys of
the removed nodes of this <code>OpenStackDataPlaneNodeSet</code> from other nodes a new
<code>OpenStackDataPlaneDeployment</code> needs to be created that points to all the
remaining <code>OpenStackDataPlaneNodeSets</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="proc_deploying-in-disconnected-environments">Deploying OpenStack in a disconnected environment</h2>
<div class="sectionbody">
<div class="sect2 _abstract">
<h3 id="_process">Process</h3>
<div class="paragraph">
<p>Deploying in disconnected environments can be achieved largely by following the OpenShift documentation for mirroring OLM Operators: <a href="https://docs.openshift.com/container-platform/4.16/installing/disconnected_install/installing-mirroring-installation-images.html#olm-mirror-catalog_installing-mirroring-installation-images" class="bare">https://docs.openshift.com/container-platform/4.16/installing/disconnected_install/installing-mirroring-installation-images.html#olm-mirror-catalog_installing-mirroring-installation-images</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_technical_implementation">Technical Implementation</h3>
<div class="paragraph">
<p>The details provided in this section are for informational purposes only. Users should not need to interact with anything additional after completing the above mentioned OLM mirroring process.</p>
</div>
<div class="paragraph">
<p>The <code>openstack-operator</code> contains a list of related images that will ensure all required images for the deployment are mirrored following the above OpenShift process. Once images are mirrored, either an <code>ImageContentSourcePolicy</code> custom resource (CR), or a <code>ImageDigestMirrorSet</code> CR is created. This process results in a <code>MachineConfig</code> called <code>99-master-genereted-registries</code> being updated in the cluster. The <code>99-master-generated-registries</code> <code>MachineConfig</code> contains a <code>registries.conf</code> file that is applied to all of the OpenShift nodes in the cluster.</p>
</div>
<div class="paragraph">
<p>In order for dataplane nodes to integrate cleanly with this process, openstack-operator checks for the existence of an <code>ImageContentSourcePolicy</code> or an <code>ImageDigestMirrorSet</code>. If one is found, it will read the <code>registries.conf</code> file from the <code>99-master-generated-registries</code> <code>MachineConfig</code>. The openstack-operator will then set two variables in the Ansible inventory for the nodes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">edpm_podman_disconnected_ocp
edpm_podman_registries_conf</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>edpm_podman_disconnected_ocp</code> is a boolean variable that is used to conditionally render <code>registries.conf</code> on the dataplane nodes during the deployment. While <code>edpm_podman_registries_conf</code> contains the contents of the <code>registries.conf</code> that were acquired from the <code>MachineConfig</code> in the cluster. The contents of this file will be written to  <code>/etc/containers/registries.conf</code> on each of the dataplane nodes. This ensures that our dataplane nodes are configured in a consistent manner with the OpenShift nodes.</p>
</div>
<div class="paragraph">
<p>Since this configuration file is lifted directly from OpenShift, the dataplane nodes also have the same requirements as OpenShift for images - such as using image digests rather than image tags.
This can be seen in the Ansible inventory secret for each of the <code>OpenStackDataPlaneNodeSet</code> objects in the cluster. Using <code>multipathd</code> as an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">        edpm_podman_registries_conf: |
          [...]
            [[registry]]
              prefix = ""
              location = "registry.redhat.io/rhoso/openstack-multipathd-rhel9"

              [[registry.mirror]]
                location = "quay-mirror-registry.example.net:8443/olm/rhoso-openstack-multipathd-rhel9"
                pull-from-mirror = "digest-only"
          [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>pull-from-mirror</code> parameter is set to <code>digest-only</code>. This means that any attempt by podman to pull an image by a digest will result in the image being pulled from the specified mirror.</p>
</div>
<div class="paragraph">
<p>Accordingly, image references in the <code>OpenStackVersion</code> CR are provided in the digest format, for example the multipathd image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get openstackversion -o jsonpath='{.items[].status.containerImages.edpmMultipathdImage}'
"registry.redhat.io/rhoso/openstack-multipathd-rhel9@sha256:7df2e1ebe4ec6815173e49157848a63d28a64ffb0db8de6562c4633c0fbcdf3f"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since all images are in the digest format for the <code>OpenStackVersion</code> resource, there is no additional action required by users to work in a disconnected environment.</p>
</div>
</div>
</div>
</div>
<h1 id="custom-resources" class="sect0">Custom Resources</h1>
<div class="openblock partintro">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><a href="#openstackdataplanedeployment">OpenStackDataPlaneDeployment</a></p>
</li>
<li>
<p><a href="#openstackdataplanenodeset">OpenStackDataPlaneNodeSet</a></p>
</li>
<li>
<p><a href="#openstackdataplaneservice">OpenStackDataPlaneService</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sub-resources">Sub Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="#openstackdataplanedeploymentlist">OpenStackDataPlaneDeploymentList</a></p>
</li>
<li>
<p><a href="#openstackdataplanedeploymentspec">OpenStackDataPlaneDeploymentSpec</a></p>
</li>
<li>
<p><a href="#openstackdataplanedeploymentstatus">OpenStackDataPlaneDeploymentStatus</a></p>
</li>
<li>
<p><a href="#openstackdataplanenodesetlist">OpenStackDataPlaneNodeSetList</a></p>
</li>
<li>
<p><a href="#openstackdataplanenodesetspec">OpenStackDataPlaneNodeSetSpec</a></p>
</li>
<li>
<p><a href="#openstackdataplanenodesetstatus">OpenStackDataPlaneNodeSetStatus</a></p>
</li>
<li>
<p><a href="#openstackdataplaneservicelist">OpenStackDataPlaneServiceList</a></p>
</li>
<li>
<p><a href="#openstackdataplaneservicespec">OpenStackDataPlaneServiceSpec</a></p>
</li>
<li>
<p><a href="#openstackdataplaneservicestatus">OpenStackDataPlaneServiceStatus</a></p>
</li>
<li>
<p><a href="#openstackdataplaneservicecert">OpenstackDataPlaneServiceCert</a></p>
</li>
<li>
<p><a href="#ansibleeespec">AnsibleEESpec</a></p>
</li>
<li>
<p><a href="#ansibleopts">AnsibleOpts</a></p>
</li>
<li>
<p><a href="#configmapenvsource">ConfigMapEnvSource</a></p>
</li>
<li>
<p><a href="#datasource">DataSource</a></p>
</li>
<li>
<p><a href="#localobjectreference">LocalObjectReference</a></p>
</li>
<li>
<p><a href="#nodesection">NodeSection</a></p>
</li>
<li>
<p><a href="#nodetemplate">NodeTemplate</a></p>
</li>
<li>
<p><a href="#secretenvsource">SecretEnvSource</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="openstackdataplanedeployment">OpenStackDataPlaneDeployment</h3>
<div class="paragraph">
<p>OpenStackDataPlaneDeployment is the Schema for the openstackdataplanedeployments API OpenStackDataPlaneDeployment name must be a valid RFC1123 as it is used in labels</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">metadata</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metav1.ObjectMeta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spec</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#openstackdataplanedeploymentspec">OpenStackDataPlaneDeploymentSpec</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#openstackdataplanedeploymentstatus">OpenStackDataPlaneDeploymentStatus</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplanedeploymentlist">OpenStackDataPlaneDeploymentList</h3>
<div class="paragraph">
<p>OpenStackDataPlaneDeploymentList contains a list of OpenStackDataPlaneDeployment</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">metadata</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metav1.ListMeta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">items</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]<a href="#openstackdataplanedeployment">OpenStackDataPlaneDeployment</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplanedeploymentspec">OpenStackDataPlaneDeploymentSpec</h3>
<div class="paragraph">
<p>OpenStackDataPlaneDeploymentSpec defines the desired state of OpenStackDataPlaneDeployment</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nodeSets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NodeSets is the list of NodeSets deployed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">backoffLimit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BackoffLimit allows to define the maximum number of retried executions (defaults to 6).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*int32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">preserveJobs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PreserveJobs - do not delete jobs after they finished e.g. to check logs PreserveJobs default: true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleTags</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleTags for ansible execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleLimit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleLimit for ansible execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleSkipTags</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleSkipTags for ansible execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleExtraVars</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleExtraVars for ansible execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]json.RawMessage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">servicesOverride</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServicesOverride list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deploymentRequeueTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time before the deployment is requeued in seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleJobNodeSelector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleJobNodeSelector to target subset of worker nodes running the ansible jobs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplanedeploymentstatus">OpenStackDataPlaneDeploymentStatus</h3>
<div class="paragraph">
<p>OpenStackDataPlaneDeploymentStatus defines the observed state of OpenStackDataPlaneDeployment</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nodeSetConditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NodeSetConditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]condition.Conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleEEHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleEEHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">configMapHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConfigMapHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">secretHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SecretHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nodeSetHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NodeSetHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bmhRefHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BmhRefHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">containerImages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ContainerImages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">condition.Conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">observedGeneration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ObservedGeneration - the most recent generation observed for this Deployment. If the observed generation is less than the spec generation, then the controller has not processed the latest changes.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deployedVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DeployedVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deployed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deployed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplanenodeset">OpenStackDataPlaneNodeSet</h3>
<div class="paragraph">
<p>OpenStackDataPlaneNodeSet is the Schema for the openstackdataplanenodesets API OpenStackDataPlaneNodeSet name must be a valid RFC1123 as it is used in labels</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">metadata</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metav1.ObjectMeta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spec</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#openstackdataplanenodesetspec">OpenStackDataPlaneNodeSetSpec</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#openstackdataplanenodesetstatus">OpenStackDataPlaneNodeSetStatus</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplanenodesetlist">OpenStackDataPlaneNodeSetList</h3>
<div class="paragraph">
<p>OpenStackDataPlaneNodeSetList contains a list of OpenStackDataPlaneNodeSets</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">metadata</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metav1.ListMeta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">items</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]<a href="#openstackdataplanenodeset">OpenStackDataPlaneNodeSet</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplanenodesetspec">OpenStackDataPlaneNodeSetSpec</h3>
<div class="paragraph">
<p>OpenStackDataPlaneNodeSetSpec defines the desired state of OpenStackDataPlaneNodeSet</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">baremetalSetTemplate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BaremetalSetTemplate Template for BaremetalSet for the NodeSet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*baremetalv1.OpenStackBaremetalSetTemplateSpec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nodeTemplate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NodeTemplate - node attributes specific to nodes defined by this resource. These attributes can be overriden at the individual node level, else take their defaults from valus in this section.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#nodetemplate">NodeTemplate</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nodes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nodes - Map of Node Names and node specific data. Values here override defaults in the upper level section.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]<a href="#nodesection">NodeSection</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">env</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Env is a list containing the environment variables to pass to the pod Variables modifying behavior of AnsibleEE can be specified here.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]corev1.EnvVar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">networkAttachments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NetworkAttachments is a list of NetworkAttachment resource names to pass to the ansibleee resource which allows to connect the ansibleee runner to the given network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">services</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Services list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tags</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tags - Additional tags for NodeSet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">secretMaxSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SecretMaxSize - Maximum size in bytes of a Kubernetes secret. This size is currently situated around 1 MiB (nearly 1 MB).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">preProvisioned</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\n\nPreProvisioned - Set to true if the nodes have been Pre Provisioned.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tlsEnabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TLSEnabled - Whether the node set has TLS enabled.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplanenodesetstatus">OpenStackDataPlaneNodeSetStatus</h3>
<div class="paragraph">
<p>OpenStackDataPlaneNodeSetStatus defines the observed state of OpenStackDataPlaneNodeSet</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">condition.Conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deploymentStatuses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DeploymentStatuses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]condition.Conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allHostnames</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AllHostnames</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]map[infranetworkv1.NetNameStr]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allIPs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AllIPs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]map[infranetworkv1.NetNameStr]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">configMapHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConfigMapHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">secretHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SecretHashes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dnsClusterAddresses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNSClusterAddresses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">containerImages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ContainerImages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ctlplaneSearchDomain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CtlplaneSearchDomain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">configHash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConfigHash - holds the curret hash of the NodeTemplate and Node sections of the struct. This hash is used to determine when new Ansible executions are required to roll out config changes.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deployedConfigHash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DeployedConfigHash - holds the hash of the NodeTemplate and Node sections of the struct that was last deployed. This hash is used to determine when new Ansible executions are required to roll out config changes.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">inventorySecretName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">InventorySecretName Name of a secret containing the ansible inventory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">observedGeneration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ObservedGeneration - the most recent generation observed for this NodeSet. If the observed generation is less than the spec generation, then the controller has not processed the latest changes.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deployedVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DeployedVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bmhRefHash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bmhRefHash - Current hash of the BMHs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deployedBmhHash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DeployedBmhHash - Hash of BMHs deployed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplaneservice">OpenStackDataPlaneService</h3>
<div class="paragraph">
<p>OpenStackDataPlaneService defines the Schema for the openstackdataplaneservices API. OpenStackDataPlaneService name must be a valid RFC1123 as it is used in labels</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">metadata</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metav1.ObjectMeta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spec</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#openstackdataplaneservicespec">OpenStackDataPlaneServiceSpec</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#openstackdataplaneservicestatus">OpenStackDataPlaneServiceStatus</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplaneservicelist">OpenStackDataPlaneServiceList</h3>
<div class="paragraph">
<p>OpenStackDataPlaneServiceList contains a list of OpenStackDataPlaneService</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">metadata</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metav1.ListMeta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">items</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]<a href="#openstackdataplaneservice">OpenStackDataPlaneService</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplaneservicespec">OpenStackDataPlaneServiceSpec</h3>
<div class="paragraph">
<p>OpenStackDataPlaneServiceSpec defines the desired state of OpenStackDataPlaneService</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dataSources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DataSources list of DataSource objects to mount as ExtraMounts for the OpenStackAnsibleEE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]<a href="#datasource">DataSource</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tlsCerts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TLSCerts tls certs to be generated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]<a href="#openstackdataplaneservicecert">OpenstackDataPlaneServiceCert</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">playbookContents</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PlaybookContents is an inline playbook contents that ansible will run on execution.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">playbook</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Playbook is a path to the playbook that ansible will run on this execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">role</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Role is a path to the role that ansible will run on this execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">caCerts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CACerts - Secret containing the CA certificate chain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">openStackAnsibleEERunnerImage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenStackAnsibleEERunnerImage image to use as the ansibleEE runner image</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">certsFrom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CertsFrom - Service name used to obtain TLSCert and CACerts data. If both CertsFrom and either TLSCert or CACerts is set, then those fields take precedence. DEPRECATED: Will be removed in a future release. Use EDPMServiceType instead.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addCertMounts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AddCertMounts - Whether to add cert mounts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deployOnAllNodeSets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DeployOnAllNodeSets - should the service be deploy across all nodesets This will override default target of a service play, setting it to <em>all</em>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">containerImageFields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ContainerImageFields - list of container image fields names that this service deploys. The field names should match the ContainerImages struct field names from github.com/openstack-k8s-operators/openstack-operator/apis/core/v1beta1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">edpmServiceType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EDPMServiceType - service type, which typically corresponds to one of the default service names (such as nova, ovn, etc). Also typically corresponds to the ansible role name (without the "edpm_" prefix) used to manage the service. If not set, will default to the OpenStackDataPlaneService name.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplaneservicestatus">OpenStackDataPlaneServiceStatus</h3>
<div class="paragraph">
<p>OpenStackDataPlaneServiceStatus defines the observed state of OpenStackDataPlaneService</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">condition.Conditions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="openstackdataplaneservicecert">OpenstackDataPlaneServiceCert</h3>
<div class="paragraph">
<p>OpenstackDataPlaneServiceCert defines the property of a TLS cert issued for a dataplane service</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">contents</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contents of the certificate This is a list of strings for properties that are needed in the cert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">networks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Networks to include in SNI for the cert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]infranetworkv1.NetNameStr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issuer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Issuer is the label for the issuer to issue the cert Only one issuer should have this label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keyUsages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">KeyUsages to be added to the issued cert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]certmgrv1.KeyUsage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">edpmRoleServiceName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EDPMRoleServiceName is the value of the <role>_service_name variable from the edpm-ansible role where this certificate is used. For example if the certificate is for edpm_ovn from edpm-ansible, EDPMRoleServiceName must be ovn, which matches the edpm_ovn_service_name variable from the role. If not set, OpenStackDataPlaneService.Spec.EDPMServiceType is used. If OpenStackDataPlaneService.Spec.EDPMServiceType is not set, then OpenStackDataPlaneService.Name is used. DEPRECATED: Will be removed in a future release. Use EDPMServiceType instead.</role></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="ansibleeespec">AnsibleEESpec</h3>
<div class="paragraph">
<p>AnsibleEESpec is a specification of the ansible EE attributes</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extraMounts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ExtraMounts containing files which can be mounted into an Ansible Execution Pod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]storage.VolMounts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">env</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Env is a list containing the environment variables to pass to the pod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]corev1.EnvVar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extraVars</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ExtraVars for ansible execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]json.RawMessage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dnsConfig</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNSConfig for setting dnsservers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*corev1.PodDNSConfig</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">networkAttachments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NetworkAttachments is a list of NetworkAttachment resource names to pass to the ansibleee resource which allows to connect the ansibleee runner to the given network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">openStackAnsibleEERunnerImage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenStackAnsibleEERunnerImage image to use as the ansibleEE runner image</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleTags</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleTags for ansible execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleLimit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleLimit for ansible execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleSkipTags</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleSkipTags for ansible execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceAccountName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceAccountName allows to specify what ServiceAccountName do we want the ansible execution run with. Without specifying, it will run with default serviceaccount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="ansibleopts">AnsibleOpts</h3>
<div class="paragraph">
<p>AnsibleOpts defines a logical grouping of Ansible related configuration options.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleUser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleUser SSH user for Ansible connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleHost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleHost SSH host for Ansible connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleVars</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleVars for configuring ansible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]json.RawMessage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleVarsFrom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleVarsFrom is a list of sources to populate ansible variables from. Values defined by an AnsibleVars with a duplicate key take precedence.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]<a href="#datasource">DataSource</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansiblePort</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsiblePort SSH port for Ansible connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="configmapenvsource">ConfigMapEnvSource</h3>
<div class="paragraph">
<p>ConfigMapEnvSource selects a ConfigMap to populate the environment variables with.\n\nThe contents of the target ConfigMap&#8217;s Data field will represent the key-value pairs as environment variables.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify whether the ConfigMap must be defined</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="datasource">DataSource</h3>
<div class="paragraph">
<p>DataSource represents the source of a set of ConfigMaps/Secrets</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional identifier to prepend to each key in the ConfigMap. Must be a C_IDENTIFIER.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">configMapRef</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ConfigMap to select from</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*<a href="#configmapenvsource">ConfigMapEnvSource</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">secretRef</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Secret to select from</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*<a href="#secretenvsource">SecretEnvSource</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="localobjectreference">LocalObjectReference</h3>
<div class="paragraph">
<p>LocalObjectReference contains enough information to let you locate the referenced object inside the same namespace.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the referent. More info: <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names" class="bare">https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="nodesection">NodeSection</h3>
<div class="paragraph">
<p>NodeSection defines the top level attributes inherited by nodes in the CR.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">networks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Networks - Instance networks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]infranetworkv1.IPSetNetwork</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bmhLabelSelector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BmhLabelSelector allows for a sub-selection of BaremetalHosts based on arbitrary labels for a node.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map[string]string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">userData</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UserData  node specific user-data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*corev1.SecretReference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">networkData</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NetworkData  node specific network-data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*corev1.SecretReference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ansible is the group of Ansible related configuration options.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#ansibleopts">AnsibleOpts</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hostName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HostName - node name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">managementNetwork</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ManagementNetwork - Name of network to use for management (SSH/Ansible)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ctlplaneInterface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CtlplaneInterface - Interface on the provisioned nodes to use for ctlplane network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="nodetemplate">NodeTemplate</h3>
<div class="paragraph">
<p>NodeTemplate is a specification of the node attributes that override top level attributes.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extraMounts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ExtraMounts containing files which can be mounted into an Ansible Execution Pod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]storage.VolMounts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">networks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Networks - Instance networks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]infranetworkv1.IPSetNetwork</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">userData</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UserData  node specific user-data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*corev1.SecretReference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">networkData</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NetworkData  node specific network-data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*corev1.SecretReference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansibleSSHPrivateKeySecret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AnsibleSSHPrivateKeySecret Name of a private SSH key secret containing private SSH key for connecting to node. The named secret must be of the form: Secret.data.ssh-privatekey: <base64 encoded="" private="" key="" contents=""><a href="https://kubernetes.io/docs/concepts/configuration/secret/#ssh-authentication-secrets" class="bare">https://kubernetes.io/docs/concepts/configuration/secret/#ssh-authentication-secrets</a></base64></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">managementNetwork</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ManagementNetwork - Name of network to use for management (SSH/Ansible)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ansible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ansible is the group of Ansible related configuration options.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#ansibleopts">AnsibleOpts</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="secretenvsource">SecretEnvSource</h3>
<div class="paragraph">
<p>SecretEnvSource selects a Secret to populate the environment variables with.\n\nThe contents of the target Secret&#8217;s Data field will represent the key-value pairs as environment variables.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Scheme</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify whether the Secret must be defined</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#custom-resources">Back to Custom Resources</a></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2026-02-07 15:54:35 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/bash.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>