apiVersion: kuttl.dev/v1beta1
kind: TestAssert
commands:
  - script: |
      echo "Waiting for OpenStack control plane to be ready..."
      oc wait openstackcontrolplane -n $NAMESPACE --for=condition=Ready --timeout=400s -l core.openstack.org/openstackcontrolplane

  - script: |
      echo "Get fingerprints of all service certs"
      echo "PWD $PWD"
      BASE_DIR=$(pwd)
      SCRIPT_PATH="$BASE_DIR/out/operator/openstack-operator/tests/kuttl/common/osp_endpoint_finger_prints.sh"
      echo "Listing current directory contents"
      ls -l
      echo "Listing $(dirname $SCRIPT_PATH) directory contents"
      ls -l $(dirname $SCRIPT_PATH)
      oc exec -i openstackclient -n $NAMESPACE -- bash -s < $SCRIPT_PATH > /tmp/endpoint_fingerprints_after

  - script: |
      echo "Check fingerprints"
      while IFS= read -r fp; do
        if grep -qF "$fp" /tmp/endpoint_fingerprints_before; then
          echo "Cert not rotated - $fp"
          exit 1
        fi
      done < "/tmp/endpoint_fingerprints_after"
      exit 0
