---
- job:
    name: openstack-operator-tempest-multinode
    parent: podified-multinode-hci-deployment-crc-3comp
    dependencies: ["openstack-k8s-operators-content-provider"]
    vars:
      cifmw_control_plane_ceph_backend_include_vars: "{{ cifmw_basedir }}/artifacts/pre_deploy_ceph_deploy.yml"
      cifmw_operator_build_golang_ct: "docker.io/library/golang:1.20"
      cifmw_operator_build_golang_alt_ct: "quay.rdoproject.org/openstack-k8s-operators/golang:1.20"
      cifmw_make_ceph_environment:
        CEPH_TIMEOUT: 90
        CEPH_DATASIZE: "10Gi"
      pre_deploy:
        - name: Ceph deploy
          type: playbook
          source: ceph-deploy.yml
        - name: Kustomize OpenStack CR with Ceph
          type: playbook
          source: control_plane_ceph_backends.yml
      cifmw_tempest_tempestconf_profile:
          overrides:
            compute-feature-enabled.vnc_console: true
            compute-feature-enabled.stable_rescue: true
            compute_feature_enabled.hostname_fqdn_sanitization: true
            # NOTE(alee) these tests will fail with barbican in the mix
            # while cinder/nova is not configured to talk to barbican
            # re-enable this when that support is added
            compute-feature-enabled.attach_encrypted_volume: false
            compute-feature-enabled.live_migration: true
            compute-feature-enabled.block_migration_for_live_migration: true
            # NOTE(gibi): This is a WA to force the publicURL as otherwise
            # tempest gets configured with adminURL and that causes test
            # instability.
            identity.v3_endpoint_type: public
      cifmw_tempest_tests_allowed:
      # NOTE(gibi): enable only the high level scenario tests to keep the
      # job run time reasonable
        - tempest.scenario
      # Plus an extra live migration test until we have cinder volumes / ceph
      # to run the live migration scenario tests with it
        - tempest.api.compute.admin.test_live_migration.LiveAutoBlockMigrationV225Test
      cifmw_tempest_tests_skipped:
      # NOTE(gibi): there are no cinder backend enabled so test needing a
      # volumes needs to be skipped
        - tempest.scenario.test_minimum_basic.TestMinimumBasicScenario
        - test_shelve_volume_backed_instance
        - tempest.scenario.test_stamp_pattern.TestStampPattern
        - tempest.scenario.test_volume_boot_pattern.TestVolumeBootPattern
        - tempest.scenario.test_network_advanced_server_ops.TestNetworkAdvancedServerOps.test_server_connectivity_live_migration
        - tempest.scenario.test_server_volume_attachment.TestServerVolumeAttachScenarioOldVersion
        - tempest.scenario.test_server_volume_attachment.TestServerVolumeAttachmentScenario
      # We need to use a custom cpu model to allow live migrating between
      # slightly different computes coming from the node pool
      cifmw_edpm_deploy_nova_compute_extra_config: |
        [libvirt]
        cpu_mode = custom
        cpu_models = Nehalem

- project:
    name: openstack-k8s-operators/openstack-operator
    github-check:
      jobs:
        - openstack-k8s-operators-content-provider
        - openstack-operator-tempest-multinode:
            dependencies:
              - openstack-k8s-operators-content-provider
